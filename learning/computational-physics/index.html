<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Brief Surf of Computational Physics | My Blog</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="Brief Surf of Computational Physics" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="About 这是用于计算物理模拟考试的一个快速复习的东西. 不过需要注意的是, 本文会用 Lisp (或者有可能有别的吧) 作为算法, 以及代码的例子. 不过是出于个人的 XP 和熟练程度做出的考量罢了. 如果你对 CL (Common Lisp) 比较好奇的话, 可以参考文末的 Appendix 介绍. 或者倒不如说, 如果对 CL 比较陌生的话, 可以参考文末的 Appendix 的介绍. 虽然不是很想说 Python 调包真的是很爽, 也不想吹嘘 Lisp 直接写也很不错. 不过在论坛 (kernel) 上我有随着上课做同步的一个 (主要为) Python 的一个 writeUP. 所有的代码都将放在 computational-physics.lisp 中: (defpackage #:computational-physics (:use :cl :gurafu) (:nicknames :phy))" />
<meta property="og:description" content="About 这是用于计算物理模拟考试的一个快速复习的东西. 不过需要注意的是, 本文会用 Lisp (或者有可能有别的吧) 作为算法, 以及代码的例子. 不过是出于个人的 XP 和熟练程度做出的考量罢了. 如果你对 CL (Common Lisp) 比较好奇的话, 可以参考文末的 Appendix 介绍. 或者倒不如说, 如果对 CL 比较陌生的话, 可以参考文末的 Appendix 的介绍. 虽然不是很想说 Python 调包真的是很爽, 也不想吹嘘 Lisp 直接写也很不错. 不过在论坛 (kernel) 上我有随着上课做同步的一个 (主要为) Python 的一个 writeUP. 所有的代码都将放在 computational-physics.lisp 中: (defpackage #:computational-physics (:use :cl :gurafu) (:nicknames :phy))" />
<link rel="canonical" href="/learning/computational-physics/" />
<meta property="og:url" content="/learning/computational-physics/" />
<meta property="og:site_name" content="My Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-06-25T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Brief Surf of Computational Physics" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-06-25T00:00:00+00:00","datePublished":"2024-06-25T00:00:00+00:00","description":"About 这是用于计算物理模拟考试的一个快速复习的东西. 不过需要注意的是, 本文会用 Lisp (或者有可能有别的吧) 作为算法, 以及代码的例子. 不过是出于个人的 XP 和熟练程度做出的考量罢了. 如果你对 CL (Common Lisp) 比较好奇的话, 可以参考文末的 Appendix 介绍. 或者倒不如说, 如果对 CL 比较陌生的话, 可以参考文末的 Appendix 的介绍. 虽然不是很想说 Python 调包真的是很爽, 也不想吹嘘 Lisp 直接写也很不错. 不过在论坛 (kernel) 上我有随着上课做同步的一个 (主要为) Python 的一个 writeUP. 所有的代码都将放在 computational-physics.lisp 中: (defpackage #:computational-physics (:use :cl :gurafu) (:nicknames :phy))","headline":"Brief Surf of Computational Physics","mainEntityOfPage":{"@type":"WebPage","@id":"/learning/computational-physics/"},"url":"/learning/computational-physics/"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css">

  <style type="text/css">
    img {
      margin-left: auto; 
      margin-right:auto; 
      display:block;
    }
  </style><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="My Blog" /><script>
  document.addEventListener("DOMContentLoaded", function() {
      renderMathInElement(document.body, {
        // customised options
        // • auto-render specific keys, e.g.:
        delimiters: [
            {left: '$$', right: '$$', display: true},
            {left: '$', right: '$', display: false},
            {left: '\\(', right: '\\)', display: false},
            {left: '\\[', right: '\\]', display: true}
        ],
        // • rendering keys, e.g.:
        throwOnError : false
      });
  });
</script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.23/dist/katex.min.css" integrity="sha384-z91AFMXXGZasvxZz5DtKJse3pKoTPU0QcNFj/B4gDFRmq6Q2bi1StsT7SOcIzLEN" crossorigin="anonymous">

<!-- The loading of KaTeX is deferred to speed up page rendering -->
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.23/dist/katex.min.js" integrity="sha384-Af7YmksQNWRLMvro3U9F84xa0paoIu7Pu2niAIUmZoI09Q4aCsbha5dvaj1tHy6K" crossorigin="anonymous"></script>

<!-- To automatically render math in text elements, include the auto-render extension: -->
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.23/dist/contrib/auto-render.min.js" integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"
        onload="renderMathInElement(document.body);"></script>
</head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">My Blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a><a class="page-link" href="/categories/">Categories</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Brief Surf of Computational Physics</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2024-06-25T00:00:00+00:00" itemprop="datePublished">Jun 25, 2024
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <h1>About</h1>
<p>这是用于计算物理模拟考试的一个快速复习的东西.</p>
<p>不过需要注意的是, 本文会用 Lisp (或者有可能有别的吧) 作为算法,
  以及代码的例子. 不过是出于个人的 XP 和熟练程度做出的考量罢了.</p>
<p>如果你对 CL (Common Lisp) 比较好奇的话, 可以参考文末的 Appendix 介绍.
  或者倒不如说, 如果对 CL 比较陌生的话, 可以参考文末的 Appendix 的介绍.</p>
<p>虽然不是很想说 Python 调包真的是很爽, 也不想吹嘘 Lisp 直接写也很不错.
  不过在论坛 (<a href="https://ucaskernel.com/d/810-writeup/">kernel</a>) 上我有随着上课做同步的一个 (主要为) Python 的一个 writeUP.</p>
<p>所有的代码都将放在 <a href="/_img/lisp/computational-physics/computational-physics.lisp">computational-physics.lisp</a> 中:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defpackage</span><span class="w"> </span><span class="kd">#:computational-physics</span>
<span class="w">  </span><span class="p">(</span><span class="nf">:use</span><span class="w"> </span><span class="nv">:cl</span><span class="w"> </span><span class="nv">:gurafu</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">:nicknames</span><span class="w"> </span><span class="nv">:phy</span><span class="p">))</span>

<span class="p">(</span><span class="nf">in-package</span><span class="w"> </span><span class="nv">:phy</span><span class="p">)</span>
</pre></div>
<p>(不过在我写完之后感觉这些代码写得并不怎么样, 总觉得还是不够优雅)</p>
<h2>Overview</h2>
<p><img src="/_img/lisp/computational-physics/overview.svg" alt="/_img/lisp/computational-physics/overview.svg" /></p>
<h1>Numbers and Precision</h1>
<h2>数制的表示</h2>
<ul>
  <li>\(p\) 进制整型:
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">p-base-integer</span><span class="w"> </span><span class="p">(</span><span class="nf">p</span><span class="w"> </span><span class="nv">bits</span><span class="p">)</span>
<span class="w">  </span><span class="s">&quot;Trun a list of `p&#39; base bits into integer.</span>
<span class="s">Return an integer crossponding to `bits&#39;.</span>

<span class="s">  (a_n a_{n-1} ... a_1 a_0) = sum a_i p^i</span>

<span class="s">For example:</span>

<span class="s">  (p-base-integer &#39;(0 0 1 1) 2) =&gt; 3</span>
<span class="s">&quot;</span>
<span class="w">  </span><span class="p">(</span><span class="nf">flet</span><span class="w"> </span><span class="p">((</span><span class="nf">scanner</span><span class="w"> </span><span class="p">(</span><span class="nf">int</span><span class="w"> </span><span class="nv">bit</span><span class="p">)</span>
<span class="w">           </span><span class="p">(</span><span class="nf">assert</span><span class="w"> </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="nv">bit</span><span class="w"> </span><span class="nv">p</span><span class="p">))</span>
<span class="w">           </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="nv">int</span><span class="p">)</span><span class="w"> </span><span class="nv">bit</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="nb">reduce</span><span class="w"> </span><span class="o">#</span><span class="ss">&#39;scanner</span><span class="w"> </span><span class="nv">bits</span><span class="w"> </span><span class="nv">:initial-value</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span>

<span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">integer-p-base</span><span class="w"> </span><span class="p">(</span><span class="nf">p</span><span class="w"> </span><span class="nv">integer</span><span class="w"> </span><span class="nv">&amp;optional</span><span class="w"> </span><span class="nv">bits</span><span class="p">)</span>
<span class="w">  </span><span class="s">&quot;Trun `interger&#39; to a list of `p&#39; base bits.</span>
<span class="s">Return a list of `p&#39; base bits.</span>
<span class="s">&quot;</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nf">zerop</span><span class="w"> </span><span class="nv">integer</span><span class="p">)</span><span class="w"> </span><span class="nv">bits</span>
<span class="w">      </span><span class="p">(</span><span class="nf">integer-p-base</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="p">(</span><span class="nb">floor</span><span class="w"> </span><span class="nv">integer</span><span class="w"> </span><span class="nv">p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nf">mod</span><span class="w"> </span><span class="nv">integer</span><span class="w"> </span><span class="nv">p</span><span class="p">)</span><span class="w"> </span><span class="nv">bits</span><span class="p">))))</span>
</pre></div>
  </li>
  <li>\(p\) 进制小数:
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">p-base-decimal</span><span class="w"> </span><span class="p">(</span><span class="nf">p</span><span class="w"> </span><span class="nv">bits</span><span class="p">)</span>
<span class="w">  </span><span class="s">&quot;Trun a list of `p&#39; base decimal bits into a decimal number.</span>
<span class="s">Return a float number crossponding to `bits&#39; [0, 1).</span>

<span class="s">  (b_1 b_2 ... b_n) = sum b_i p^{-i}</span>

<span class="s">For example:</span>

<span class="s">  (p-base-decimal &#39;(1) 4) =&gt; 0.25</span>
<span class="s">&quot;</span>
<span class="w">  </span><span class="p">(</span><span class="nf">flet</span><span class="w"> </span><span class="p">((</span><span class="nf">scanner</span><span class="w"> </span><span class="p">(</span><span class="nf">int</span><span class="w"> </span><span class="nv">bit</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nf">float</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="nv">int</span><span class="w"> </span><span class="nv">p</span><span class="p">))</span><span class="w"> </span><span class="nv">bit</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="nf">float</span>
<span class="w">     </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="p">(</span><span class="nb">reduce</span><span class="w"> </span><span class="o">#</span><span class="ss">&#39;scanner</span><span class="w"> </span><span class="p">(</span><span class="nb">reverse</span><span class="w"> </span><span class="nv">bits</span><span class="p">)</span><span class="w"> </span><span class="nv">:initial-value</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="nv">p</span><span class="p">))))</span>

<span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">decimal-p-base</span><span class="w"> </span><span class="p">(</span><span class="nf">p</span><span class="w"> </span><span class="nv">decimal</span><span class="w"> </span><span class="nv">&amp;optional</span><span class="w"> </span><span class="nv">bits</span><span class="p">)</span>
<span class="w">  </span><span class="s">&quot;Trun a decimal to `p&#39; base bits.</span>
<span class="s">Return a p base bits list.</span>
<span class="s">&quot;</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nf">zerop</span><span class="w"> </span><span class="nv">decimal</span><span class="p">)</span><span class="w"> </span><span class="nv">bits</span>
<span class="w">      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nf">shifted</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="nv">decimal</span><span class="p">)))</span>
<span class="w">        </span><span class="p">(</span><span class="nf">decimal-p-base</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="p">(</span><span class="nf">mod</span><span class="w"> </span><span class="nv">shifted</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)</span>
<span class="w">                        </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">truncate</span><span class="w"> </span><span class="p">(</span><span class="nf">mod</span><span class="w"> </span><span class="nv">shifted</span><span class="w"> </span><span class="nv">p</span><span class="p">))</span><span class="w"> </span><span class="nv">bits</span><span class="p">)))))</span>
</pre></div>
    <p>这里有一个小小的坑, 其实浮点数在计算机中的表示是有极限的,
      并不能准确地描述任意精度的浮点数:</p>
<div class="highlight"><pre><span></span><span class="c1">;; single float</span>
<span class="p">(</span><span class="nf">type-of</span><span class="w"> </span><span class="mf">0.1</span><span class="p">)</span><span class="w">            </span><span class="c1">;; =&gt; single-float</span>
<span class="p">(</span><span class="nf">decimal-p-base</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mf">0.1</span><span class="p">)</span><span class="w">   </span><span class="c1">;; =&gt; (1 0 1 1 0 0 1 1 0 0 1 1 0 0 1 1 0 0 1 1 0 0 1 1 0 0 0)</span>

<span class="c1">;; double float</span>
<span class="p">(</span><span class="nf">type-of</span><span class="w"> </span><span class="mf">0.1d0</span><span class="p">)</span><span class="w">          </span><span class="c1">;; =&gt; double-float</span>
<span class="p">(</span><span class="nf">decimal-p-base</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mf">0.1d0</span><span class="p">)</span><span class="w"> </span><span class="c1">;; =&gt; (1 0 1 1 0 0 1 1 0 0 1 1 0 0 1 1 0 0 1 1 0 0 1 1 0 0 1 1 0 0 1 1 0 0 1 1 0 0 1 1 0 0 1 1 0 0 1 1 0 0 1 1 0 0 0)</span>
</pre></div>
  </li>
  <li>\(p\) 进制实数
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">p-base-real</span><span class="w"> </span><span class="p">(</span><span class="nf">p</span><span class="w"> </span><span class="nv">int-bits</span><span class="w"> </span><span class="nv">dec-bits</span><span class="p">)</span>
<span class="w">  </span><span class="s">&quot;Return a `p&#39; base real number for `int-bits&#39; and `dec-bits&#39;.</span>

<span class="s">  real = integer + decimal</span>
<span class="s">&quot;</span>
<span class="w">  </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nf">p-base-integer</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="nv">int-bits</span><span class="p">)</span>
<span class="w">     </span><span class="p">(</span><span class="nf">p-base-decimal</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="nv">dec-bits</span><span class="p">)))</span>
</pre></div>
  <details><summary>Reader Macro</summary>
    <p>(这部分的代码将会被省略)</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">p-real-reader</span><span class="w"> </span><span class="p">(</span><span class="nf">stream</span><span class="w"> </span><span class="nv">subchar</span><span class="w"> </span><span class="nv">arg</span><span class="p">)</span>
<span class="w">  </span><span class="s">&quot;Read a p base number like `#p2:01010.01010&#39;. &quot;</span>
<span class="w">  </span><span class="p">(</span><span class="nf">declare</span><span class="w"> </span><span class="p">(</span><span class="nf">ignore</span><span class="w"> </span><span class="nv">subchar</span><span class="w"> </span><span class="nv">arg</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="nf">flet</span><span class="w"> </span><span class="p">((</span><span class="nf">check</span><span class="w"> </span><span class="p">(</span><span class="nf">bit</span><span class="w"> </span><span class="nv">p</span><span class="p">)</span>
<span class="w">           </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="nv">bit</span><span class="w"> </span><span class="nv">p</span><span class="p">)</span>
<span class="w">               </span><span class="nv">bit</span>
<span class="w">               </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="p">(</span><span class="nb">format</span><span class="w"> </span><span class="nv">nil</span><span class="w"> </span><span class="s">&quot;~d is not ~d-base bit.&quot;</span><span class="w"> </span><span class="nv">bit</span><span class="w"> </span><span class="nv">p</span><span class="p">))))</span>
<span class="w">         </span><span class="p">(</span><span class="nf">read-bit</span><span class="w"> </span><span class="p">()</span>
<span class="w">           </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nf">char</span><span class="w"> </span><span class="p">(</span><span class="nb">read-char</span><span class="w"> </span><span class="nv">stream</span><span class="w"> </span><span class="nv">nil</span><span class="w"> </span><span class="sc">#\ </span><span class="p">)))</span>
<span class="w">             </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nf">char&lt;=</span><span class="w"> </span><span class="sc">#\0</span><span class="w"> </span><span class="nv">char</span><span class="w"> </span><span class="sc">#\9</span><span class="p">)</span>
<span class="w">                    </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nf">char-code</span><span class="w"> </span><span class="nv">char</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">char-code</span><span class="w"> </span><span class="sc">#\0</span><span class="p">)))</span>
<span class="w">                   </span><span class="p">((</span><span class="nf">char&lt;=</span><span class="w"> </span><span class="sc">#\A</span><span class="w"> </span><span class="nv">char</span><span class="w"> </span><span class="sc">#\Z</span><span class="p">)</span>
<span class="w">                    </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nf">char-code</span><span class="w"> </span><span class="nv">char</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">char-code</span><span class="w"> </span><span class="sc">#\A</span><span class="p">))))</span>
<span class="w">                   </span><span class="p">((</span><span class="nf">char&lt;=</span><span class="w"> </span><span class="sc">#\a</span><span class="w"> </span><span class="nv">char</span><span class="w"> </span><span class="sc">#\z</span><span class="p">)</span>
<span class="w">                    </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nf">char-code</span><span class="w"> </span><span class="nv">char</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">char-code</span><span class="w"> </span><span class="sc">#\a</span><span class="p">))))</span>
<span class="w">                   </span><span class="p">((</span><span class="k">or</span><span class="w"> </span><span class="p">(</span><span class="nf">char=</span><span class="w"> </span><span class="nv">char</span><span class="w"> </span><span class="o">#</span><span class="err">\</span><span class="nv">:</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">char=</span><span class="w"> </span><span class="nv">char</span><span class="w"> </span><span class="sc">#\.</span><span class="p">))</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span>
<span class="w">                   </span><span class="p">(</span><span class="nf">t</span><span class="w"> </span><span class="p">(</span><span class="nb">unread-char</span><span class="w"> </span><span class="nv">char</span><span class="w"> </span><span class="nv">stream</span><span class="p">)</span><span class="w"> </span><span class="mi">-1</span><span class="p">)))))</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nf">p</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="nv">int</span><span class="w"> </span><span class="nv">dec</span><span class="p">)</span>
<span class="w">      </span><span class="c1">;; read p</span>
<span class="w">      </span><span class="p">(</span><span class="nf">loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="nv">bit</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nf">read-bit</span><span class="p">)</span>
<span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nb">&gt;=</span><span class="w"> </span><span class="nv">bit</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">              </span><span class="k">do</span><span class="w"> </span><span class="p">(</span><span class="nf">setf</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nf">check</span><span class="w"> </span><span class="nv">bit</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="nv">p</span><span class="p">))))</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">;; read int</span>
<span class="w">      </span><span class="p">(</span><span class="nf">loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="nv">bit</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nf">read-bit</span><span class="p">)</span>
<span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nb">&gt;=</span><span class="w"> </span><span class="nv">bit</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">              </span><span class="k">do</span><span class="w"> </span><span class="p">(</span><span class="nf">push</span><span class="w"> </span><span class="p">(</span><span class="nf">check</span><span class="w"> </span><span class="nv">bit</span><span class="w"> </span><span class="nv">p</span><span class="p">)</span><span class="w"> </span><span class="nv">int</span><span class="p">))</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">;; read dec</span>
<span class="w">      </span><span class="p">(</span><span class="nf">loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="nv">bit</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nf">read-bit</span><span class="p">)</span>
<span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nb">&gt;=</span><span class="w"> </span><span class="nv">bit</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">              </span><span class="k">do</span><span class="w"> </span><span class="p">(</span><span class="nf">push</span><span class="w"> </span><span class="p">(</span><span class="nf">check</span><span class="w"> </span><span class="nv">bit</span><span class="w"> </span><span class="nv">p</span><span class="p">)</span><span class="w"> </span><span class="nv">dec</span><span class="p">))</span>
<span class="w">      </span>
<span class="w">      </span><span class="c1">;; return p-base-real</span>
<span class="w">      </span><span class="p">(</span><span class="nf">p-base-real</span><span class="w"> </span><span class="nv">p</span><span class="w"> </span><span class="p">(</span><span class="nf">nreverse</span><span class="w"> </span><span class="nv">int</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">nreverse</span><span class="w"> </span><span class="nv">dec</span><span class="p">)))))</span>

<span class="p">(</span><span class="nf">set-dispatch-macro-character</span><span class="w"> </span><span class="o">#</span><span class="err">\</span><span class="o">#</span><span class="w"> </span><span class="sc">#\p</span><span class="w"> </span><span class="o">#</span><span class="ss">&#39;p-real-reader</span><span class="p">)</span>
</pre></div>
  </details>
    <p>于是对于 Lisp, 你可以这样表示一个数: <code>#p10:23.333</code>, 或者是 <code>#p2:1010.1</code> (<code>10.5</code>).</p>
  </li>
  <li>IEEE 浮点数
    <p>将一段二进制空间划分为三个部分: <code>sign</code>, <code>exponent</code>, <code>fraction</code>,
      每部分视为一段 2 进制数, 然后按照规则将其拼接在一起:</p>
    <p>\[(-1)^{\mathrm{sign}} &times; 2^{\mathrm{exponent} - \mathrm{offset}} &times; (1 . \mathrm{fraction})\]</p>
    <p>其中 <code>offset</code> 为 <code>exponent</code> 的长度, 对于几个特殊的情况:</p>
    <table>
      <tr><th>Exponent</th><th>fraction = 0</th><th>fraction != 0</th><th>Note</th></tr>
      <tr><td>0</td><td>0</td><td>subnormal number (见 <a href="https://en.wikipedia.org/wiki/Subnormal_number">wikepedia</a>)</td><td>offset = offset - 1</td></tr>
      <tr><td>max</td><td>infinity</td><td>NaN</td><td>offset = offset</td></tr>
      <tr><td>else</td><td>normal</td><td>normal</td><td></td></tr>
    </table>
    <p>一般的做法变成:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">from-ieee-float</span><span class="w"> </span><span class="p">(</span><span class="nf">sign</span><span class="w"> </span><span class="nv">exponent</span><span class="w"> </span><span class="nv">fraction</span>
<span class="w">                        </span><span class="nv">&amp;optional</span>
<span class="w">                          </span><span class="p">(</span><span class="nf">offset</span><span class="w"> </span><span class="p">(</span><span class="nb">1-</span><span class="w"> </span><span class="p">(</span><span class="nb">expt</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">(</span><span class="nb">1-</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="nv">exponent</span><span class="p">)))))</span>
<span class="w">                          </span><span class="p">(</span><span class="nf">max-exponent</span><span class="w"> </span><span class="p">(</span><span class="nb">1-</span><span class="w"> </span><span class="p">(</span><span class="nb">expt</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="nv">exponent</span><span class="p">)))))</span>
<span class="w">  </span><span class="s">&quot;Trun a IEEE float to float. &quot;</span>
<span class="w">  </span><span class="p">(</span><span class="k">let*</span><span class="w"> </span><span class="p">((</span><span class="nf">sign</span><span class="w">     </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nf">zerop</span><span class="w"> </span><span class="nv">sign</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">-1</span><span class="p">))</span><span class="w">         </span>
<span class="w">         </span><span class="p">(</span><span class="nf">exponent</span><span class="w"> </span><span class="p">(</span><span class="nf">p-base-integer</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="nv">exponent</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="nf">fraction</span><span class="w"> </span><span class="p">(</span><span class="nf">p-base-decimal</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="nv">fraction</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="nf">type</span><span class="w"> </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">=</span><span class="w"> </span><span class="nv">exponent</span><span class="w"> </span><span class="nv">max-exponent</span><span class="p">)</span>
<span class="w">                      </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nf">zerop</span><span class="w"> </span><span class="nv">fraction</span><span class="p">)</span>
<span class="w">                          </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">&gt;</span><span class="w"> </span><span class="nv">sign</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">                              </span><span class="nv">:positive-infinity</span>
<span class="w">                              </span><span class="nv">:negative-infinity</span><span class="p">)</span>
<span class="w">                          </span><span class="nv">:nan</span><span class="p">))</span>
<span class="w">                     </span><span class="p">((</span><span class="nf">zerop</span><span class="w"> </span><span class="nv">exponent</span><span class="p">)</span>
<span class="w">                      </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nf">zerop</span><span class="w"> </span><span class="nv">fraction</span><span class="p">)</span><span class="w"> </span><span class="nv">:zero</span><span class="w"> </span><span class="nv">:subnormal</span><span class="p">))</span>
<span class="w">                     </span><span class="p">(</span><span class="nf">t</span><span class="w"> </span><span class="nv">:normal</span><span class="p">))))</span>
<span class="w">    </span><span class="p">(</span><span class="nb">values</span><span class="w"> </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nf">eq</span><span class="w"> </span><span class="nv">type</span><span class="w"> </span><span class="nv">:normal</span><span class="p">)</span>
<span class="w">                </span><span class="p">(</span><span class="nf">float</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="nv">sign</span><span class="w"> </span><span class="p">(</span><span class="nb">expt</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="nv">exponent</span><span class="w"> </span><span class="nv">offset</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">1+</span><span class="w"> </span><span class="nv">fraction</span><span class="p">)))</span>
<span class="w">                </span><span class="p">(</span><span class="nf">float</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="nv">sign</span><span class="w"> </span><span class="p">(</span><span class="nb">expt</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nv">offset</span><span class="p">))</span><span class="w"> </span><span class="nv">fraction</span><span class="p">)))</span>
<span class="w">            </span><span class="nv">type</span><span class="p">)))</span>
</pre></div>
    <ul>
      <li>IEEE 754 (32 位浮点数) <code>offset = 127</code>, <code>max-exponent = 255</code>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">ieee-float</span><span class="w"> </span><span class="p">(</span><span class="nf">bits</span><span class="p">)</span>
<span class="w">  </span><span class="s">&quot;Return float from IEEE 754 float `bits&#39;.</span>

<span class="s">  HIGH                 LOW</span>
<span class="s">  sign exponent fraction</span>
<span class="s">   0   1       9       32</span>
<span class="s">&quot;</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nf">sign</span><span class="w"> </span><span class="p">(</span><span class="nb">first</span><span class="w"> </span><span class="nv">bits</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="nf">exponent</span><span class="w"> </span><span class="p">(</span><span class="nf">subseq</span><span class="w"> </span><span class="nv">bits</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">9</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="nf">fraction</span><span class="w"> </span><span class="p">(</span><span class="nf">subseq</span><span class="w"> </span><span class="nv">bits</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="mi">32</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="nf">from-ieee-float</span><span class="w"> </span><span class="nv">sign</span><span class="w"> </span><span class="nv">exponent</span><span class="w"> </span><span class="nv">fraction</span><span class="w"> </span><span class="mi">127</span><span class="w"> </span><span class="mi">255</span><span class="p">)))</span>
</pre></div>
      </li>
      <li>IEEE 754 half (16 位浮点数) <code>offset = 15</code>, <code>max-exponent = 31</code>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">ieee-half-float</span><span class="w"> </span><span class="p">(</span><span class="nf">bits</span><span class="p">)</span>
<span class="w">  </span><span class="s">&quot;Return IEEE 754 half float from `bit&#39;</span>

<span class="s">  HIGH                 LOW</span>
<span class="s">  sign exponent fraction</span>
<span class="s">  0    1        6      16</span>
<span class="s">&quot;</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nf">sign</span><span class="w"> </span><span class="p">(</span><span class="nb">first</span><span class="w"> </span><span class="nv">bits</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="nf">exponent</span><span class="w"> </span><span class="p">(</span><span class="nf">subseq</span><span class="w"> </span><span class="nv">bits</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">6</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="nf">fraction</span><span class="w"> </span><span class="p">(</span><span class="nf">subseq</span><span class="w"> </span><span class="nv">bits</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">16</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="nf">from-ieee-float</span><span class="w"> </span><span class="nv">sign</span><span class="w"> </span><span class="nv">exponent</span><span class="w"> </span><span class="nv">fraction</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="mi">31</span><span class="p">)))</span>
</pre></div>
      </li>
      <li>Reader Macro
    <details><summary>实现略</summary>
        <p>(这部分的代码也应当被忽略)</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">ieee-float-reader</span><span class="w"> </span><span class="p">(</span><span class="nf">stream</span><span class="w"> </span><span class="nv">subchar</span><span class="w"> </span><span class="nv">arg</span><span class="p">)</span>
<span class="w">  </span><span class="s">&quot;Read a IEEE float like `#f0011110000000000&#39; for half float,</span>
<span class="s">and `#F11000000000000000000000000000000&#39; for float. &quot;</span>
<span class="w">  </span><span class="p">(</span><span class="nf">declare</span><span class="w"> </span><span class="p">(</span><span class="nf">ignore</span><span class="w"> </span><span class="nv">arg</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="nf">flet</span><span class="w"> </span><span class="p">((</span><span class="nf">read-n-bits</span><span class="w"> </span><span class="p">(</span><span class="nf">n</span><span class="p">)</span>
<span class="w">           </span><span class="p">(</span><span class="nf">loop</span><span class="w"> </span><span class="nv">repeat</span><span class="w"> </span><span class="nv">n</span>
<span class="w">                 </span><span class="nv">for</span><span class="w"> </span><span class="nv">bit</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nf">char</span><span class="w"> </span><span class="p">(</span><span class="nb">read-char</span><span class="w"> </span><span class="nv">stream</span><span class="p">)))</span>
<span class="w">                             </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nf">char=</span><span class="w"> </span><span class="nv">char</span><span class="w"> </span><span class="sc">#\0</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">                                   </span><span class="p">((</span><span class="nf">char=</span><span class="w"> </span><span class="nv">char</span><span class="w"> </span><span class="sc">#\1</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">                                   </span><span class="p">(</span><span class="nf">t</span><span class="w"> </span><span class="p">(</span><span class="nb">unread-char</span><span class="w"> </span><span class="nv">char</span><span class="w"> </span><span class="nv">stream</span><span class="p">)</span><span class="w"> </span><span class="nv">nil</span><span class="p">)))</span>
<span class="w">                 </span><span class="k">while</span><span class="w"> </span><span class="nv">bit</span>
<span class="w">                 </span><span class="nv">collect</span><span class="w"> </span><span class="nv">bit</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nf">char=</span><span class="w"> </span><span class="nv">subchar</span><span class="w"> </span><span class="sc">#\f</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">ieee-half-float</span><span class="w"> </span><span class="p">(</span><span class="nf">read-n-bits</span><span class="w"> </span><span class="mi">16</span><span class="p">)))</span>
<span class="w">          </span><span class="p">((</span><span class="nf">char=</span><span class="w"> </span><span class="nv">subchar</span><span class="w"> </span><span class="sc">#\F</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">ieee-half-float</span><span class="w"> </span><span class="p">(</span><span class="nf">read-n-bits</span><span class="w"> </span><span class="mi">32</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="nf">t</span><span class="w"> </span><span class="p">(</span><span class="nb">error</span><span class="w"> </span><span class="s">&quot;Unsupported. &quot;</span><span class="p">)))))</span>

<span class="p">(</span><span class="nf">set-dispatch-macro-character</span><span class="w"> </span><span class="o">#</span><span class="err">\</span><span class="o">#</span><span class="w"> </span><span class="sc">#\f</span><span class="w"> </span><span class="o">#</span><span class="ss">&#39;ieee-float-reader</span><span class="p">)</span>
<span class="p">(</span><span class="nf">set-dispatch-macro-character</span><span class="w"> </span><span class="o">#</span><span class="err">\</span><span class="o">#</span><span class="w"> </span><span class="sc">#\F</span><span class="w"> </span><span class="o">#</span><span class="ss">&#39;ieee-float-reader</span><span class="p">)</span>
</pre></div>
    </details>
        <p>于是就可以如下表示浮点数: <code>#F11000000000000000000000000000000</code>,
          或者 <code>#f0011110000000000</code>.</p>
      </li>
      <li>编码</li>
    </ul>
  </li>
</ul>
<h2>精度</h2>
<h3>通过泰勒展开消除小量带来的误差 Catastrophic Cancellation</h3>
<p>对于表达式 \(f(x)\) 在 \(x &rarr; 0\) 的时候, 直接计算可能会有精度上的损失,
  可以通过小量展开将函数化简来解决:</p>
<p>\[f(x) = f(x_0) + (x - x_0) \frac{\mathrm{d} f(x_0)}{\mathrm{d} x} + o\left( (x - x_0)^2 \right)\]</p>
<ul>
  <li>对于 \(N &rarr; &infin; &rArr; N = \frac{1}{x}, x &rarr; 0\), 通过变量变换进行替换计算.</li>
  <li>对于积分的表达式的计算: \(&int;_N^{N + 1} f(x) \mathrm{d} x = F(N + 1) - F(N) = &part;_N F(N) = f(N)\).</li>
</ul>
<h3>Condition Number</h3>
<p>Condition Number 描述了一个函数相对输入的变化情况.</p>
<p>\[&kappa;(f, x) = lim_{&epsilon; &rarr; 0} \mathrm{sup}_{\left\Vert &delta; x \right\Vert \leq &epsilon;} \frac{\left\Vert &delta; f(x) \right\Vert}{\left\Vert f(x) \right\Vert} / \frac{\left\Vert &delta; x \right\Vert}{\left\Vert x \right\Vert}\]</p>
<p>对于一元函数:</p>
<p>\[&kappa;(f, x) = \left| \frac{x f'(x)}{f(x)} \right|\]</p>
<p>对于多元函数:</p>
<p>\[&kappa;(f, x) = \left| \frac{\left\Vert \boldsymbol{J}(x) \right\Vert}{\left\Vert f(x) \right\Vert / \left\Vert \boldsymbol{x} \right\Vert} \right|\]</p>
<details><summary>这里可以给一个实验的角度</summary>
<ul>
  <li>测量时的误差 \(&sigma;\), 相对误差 \(\frac{&sigma;}{f}\)</li>
  <li>Condition Number \(&kappa;\) 表示了入参的误差对于函数值的影响程度</li>
  <li>在误差传递的过程中 \(&sigma;_f = \sqrt{(&part;_{x_i} f)^2 &sigma;_{x_i}^2}\) (误差传递公式)</li>
  <li>于是可以得到 \(\frac{&sigma;_f}{f} = \sqrt{(&part;_{x_i} f)^2 &sigma;_{x_i}^2 / f^2} = &kappa; \frac{&sigma;_a}{a}\)
    \(&rArr; &kappa; = \sqrt{a^2 (&part;_{x_i} f)^2 &sigma;_{x_i}^2 / f^2 &sigma;_a^2}\).</li>
</ul>
</details>
<h3>Richardson Extrapolation</h3>
<p>在计算导数的时候, 很容易陷入 \(f(x + &delta; x) - f(x)\)
  这样的因为小量误差导致的 \(f(x + &delta; x) - f(x) &rarr; 0\).</p>
<p>解决方法就是使用 Richardson Extrapolation 对函数进行展开:</p>
<p>\[\begin{matrix} A(h) = f(x + h) - f(x) + O(h) &#92; A(h) = B(h) + o(h^{k+1}) &#92; B(h) = \frac{2^k A(\frac{h}{2}) - A(h)}{2^k - 1} \end{matrix}\]</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">richardson-extrapolation</span><span class="w"> </span><span class="p">(</span><span class="nf">fn</span><span class="w"> </span><span class="nv">&amp;optional</span><span class="w"> </span><span class="p">(</span><span class="nf">k</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<span class="w">  </span><span class="s">&quot;Apply `k&#39; rank Richardson Extrapolation on function `fn&#39;. &quot;</span>
<span class="w">  </span><span class="p">(</span><span class="nf">declare</span><span class="w"> </span><span class="p">(</span><span class="nf">type</span><span class="w"> </span><span class="p">(</span><span class="nf">integer</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="nv">k</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nf">zerop</span><span class="w"> </span><span class="nv">k</span><span class="p">)</span><span class="w"> </span><span class="nv">fn</span>
<span class="w">      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nf">2expk</span><span class="w"> </span><span class="p">(</span><span class="nb">ash</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="nv">k</span><span class="p">)))</span>
<span class="w">        </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nf">h</span><span class="p">)</span>
<span class="w">          </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="nv">2expk</span><span class="w"> </span><span class="p">(</span><span class="nf">funcall</span><span class="w"> </span><span class="nv">fn</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="nv">h</span><span class="w"> </span><span class="mf">2.0d0</span><span class="p">)))</span><span class="w"> </span><span class="p">(</span><span class="nf">funcall</span><span class="w"> </span><span class="nv">fn</span><span class="w"> </span><span class="nv">h</span><span class="p">))</span>
<span class="w">             </span><span class="p">(</span><span class="nb">1-</span><span class="w"> </span><span class="nv">2expk</span><span class="p">))))))</span>
</pre></div>
<p>这里是一个例子: \(cos x = &part;_x sin x = \frac{sin (x + h) - sin x}{h}\)</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">with-present-to-file</span>
<span class="w">    </span><span class="p">(</span><span class="nf">plot</span><span class="w"> </span><span class="nv">plot</span><span class="w"> </span><span class="nv">:margin</span><span class="w"> </span><span class="mi">10</span>
<span class="w">               </span><span class="nv">:x-label</span><span class="w"> </span><span class="s">&quot;-lg(h)&quot;</span><span class="w"> </span><span class="nv">:y-label</span><span class="w"> </span><span class="s">&quot;ε&quot;</span>
<span class="w">               </span><span class="nv">:x-min</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="nv">:x-max</span><span class="w"> </span><span class="mi">15</span>
<span class="w">               </span><span class="nv">:y-min</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="nv">:y-max</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nf">out-path</span><span class="w">  </span><span class="nv">:width</span><span class="w"> </span><span class="mi">800</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">flet</span><span class="w"> </span><span class="p">((</span><span class="nf">data</span><span class="w"> </span><span class="p">(</span><span class="nf">k</span><span class="p">)</span>
<span class="w">           </span><span class="p">(</span><span class="k">let*</span><span class="w"> </span><span class="p">((</span><span class="nf">fn</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nf">h</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">sin</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">h</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">sin</span><span class="w"> </span><span class="nv">x</span><span class="p">))</span><span class="w"> </span><span class="nv">h</span><span class="p">)))</span>
<span class="w">                  </span><span class="p">(</span><span class="nf">rk</span><span class="w">  </span><span class="p">(</span><span class="nf">richardson-extrapolation</span><span class="w"> </span><span class="nv">fn</span><span class="w"> </span><span class="nv">k</span><span class="p">))</span>
<span class="w">                  </span><span class="p">(</span><span class="nb">cos</span><span class="w"> </span><span class="p">(</span><span class="nb">cos</span><span class="w"> </span><span class="nv">x</span><span class="p">)))</span>
<span class="w">             </span><span class="p">(</span><span class="nf">loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="nv">below</span><span class="w"> </span><span class="mi">15</span><span class="w"> </span><span class="nv">by</span><span class="w"> </span><span class="mf">0.1</span>
<span class="w">                   </span><span class="nv">for</span><span class="w"> </span><span class="nv">h</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">expt</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="nv">x</span><span class="p">))</span>
<span class="w">                   </span><span class="nv">collect</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="p">(</span><span class="nb">abs</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nf">funcall</span><span class="w"> </span><span class="nv">rk</span><span class="w"> </span><span class="nv">h</span><span class="p">)</span><span class="w"> </span><span class="nb">cos</span><span class="p">)))))))</span>
<span class="w">    </span><span class="p">(</span><span class="nf">add-plot-data</span><span class="w"> </span><span class="nv">plot</span><span class="w"> </span><span class="p">(</span><span class="nf">line-plot-pane</span><span class="w"> </span><span class="nv">rk1</span><span class="w"> </span><span class="nv">:color</span><span class="w"> </span><span class="nv">+大红+</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">data</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<span class="w">    </span><span class="p">(</span><span class="nf">add-plot-data</span><span class="w"> </span><span class="nv">plot</span><span class="w"> </span><span class="p">(</span><span class="nf">line-plot-pane</span><span class="w"> </span><span class="nv">rk2</span><span class="w"> </span><span class="nv">:color</span><span class="w"> </span><span class="nv">+鹅黄+</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">data</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span>
<span class="w">    </span><span class="p">(</span><span class="nf">add-plot-data</span><span class="w"> </span><span class="nv">plot</span><span class="w"> </span><span class="p">(</span><span class="nf">line-plot-pane</span><span class="w"> </span><span class="nv">rk3</span><span class="w"> </span><span class="nv">:color</span><span class="w"> </span><span class="nv">+天蓝+</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">data</span><span class="w"> </span><span class="mi">3</span><span class="p">))</span>
<span class="w">    </span><span class="p">(</span><span class="nf">add-plot-data</span><span class="w"> </span><span class="nv">plot</span><span class="w"> </span><span class="p">(</span><span class="nf">line-plot-pane</span><span class="w"> </span><span class="nv">rk4</span><span class="w"> </span><span class="nv">:color</span><span class="w"> </span><span class="nv">+豆绿+</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">data</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span>
<span class="w">    </span><span class="p">(</span><span class="nf">add-plot-legend</span><span class="w"> </span><span class="p">(</span><span class="nf">plot</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="s">&quot;k = 1&quot;</span><span class="w"> </span><span class="nv">:color</span><span class="w"> </span><span class="nv">+大红+</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="s">&quot;k = 2&quot;</span><span class="w"> </span><span class="nv">:color</span><span class="w"> </span><span class="nv">+鹅黄+</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="s">&quot;k = 3&quot;</span><span class="w"> </span><span class="nv">:color</span><span class="w"> </span><span class="nv">+天蓝+</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="s">&quot;k = 4&quot;</span><span class="w"> </span><span class="nv">:color</span><span class="w"> </span><span class="nv">+豆绿+</span><span class="p">))))</span>
<span class="nv">out-path</span>
</pre></div>
<p><img src="/_img/lisp/computational-physics/richardson-extrapolation-example.png" alt="/_img/lisp/computational-physics/richardson-extrapolation-example.png" /></p>
<h2>随机数</h2>
<h3>随机数算法</h3>
<h4>LCG</h4>
<p>\[s_{k+1} = (a &times; s_k + b)\ \mathrm{mod}\ m\]</p>
<h3>随机数测试</h3>
<h4>Uniform</h4>
<h4>Percolation</h4>
<h4>Cluster</h4>
<h1>Numeric Calculus</h1>
<h2>Taylor Series</h2>
<p>基本上可以看作是数值分析的基础了(?)</p>
<p>\[f(x + h) = &sum; \frac{h^n}{n!} f^{(n)}(x)\]</p>
<h2>Numeric Differentiation</h2>
<p>考虑对 \(\left\{ f(x + h_i) \right\}\) 展开到 \(n\) 阶可以得到的方程组, 变元为 \(f^{(i)}(x)\):</p>
<p>\[\left\{ &sum; \frac{h^i}{i!} f^{(i)}(x) = f(x + h_i) - f(x) \right\}\]</p>
<p>这里将其写作:</p>
<p>\[\boldsymbol{H} \left\{ f^{(i)}(x) \right\} = \left\{ f(x + h_i) - f(x) \right\}\]</p>
<p>通过构造逆矩阵 \(\boldsymbol{H}^{-1}\) 即可计算 \(f^{(i)}(x)\) 的表达式 (值).</p>
<details><summary>构造系数矩阵以及求解表达式</summary>
<p>这里通过 <a href="https://github.com/Lisp-Stat/lla">LLA</a> 来进行矩阵的求解之类的问题, 不过之后估计可以自己写一个替换.</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">make-hs-matrix</span><span class="w"> </span><span class="p">(</span><span class="nf">hs</span><span class="p">)</span>
<span class="w">  </span><span class="s">&quot;Make H matrix for hs.</span>
<span class="s">Return a n*n array (matrix).</span>

<span class="s">  H { f^{(i)}(x) } = { f(x + h_i) - f(x) }</span>
<span class="s">&quot;</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nf">n</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="nv">hs</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="nf">flet</span><span class="w"> </span><span class="p">((</span><span class="nf">hw</span><span class="w"> </span><span class="p">(</span><span class="nf">h</span><span class="p">)</span>
<span class="w">             </span><span class="p">(</span><span class="nf">loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="nv">below</span><span class="w"> </span><span class="nv">n</span>
<span class="w">                   </span><span class="nv">for</span><span class="w"> </span><span class="nv">hi</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="nv">h</span><span class="w"> </span><span class="nv">then</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="nv">hi</span><span class="w"> </span><span class="nv">h</span><span class="p">)</span>
<span class="w">                   </span><span class="nv">for</span><span class="w"> </span><span class="nv">i!</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nv">then</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="nv">i!</span><span class="w"> </span><span class="nv">i</span><span class="p">)</span>
<span class="w">                   </span><span class="nv">collect</span><span class="w"> </span><span class="p">(</span><span class="nf">float</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="nv">hi</span><span class="w"> </span><span class="nv">i!</span><span class="p">)))))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">make-array</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="nv">n</span><span class="w"> </span><span class="nv">n</span><span class="p">)</span><span class="w"> </span><span class="nv">:initial-contents</span><span class="w"> </span><span class="p">(</span><span class="nf">mapcar</span><span class="w"> </span><span class="o">#</span><span class="ss">&#39;hw</span><span class="w"> </span><span class="nv">hs</span><span class="p">)))))</span>

<span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">make-fs-matrix</span><span class="w"> </span><span class="p">(</span><span class="nf">n</span><span class="p">)</span>
<span class="w">  </span><span class="s">&quot;Make a F matrix for `n&#39; f(x + h_i).</span>
<span class="s">Return a (n+1)*n matrix.</span>

<span class="s">  F { f(x), f(x + h_i) } = { f(x + h_i) - f(x) }</span>
<span class="s">&quot;</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nf">f-mat</span><span class="w"> </span><span class="p">(</span><span class="nb">make-array</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="nv">n</span><span class="w"> </span><span class="p">(</span><span class="nb">1+</span><span class="w"> </span><span class="nv">n</span><span class="p">))</span><span class="w"> </span><span class="nv">:initial-element</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="nf">loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="nv">j</span><span class="w"> </span><span class="nv">below</span><span class="w"> </span><span class="nv">n</span><span class="w"> </span><span class="k">do</span>
<span class="w">      </span><span class="p">(</span><span class="nf">setf</span><span class="w"> </span><span class="p">(</span><span class="nf">aref</span><span class="w"> </span><span class="nv">f-mat</span><span class="w"> </span><span class="nv">j</span><span class="w"> </span><span class="p">(</span><span class="nb">1+</span><span class="w"> </span><span class="nv">j</span><span class="p">))</span><span class="w"> </span><span class="mi">1</span><span class="w">     </span><span class="c1">; f_{i+1,j} = 1</span>
<span class="w">            </span><span class="p">(</span><span class="nf">aref</span><span class="w"> </span><span class="nv">f-mat</span><span class="w"> </span><span class="nv">j</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w">      </span><span class="mi">-1</span><span class="p">))</span><span class="w">  </span><span class="c1">; f_{0,j}   = -1</span>
<span class="w">    </span><span class="nv">f-mat</span><span class="p">))</span>

<span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">make-finite-differentor-matrix</span><span class="w"> </span><span class="p">(</span><span class="nf">hs</span><span class="p">)</span>
<span class="w">  </span><span class="s">&quot;Make a matrix for finite differentor calculation.</span>

<span class="s">  M = H^{-1} F; M { f(x), f(x + h_i) } = { f^{(i)}(x) }</span>
<span class="s">&quot;</span>
<span class="w">  </span><span class="p">(</span><span class="k">let*</span><span class="w"> </span><span class="p">((</span><span class="nf">n</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="nv">hs</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="nf">mat-h</span><span class="w"> </span><span class="p">(</span><span class="nf">make-hs-matrix</span><span class="w"> </span><span class="nv">hs</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="nf">mat-f</span><span class="w"> </span><span class="p">(</span><span class="nf">make-fs-matrix</span><span class="w"> </span><span class="nv">n</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="nf">lla:mm</span><span class="w"> </span><span class="p">(</span><span class="nf">lla:invert</span><span class="w"> </span><span class="nv">mat-h</span><span class="p">)</span><span class="w"> </span><span class="nv">mat-f</span><span class="p">)))</span>
</pre></div>
<p>可以来计算一下几个不同的微分算子的 \(\boldsymbol{M}\):</p>
<ul>
  <li>first forward
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">make-finite-differentor-matrix</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
    <pre class="example">
#2A((-1.0d0 1.0d0))
    </pre>
  </li>
  <li>first backward
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">make-finite-differentor-matrix</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="mi">-1</span><span class="p">))</span>
</pre></div>
    <pre class="example">
#2A((1.0d0 -1.0d0))
    </pre>
  </li>
  <li>first centeral
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">make-finite-differentor-matrix</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="mi">-1</span><span class="p">))</span>
</pre></div>
    <pre class="example">
#2A((0.0d0 0.5d0 -0.5d0) (-1.0d0 0.5d0 0.5d0))
    </pre>
  </li>
  <li>\(f(x + \left\{ h, 0, 2 h \right\})\)
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">make-finite-differentor-matrix</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span>
</pre></div>
    <pre class="example">
#2A((-1.5d0 2.0d0 -0.5d0) (0.5d0 -1.0d0 0.5d0))
    </pre>
    <p>Note: 理论解为 \(2 f(x + h) - \frac{3}{2} f(x) - \frac{1}{2} f(x + h)\)</p>
  </li>
  <li>\(f(x + \left\{ -2h, -h, h, 2h \right\})\)
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">make-finite-differentor-matrix</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="mi">-2</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span>
</pre></div>
    <pre class="example">
#2A((-2.9802322387695313d-8 0.08333337306976318d0 -0.6666666865348816d0
     0.6666666865348816d0 -0.0833333432674408d0)
    (-1.2499999403953552d0 -0.041666656732559204d0 0.6666666269302368d0
     0.6666666269302368d0 -0.041666656732559204d0)
    (0.0d0 -0.1666666716337204d0 0.3333333432674408d0 -0.3333333432674408d0
     0.1666666716337204d0)
    (1.4999998658895493d0 0.24999994039535522d0 -0.9999998807907104d0
     -0.9999998807907104d0 0.24999995529651642d0))
    </pre>
    <p>Note: 理论值为 \(\frac{1}{12} f(x - 2h) - \frac{2}{3} f(x - h) + \frac{2}{3} f(x + h) - \frac{1}{12} f(x + 2h)\),
      (<code>1/12 = 0.0833</code>, <code>2/3 = 0.6666</code>).</p>
    <p>不过这里也看出因为求逆矩阵过程中累计了误差, 导致后面计算的精度就会掉下去了.
      不过暂时没有很好的解决方法, 先采用鸵鸟战术.</p>
  </li>
</ul>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">make-finite-differentor</span><span class="w"> </span><span class="p">(</span><span class="nf">hs</span><span class="w"> </span><span class="nv">&amp;optional</span><span class="w"> </span><span class="p">(</span><span class="nf">dx</span><span class="w"> </span><span class="mi">1e-3</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">d</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<span class="w">  </span><span class="s">&quot;Make a finite differentor with `hs&#39;. &quot;</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nf">rank</span><span class="w"> </span><span class="p">(</span><span class="nb">1-</span><span class="w"> </span><span class="nv">d</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nf">fn</span><span class="w"> </span><span class="nv">&amp;optional</span><span class="w"> </span><span class="p">(</span><span class="nf">dx</span><span class="w"> </span><span class="nv">dx</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="k">let*</span><span class="w"> </span><span class="p">((</span><span class="nf">hs</span><span class="w"> </span><span class="p">(</span><span class="nf">mapcar</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nf">h</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="nv">h</span><span class="w"> </span><span class="nv">dx</span><span class="p">))</span><span class="w"> </span><span class="nv">hs</span><span class="p">))</span>
<span class="w">             </span><span class="p">(</span><span class="nf">mat</span><span class="w"> </span><span class="p">(</span><span class="nf">make-finite-differentor-matrix</span><span class="w"> </span><span class="nv">hs</span><span class="p">))</span>
<span class="w">             </span><span class="p">(</span><span class="nf">hs*</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nv">hs</span><span class="p">)))</span>
<span class="w">        </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nf">x</span><span class="p">)</span>
<span class="w">          </span><span class="p">(</span><span class="nf">flet</span><span class="w"> </span><span class="p">((</span><span class="nf">f</span><span class="w"> </span><span class="p">(</span><span class="nf">h</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">funcall</span><span class="w"> </span><span class="nv">fn</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">h</span><span class="p">))))</span>
<span class="w">            </span><span class="p">(</span><span class="nf">aref</span><span class="w"> </span><span class="p">(</span><span class="nf">lla:mm</span><span class="w"> </span><span class="nv">mat</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="ss">&#39;vector</span><span class="w"> </span><span class="o">#</span><span class="ss">&#39;f</span><span class="w"> </span><span class="nv">hs*</span><span class="p">))</span><span class="w"> </span><span class="nv">rank</span><span class="p">)))))))</span>

<span class="p">(</span><span class="k">defmacro</span><span class="w"> </span><span class="nv">finite-diff</span><span class="w"> </span><span class="p">((</span><span class="nf">&amp;rest</span><span class="w"> </span><span class="nv">hs</span><span class="p">)</span><span class="w"> </span><span class="nv">&amp;key</span><span class="w"> </span><span class="p">(</span><span class="nf">dx</span><span class="w"> </span><span class="mi">1e-3</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">d</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<span class="w">  </span><span class="s">&quot;Wrapper for `make-finite-differentor&#39;. &quot;</span>
<span class="w">  </span><span class="o">`</span><span class="p">(</span><span class="nf">make-finite-differentor</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="o">,@</span><span class="nv">hs</span><span class="p">)</span><span class="w"> </span><span class="o">,</span><span class="nv">dx</span><span class="w"> </span><span class="o">,</span><span class="nv">d</span><span class="p">))</span>
</pre></div>
<p>注: 这里主要因为最近在看 <a href="https://mitpress.mit.edu/9780262045490/software-design-for-flexibility/">SDF</a> 对 Scheme 类型的直接定义 Lambda 的方式比较欣赏.
  不过代价就是在 Common Lisp 里面调用需要用 <code>funcall</code> 而不能直接用结果.
  可能会有更加好用的方式, 暂时不清楚.</p>
</details>
<p>于是对于不同的微分算子, 都可以通过这样的方式来进行离散化:</p>
<p>这里用一些比较简单的例子来对结果进行简单的验证:</p>
<ul>
  <li>first forward: 通过 \(f(x), f(x + h)\) 作为采样点来计算导数
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defparameter</span><span class="w"> </span><span class="nv">first-forward</span><span class="w"> </span><span class="p">(</span><span class="nf">finite-diff</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="w">  </span><span class="s">&quot;First forward different.</span>

<span class="s">  f&#39;(x) = (f(x + h) - f(x)) / h&quot;</span><span class="p">)</span>
</pre></div>
  </li>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defparameter</span><span class="w"> </span><span class="nv">first-backward</span><span class="w"> </span><span class="p">(</span><span class="nf">finite-diff</span><span class="w"> </span><span class="p">(</span><span class="mi">-1</span><span class="p">))</span>
<span class="w">  </span><span class="s">&quot;First backward different.</span>

<span class="s">  f&#39;(x) = (f(x) - f(x - h)) / h&quot;</span><span class="p">)</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defparameter</span><span class="w"> </span><span class="nv">first-central</span><span class="w"> </span><span class="p">(</span><span class="nf">finite-diff</span><span class="w"> </span><span class="p">(</span><span class="mi">-1</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<span class="w">  </span><span class="s">&quot;First central different.</span>

<span class="s">  f&#39;(x) = (f(x + h) - f(x - h)) / (2 * h)&quot;</span><span class="p">)</span>
</pre></div>
</ul>
<p>这里会同样遇到前文的精度的问题, 比如构造一个误差的记录函数:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">2-fn-rms-error</span><span class="w"> </span><span class="p">(</span><span class="nf">f1</span><span class="w"> </span><span class="nv">f2</span><span class="w"> </span><span class="nv">xmin</span><span class="w"> </span><span class="nv">xmax</span><span class="w"> </span><span class="nv">&amp;optional</span><span class="w"> </span><span class="p">(</span><span class="nf">dx</span><span class="w"> </span><span class="mf">0.1</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="nf">flet</span><span class="w"> </span><span class="p">((</span><span class="nf">square</span><span class="w"> </span><span class="p">(</span><span class="nf">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">x</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="nf">loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="nv">xmin</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">xmax</span><span class="w"> </span><span class="nv">by</span><span class="w"> </span><span class="nv">dx</span>
<span class="w">          </span><span class="nv">collect</span><span class="w"> </span><span class="p">(</span><span class="nf">square</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nf">funcall</span><span class="w"> </span><span class="nv">f1</span><span class="w"> </span><span class="nv">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">funcall</span><span class="w"> </span><span class="nv">f2</span><span class="w"> </span><span class="nv">x</span><span class="p">)))</span><span class="w"> </span><span class="nv">into</span><span class="w"> </span><span class="nv">sum</span>
<span class="w">          </span><span class="nv">finally</span><span class="w"> </span><span class="p">(</span><span class="nf">return</span><span class="w"> </span><span class="p">(</span><span class="nb">sqrt</span><span class="w"> </span><span class="p">(</span><span class="nb">reduce</span><span class="w"> </span><span class="o">#</span><span class="ss">&#39;+</span><span class="w"> </span><span class="nv">sum</span><span class="p">))))))</span>
</pre></div>
<table>
  <tr><td>dx</td><td>rms-error</td></tr>
  <tr><td>1/10</td><td>0.19810856549617295d0</td></tr>
  <tr><td>1/100</td><td>0.01981925960583512d0</td></tr>
  <tr><td>1/1000</td><td>0.0019056572355073285d0</td></tr>
  <tr><td>1/10000</td><td>0.0030402329579347367d0</td></tr>
  <tr><td>1/100000</td><td>0.012121302612617568d0</td></tr>
  <tr><td>1/1000000</td><td>0.18903780629484798d0</td></tr>
</table>
<p>就会发现一开始随着 <code>dx</code> 的减小, 精度会提升, 但是随着 <code>dx</code> 的进一步减小,
  精度会因为计算误差而下降, 解决方法有两种:</p>
<ol>
  <li>通过 Richardson Extrapolation 进行展开
    <p>\[A = A(h) + K h^k + O(h^{k+1})\]
      \[A = B(h) + O(h^{k+1})\]
      \[B(h) = \frac{2^k A(\frac{h}{2}) - A(h)}{2^k - 1}\]</p>
   <details><summary>略</summary>
    <ul>
      <li><code>make-finite-differentor</code> 的修改:
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">calculate-differential</span><span class="w"> </span><span class="p">(</span><span class="nf">fn</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">hs</span><span class="p">)</span>
<span class="w">  </span><span class="s">&quot;Calculate { f^{(i)}(x + hs_i) } with function `fn&#39; at `x&#39;. &quot;</span>
<span class="w">  </span><span class="p">(</span><span class="k">let*</span><span class="w"> </span><span class="p">((</span><span class="nf">mat</span><span class="w"> </span><span class="p">(</span><span class="nf">make-finite-differentor-matrix</span><span class="w"> </span><span class="nv">hs</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="nf">hs*</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nv">hs</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="nf">lla:mm</span><span class="w"> </span><span class="nv">mat</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="ss">&#39;vector</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nf">h</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">funcall</span><span class="w"> </span><span class="nv">fn</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">h</span><span class="p">)))</span><span class="w"> </span><span class="nv">hs*</span><span class="p">))))</span>

<span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">make-finite-differentor*</span><span class="w"> </span><span class="p">(</span><span class="nf">hs</span><span class="w"> </span><span class="nv">&amp;optional</span><span class="w"> </span><span class="p">(</span><span class="nf">dx</span><span class="w"> </span><span class="mi">1e-3</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">richard-k</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">d</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<span class="w">  </span><span class="s">&quot;Make a finite differentor with `hs&#39; using Richard Extrapolation. &quot;</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nf">rank</span><span class="w"> </span><span class="p">(</span><span class="nb">1-</span><span class="w"> </span><span class="nv">d</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nf">fn</span><span class="w"> </span><span class="nv">&amp;optional</span><span class="w"> </span><span class="p">(</span><span class="nf">dx</span><span class="w"> </span><span class="nv">dx</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nf">x</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">let*</span><span class="w"> </span><span class="p">((</span><span class="nf">df</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nf">h</span><span class="p">)</span>
<span class="w">                     </span><span class="p">(</span><span class="nf">aref</span><span class="w"> </span><span class="p">(</span><span class="nf">calculate-differential</span>
<span class="w">                            </span><span class="nv">fn</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="p">(</span><span class="nf">mapcar</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nf">hi</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="nv">h</span><span class="w"> </span><span class="nv">hi</span><span class="p">))</span><span class="w"> </span><span class="nv">hs</span><span class="p">))</span>
<span class="w">                           </span><span class="nv">rank</span><span class="p">)))</span>
<span class="w">               </span><span class="p">(</span><span class="nf">rk</span><span class="w"> </span><span class="p">(</span><span class="nf">richardson-extrapolation</span><span class="w"> </span><span class="nv">df</span><span class="w"> </span><span class="nv">richard-k</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="nf">funcall</span><span class="w"> </span><span class="nv">rk</span><span class="w"> </span><span class="nv">dx</span><span class="p">))))))</span>
</pre></div>
      </li>
      <li>一个简单的测试:
     <details><summary>绘图代码折叠了</summary>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">with-present-to-file</span>
<span class="w">    </span><span class="p">(</span><span class="nf">plot</span><span class="w"> </span><span class="nv">plot</span><span class="w"> </span><span class="nv">:margin</span><span class="w"> </span><span class="mi">10</span>
<span class="w">               </span><span class="nv">:x-label</span><span class="w"> </span><span class="s">&quot;-lg(dx)&quot;</span><span class="w"> </span><span class="nv">:y-label</span><span class="w"> </span><span class="s">&quot;ε&quot;</span>
<span class="w">               </span><span class="nv">:x-min</span><span class="w"> </span><span class="mi">1</span><span class="w">   </span><span class="nv">:x-max</span><span class="w"> </span><span class="mi">10</span>
<span class="w">               </span><span class="nv">:y-min</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="nv">:y-max</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nf">out-path</span><span class="w">  </span><span class="nv">:width</span><span class="w"> </span><span class="mi">800</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">loop</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">hs</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="nv">for</span><span class="w"> </span><span class="nv">n</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="nv">by</span><span class="w"> </span><span class="mf">0.1</span>
<span class="w">        </span><span class="nv">for</span><span class="w"> </span><span class="nv">dx</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">expt</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="nv">n</span><span class="p">))</span>
<span class="w">        </span><span class="nv">collect</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nf">d-rk0</span><span class="w"> </span><span class="p">(</span><span class="nf">make-finite-differentor</span><span class="w">  </span><span class="nv">hs</span><span class="w"> </span><span class="nv">dx</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="nf">d-rk1</span><span class="w"> </span><span class="p">(</span><span class="nf">make-finite-differentor*</span><span class="w"> </span><span class="nv">hs</span><span class="w"> </span><span class="nv">dx</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="nf">d-rk2</span><span class="w"> </span><span class="p">(</span><span class="nf">make-finite-differentor*</span><span class="w"> </span><span class="nv">hs</span><span class="w"> </span><span class="nv">dx</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span>
<span class="w">              </span><span class="p">(</span><span class="nf">d-rk3</span><span class="w"> </span><span class="p">(</span><span class="nf">make-finite-differentor*</span><span class="w"> </span><span class="nv">hs</span><span class="w"> </span><span class="nv">dx</span><span class="w"> </span><span class="mi">3</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="nf">mapcar</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nf">d</span><span class="p">)</span>
<span class="w">                    </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="nv">n</span><span class="w"> </span><span class="p">(</span><span class="nf">2-fn-rms-error</span><span class="w"> </span><span class="p">(</span><span class="nf">funcall</span><span class="w"> </span><span class="nv">d</span><span class="w"> </span><span class="o">#</span><span class="ss">&#39;sin</span><span class="p">)</span><span class="w"> </span><span class="o">#</span><span class="ss">&#39;cos</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nv">pi</span><span class="p">)))</span>
<span class="w">                  </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="nv">d-rk0</span><span class="w"> </span><span class="nv">d-rk1</span><span class="w"> </span><span class="nv">d-rk2</span><span class="w"> </span><span class="nv">d-rk3</span><span class="p">)))</span>
<span class="w">          </span><span class="nv">into</span><span class="w"> </span><span class="nv">data-trans</span>
<span class="w">        </span><span class="nv">finally</span>
<span class="w">           </span><span class="p">(</span><span class="nf">destructuring-bind</span><span class="w"> </span><span class="p">(</span><span class="nf">rk0</span><span class="w"> </span><span class="nv">rk1</span><span class="w"> </span><span class="nv">rk2</span><span class="w"> </span><span class="nv">rk3</span><span class="p">)</span>
<span class="w">               </span><span class="p">(</span><span class="nf">print</span><span class="w"> </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="o">#</span><span class="ss">&#39;mapcar</span><span class="w"> </span><span class="o">#</span><span class="ss">&#39;list</span><span class="w"> </span><span class="nv">data-trans</span><span class="p">))</span>
<span class="w">             </span><span class="p">(</span><span class="nf">add-plot-data</span><span class="w"> </span><span class="nv">plot</span><span class="w"> </span><span class="p">(</span><span class="nf">line-plot-pane</span><span class="w"> </span><span class="nv">rk0</span><span class="w"> </span><span class="nv">:color</span><span class="w"> </span><span class="nv">+大红+</span><span class="p">)</span><span class="w"> </span><span class="nv">rk0</span><span class="p">)</span>
<span class="w">             </span><span class="p">(</span><span class="nf">add-plot-data</span><span class="w"> </span><span class="nv">plot</span><span class="w"> </span><span class="p">(</span><span class="nf">line-plot-pane</span><span class="w"> </span><span class="nv">rk1</span><span class="w"> </span><span class="nv">:color</span><span class="w"> </span><span class="nv">+鹅黄+</span><span class="p">)</span><span class="w"> </span><span class="nv">rk1</span><span class="p">)</span>
<span class="w">             </span><span class="p">(</span><span class="nf">add-plot-data</span><span class="w"> </span><span class="nv">plot</span><span class="w"> </span><span class="p">(</span><span class="nf">line-plot-pane</span><span class="w"> </span><span class="nv">rk2</span><span class="w"> </span><span class="nv">:color</span><span class="w"> </span><span class="nv">+天蓝+</span><span class="p">)</span><span class="w"> </span><span class="nv">rk2</span><span class="p">)</span>
<span class="w">             </span><span class="p">(</span><span class="nf">add-plot-data</span><span class="w"> </span><span class="nv">plot</span><span class="w"> </span><span class="p">(</span><span class="nf">line-plot-pane</span><span class="w"> </span><span class="nv">rk3</span><span class="w"> </span><span class="nv">:color</span><span class="w"> </span><span class="nv">+豆绿+</span><span class="p">)</span><span class="w"> </span><span class="nv">rk3</span><span class="p">)</span>
<span class="w">             </span><span class="p">(</span><span class="nf">add-plot-legend</span><span class="w"> </span><span class="p">(</span><span class="nf">plot</span><span class="p">)</span>
<span class="w">               </span><span class="p">(</span><span class="s">&quot;k = 0&quot;</span><span class="w"> </span><span class="nv">:color</span><span class="w"> </span><span class="nv">+大红+</span><span class="p">)</span>
<span class="w">               </span><span class="p">(</span><span class="s">&quot;k = 1&quot;</span><span class="w"> </span><span class="nv">:color</span><span class="w"> </span><span class="nv">+鹅黄+</span><span class="p">)</span>
<span class="w">               </span><span class="p">(</span><span class="s">&quot;k = 2&quot;</span><span class="w"> </span><span class="nv">:color</span><span class="w"> </span><span class="nv">+天蓝+</span><span class="p">)</span>
<span class="w">               </span><span class="p">(</span><span class="s">&quot;k = 3&quot;</span><span class="w"> </span><span class="nv">:color</span><span class="w"> </span><span class="nv">+豆绿+</span><span class="p">)))))</span>
<span class="nv">out-path</span>
</pre></div>
        <p>
        </p>
        <p><img src="/_img/lisp/computational-physics/richardson-extrapolation-on-df-example.png" alt="/_img/lisp/computational-physics/richardson-extrapolation-on-df-example.png" /></p>
        <p>又是看图说话的时候了&#8230; 这让我有些惊讶, 实际上一开始以为 <code>dx</code> 应该是越小越好,
          毕竟切线是割线的极限嘛 (诶, 学数学学的), 实际上是在 0.001 附近倒是最好的;
          并且还认为 Richard Extrapolation 的效果一定会比默认的要好, 结果发现其实不然
          (我这里把图的 Y 轴拉得很大, 结果会发现, 都是出现非常扯淡的结果,
          但是朴素的算法竟然意外的能打, <del>虽然都差得很多就是了</del>. )</p>
      </li>
      <li>另一个测试:
     <details><summary>绘图代码还是折叠了</summary>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">with-present-to-file</span>
<span class="w">    </span><span class="p">(</span><span class="nf">plot</span><span class="w"> </span><span class="nv">plot</span><span class="w"> </span><span class="nv">:margin</span><span class="w"> </span><span class="mi">10</span>
<span class="w">               </span><span class="nv">:x-label</span><span class="w"> </span><span class="s">&quot;-lg(dx)&quot;</span><span class="w"> </span><span class="nv">:y-label</span><span class="w"> </span><span class="s">&quot;ε&quot;</span>
<span class="w">               </span><span class="nv">:x-min</span><span class="w"> </span><span class="mi">1</span><span class="w">   </span><span class="nv">:x-max</span><span class="w"> </span><span class="mi">6</span>
<span class="w">               </span><span class="nv">:y-min</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="nv">:y-max</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nf">out-path</span><span class="w">  </span><span class="nv">:width</span><span class="w"> </span><span class="mi">800</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">macrolet</span><span class="w"> </span><span class="p">((</span><span class="nf">:&gt;</span><span class="w"> </span><span class="p">(</span><span class="nf">hs</span><span class="w"> </span><span class="nv">rk0</span><span class="w"> </span><span class="nv">rk1</span><span class="w"> </span><span class="nv">rk0-color</span><span class="w"> </span><span class="nv">rk1-color</span><span class="p">)</span>
<span class="w">               </span><span class="o">`</span><span class="p">(</span><span class="nf">loop</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">hs</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="ss">&#39;,hs</span>
<span class="w">                      </span><span class="nv">for</span><span class="w"> </span><span class="nv">n</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="nv">by</span><span class="w"> </span><span class="mf">0.1</span>
<span class="w">                      </span><span class="nv">for</span><span class="w"> </span><span class="nv">dx</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">expt</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="nv">n</span><span class="p">))</span>
<span class="w">                      </span><span class="nv">collect</span>
<span class="w">                      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nf">d-rk0</span><span class="w"> </span><span class="p">(</span><span class="nf">make-finite-differentor</span><span class="w">  </span><span class="nv">hs</span><span class="w"> </span><span class="nv">dx</span><span class="p">))</span>
<span class="w">                            </span><span class="p">(</span><span class="nf">d-rk1</span><span class="w"> </span><span class="p">(</span><span class="nf">make-finite-differentor*</span><span class="w"> </span><span class="nv">hs</span><span class="w"> </span><span class="nv">dx</span><span class="w"> </span><span class="mi">1</span><span class="p">)))</span>
<span class="w">                        </span><span class="p">(</span><span class="nf">mapcar</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nf">d</span><span class="p">)</span>
<span class="w">                                  </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="nv">n</span><span class="w"> </span><span class="p">(</span><span class="nf">2-fn-rms-error</span><span class="w"> </span><span class="p">(</span><span class="nf">funcall</span><span class="w"> </span><span class="nv">d</span><span class="w"> </span><span class="o">#</span><span class="ss">&#39;sin</span><span class="p">)</span>
<span class="w">                                                          </span><span class="o">#</span><span class="ss">&#39;cos</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nv">pi</span><span class="p">)))</span>
<span class="w">                                </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="nv">d-rk0</span><span class="w"> </span><span class="nv">d-rk1</span><span class="p">)))</span>
<span class="w">                        </span><span class="nv">into</span><span class="w"> </span><span class="nv">data-trans</span>
<span class="w">                      </span><span class="nv">finally</span>
<span class="w">                         </span><span class="p">(</span><span class="nf">destructuring-bind</span><span class="w"> </span><span class="p">(</span><span class="nf">rk0</span><span class="w"> </span><span class="nv">rk1</span><span class="p">)</span>
<span class="w">                             </span><span class="p">(</span><span class="nf">print</span><span class="w"> </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="o">#</span><span class="ss">&#39;mapcar</span><span class="w"> </span><span class="o">#</span><span class="ss">&#39;list</span><span class="w"> </span><span class="nv">data-trans</span><span class="p">))</span>
<span class="w">                           </span><span class="p">(</span><span class="nf">add-plot-data</span><span class="w"> </span><span class="nv">plot</span>
<span class="w">                             </span><span class="p">(</span><span class="nf">line-plot-pane</span><span class="w"> </span><span class="o">,</span><span class="nv">rk0</span><span class="w"> </span><span class="nv">:color</span><span class="w"> </span><span class="o">,</span><span class="nv">rk0-color</span><span class="p">)</span><span class="w"> </span><span class="nv">rk0</span><span class="p">)</span>
<span class="w">                           </span><span class="p">(</span><span class="nf">add-plot-data</span><span class="w"> </span><span class="nv">plot</span>
<span class="w">                             </span><span class="p">(</span><span class="nf">line-plot-pane</span><span class="w"> </span><span class="o">,</span><span class="nv">rk1</span><span class="w"> </span><span class="nv">:color</span><span class="w"> </span><span class="o">,</span><span class="nv">rk1-color</span><span class="p">)</span><span class="w"> </span><span class="nv">rk1</span><span class="p">)))))</span>
<span class="w">    </span><span class="p">(</span><span class="nf">:&gt;</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w">    </span><span class="nv">rk0</span><span class="w"> </span><span class="nv">rk1</span><span class="w"> </span><span class="nv">+大红+</span><span class="w"> </span><span class="nv">+鹅黄+</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nf">:&gt;</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="nv">rk2</span><span class="w"> </span><span class="nv">rk3</span><span class="w"> </span><span class="nv">+天蓝+</span><span class="w"> </span><span class="nv">+豆绿+</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="nf">add-plot-legend</span><span class="w"> </span><span class="p">(</span><span class="nf">plot</span><span class="w"> </span><span class="nv">:padding</span><span class="w"> </span><span class="mf">0.1</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="s">&quot;k = 0 first forward&quot;</span><span class="w">  </span><span class="nv">:color</span><span class="w"> </span><span class="nv">+大红+</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="s">&quot;k = 1 first forward&quot;</span><span class="w">  </span><span class="nv">:color</span><span class="w"> </span><span class="nv">+鹅黄+</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="s">&quot;k = 0 first centeral&quot;</span><span class="w"> </span><span class="nv">:color</span><span class="w"> </span><span class="nv">+天蓝+</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="s">&quot;k = 1 first centeral&quot;</span><span class="w"> </span><span class="nv">:color</span><span class="w"> </span><span class="nv">+豆绿+</span><span class="p">)))</span>
<span class="nv">out-path</span>
</pre></div>
        <p>
        </p>
        <p><img src="/_img/lisp/computational-physics/richardson-extrapolation-on-df-example-2.png" alt="/_img/lisp/computational-physics/richardson-extrapolation-on-df-example-2.png" /></p>
        <p>如此可见: 调 <code>dx</code> 的作用可能比换算法来得有效, 并且与其纠结小量展开的误差,
          其实考虑换一个求导方法估计效果更好.</p>
      </li>
    </ul>
   </details>
  </li>
  <li>通过使用虚数进行计算
    <p>\[f(x + i h) = f(x) + i h f'(x) + \cdots &rArr; f'(x) = \frac{\mathrm{Im}(f(x + i h))}{h} + \frac{h^2}{6} f&#8221;'(x) + O(h^4)\]</p>
  </li>
</ol>
<h2>Numerical Integration</h2>
<h3>Taylor Expand</h3>
<p>对于 \((a, b)\) 段上的积分 \(&int;_a^b f(x) \mathrm{d} x\), 可以将其分成小份,
  再通过 Taylor 展开转换为幂级数的积分:</p>
<p>\[&int;_{a}^{b} f(x) \mathrm{d}x = &sum;_{n = 0}^{&infin;} &int;_{x_0 - h}^{x_0 + h} \frac{x^i}{i!} f^{(i)}(x_0) \mathrm{d} x = &sum;_{n = 0}^{&infin;} \frac{f^{2n} (x_0)}{(2n + 1)!} 2 h^{n + 1}\]</p>
<p>考虑其中的 \(&int;_{-h}^{h}\) 的小份的积分:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">integrate</span><span class="w"> </span><span class="p">(</span><span class="nf">fn</span><span class="w"> </span><span class="nv">xmin</span><span class="w"> </span><span class="nv">xmax</span><span class="w"> </span><span class="nv">method</span><span class="w"> </span><span class="nv">&amp;optional</span><span class="w"> </span><span class="p">(</span><span class="nf">dx</span><span class="w"> </span><span class="mi">1e-3</span><span class="p">))</span>
<span class="w">  </span><span class="s">&quot;Integrate function `fn&#39; from `xmin&#39; to `xmax&#39; with `method&#39;. &quot;</span>
<span class="w">  </span><span class="p">(</span><span class="nf">loop</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">integrate</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="nv">for</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="nv">xmin</span><span class="w"> </span><span class="nv">upto</span><span class="w"> </span><span class="nv">xmax</span><span class="w"> </span><span class="nv">by</span><span class="w"> </span><span class="nv">dx</span>
<span class="w">        </span><span class="k">do</span><span class="w"> </span><span class="p">(</span><span class="nf">incf</span><span class="w"> </span><span class="nv">integrate</span><span class="w"> </span><span class="p">(</span><span class="nf">funcall</span><span class="w"> </span><span class="nv">method</span><span class="w"> </span><span class="nv">fn</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">dx</span><span class="p">))</span>
<span class="w">        </span><span class="nv">finally</span><span class="w"> </span><span class="p">(</span><span class="nf">return</span><span class="w"> </span><span class="nv">integrate</span><span class="p">)))</span>
</pre></div>
<ul>
  <li>Midpoint Rule: \(2 h f(\frac{a + b}{2}) + o(h^{3})\) 对应一阶的展开
  <details><summary>Midpoint Rule</summary>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">midpoint-rule</span><span class="w"> </span><span class="p">(</span><span class="nf">fn</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">2h</span><span class="p">)</span>
<span class="w">  </span><span class="s">&quot;Integarate function `fn&#39; from `xmin&#39; to `xmax&#39;. &quot;</span>
<span class="w">  </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="nv">2h</span><span class="w"> </span><span class="p">(</span><span class="nf">funcall</span><span class="w"> </span><span class="nv">fn</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="nv">2h</span><span class="w"> </span><span class="mi">2</span><span class="p">)))))</span>
</pre></div>
  </details>
  </li>
  <li>Simpson Rule: \(2 h f(x_0) + \frac{f&#8221;(x_0)}{3} h^3 + o(h^5)\) 对应二阶的展开
    <p>其中使用符号求导的结果替换 \(f&#8221;\) 项
      (利用前文的 <code>(make-finite-differentor-matrix &#39;(1 -1))</code>):</p>
    <p>\[&int;_a^b f(x) \mathrm{d}x = \frac{h}{3} \left[ f(a) + 4 f(\frac{a + b}{2}) + f(b) \right]\]</p>
  <details><summary>Simpson Rule</summary>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">simpson-rule</span><span class="w"> </span><span class="p">(</span><span class="nf">fn</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">2h</span><span class="p">)</span>
<span class="w">  </span><span class="s">&quot;Integrate function `fn&#39; from `xmin&#39; to `xmax&#39;. &quot;</span>
<span class="w">  </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="nv">2h</span><span class="w"> </span><span class="mi">1/2</span><span class="w"> </span><span class="mi">1/3</span>
<span class="w">     </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nf">funcall</span><span class="w"> </span><span class="nv">fn</span><span class="w"> </span><span class="nv">x</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="p">(</span><span class="nf">funcall</span><span class="w"> </span><span class="nv">fn</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="nv">2h</span><span class="w"> </span><span class="mi">2</span><span class="p">))))</span>
<span class="w">        </span><span class="p">(</span><span class="nf">funcall</span><span class="w"> </span><span class="nv">fn</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">2h</span><span class="p">)))))</span>
</pre></div>
  </details>
  </li>
  <li>同样的, 和导数一样, 有虚数形式:
    <p>\[&int;_a^b f(x) \mathrm{d}x = \left[ &sum;_{i=0}^{n-1} 2 h f(a + i h) \right] + o(h^2)\]</p>
  </li>
</ul>
<details><summary>考虑误差的累积</summary>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">with-present-to-file</span>
<span class="w">    </span><span class="p">(</span><span class="nf">plot</span><span class="w"> </span><span class="nv">plot</span><span class="w"> </span><span class="nv">:margin</span><span class="w"> </span><span class="mi">10</span>
<span class="w">               </span><span class="nv">:x-label</span><span class="w"> </span><span class="s">&quot;ln(dx)&quot;</span><span class="w"> </span><span class="nv">:y-label</span><span class="w"> </span><span class="s">&quot;ln(ε)&quot;</span>
<span class="w">               </span><span class="nv">:x-min</span><span class="w"> </span><span class="mi">1d-6</span><span class="w">   </span><span class="nv">:x-max</span><span class="w"> </span><span class="mi">1d-1</span>
<span class="w">               </span><span class="nv">:y-min</span><span class="w"> </span><span class="mi">1d-14</span><span class="w">  </span><span class="nv">:y-max</span><span class="w"> </span><span class="mi">1d-1</span>
<span class="w">               </span><span class="nv">:scale</span><span class="w"> </span><span class="nv">:log-log</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nf">out-path</span><span class="w">  </span><span class="nv">:width</span><span class="w"> </span><span class="mi">800</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">flet</span><span class="w"> </span><span class="p">((</span><span class="nf">fn</span><span class="w"> </span><span class="p">(</span><span class="nf">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="p">(</span><span class="nb">exp</span><span class="w"> </span><span class="nv">x</span><span class="p">))))</span><span class="w"> </span><span class="c1">;; =&gt; F(x) = (x - 1) * e^x =&gt; integrate = 1</span>
<span class="w">    </span><span class="p">(</span><span class="nf">flet</span><span class="w"> </span><span class="p">((</span><span class="nf">data</span><span class="w"> </span><span class="p">(</span><span class="nf">method</span><span class="p">)</span>
<span class="w">             </span><span class="p">(</span><span class="nf">loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="nv">n</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="mi">1d0</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="mi">6d0</span><span class="w"> </span><span class="nv">by</span><span class="w"> </span><span class="mf">0.1d0</span>
<span class="w">                   </span><span class="nv">for</span><span class="w"> </span><span class="nv">dx</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">expt</span><span class="w"> </span><span class="mi">10d0</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="nv">n</span><span class="p">))</span>
<span class="w">                   </span><span class="nv">collect</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="nv">dx</span><span class="w"> </span><span class="p">(</span><span class="nb">abs</span><span class="w"> </span><span class="p">(</span><span class="nb">1-</span><span class="w"> </span><span class="p">(</span><span class="nf">integrate</span><span class="w"> </span><span class="o">#</span><span class="ss">&#39;fn</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nv">method</span><span class="w"> </span><span class="nv">dx</span><span class="p">)))))))</span>
<span class="w">      </span><span class="p">(</span><span class="nf">add-plot-data</span><span class="w"> </span><span class="nv">plot</span><span class="w"> </span><span class="p">(</span><span class="nf">line-plot-pane</span><span class="w"> </span><span class="nv">midpoint</span><span class="w"> </span><span class="nv">:color</span><span class="w"> </span><span class="nv">+大红+</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="nf">data</span><span class="w"> </span><span class="o">#</span><span class="ss">&#39;midpoint-rule</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="nf">add-plot-data</span><span class="w"> </span><span class="nv">plot</span><span class="w"> </span><span class="p">(</span><span class="nf">line-plot-pane</span><span class="w"> </span><span class="nv">simpson</span><span class="w">  </span><span class="nv">:color</span><span class="w"> </span><span class="nv">+天蓝+</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="nf">data</span><span class="w"> </span><span class="o">#</span><span class="ss">&#39;simpson-rule</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="nf">add-plot-legend</span><span class="w"> </span><span class="p">(</span><span class="nf">plot</span><span class="w"> </span><span class="nv">:padding</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="s">&quot;Midpoint Rule&quot;</span><span class="w"> </span><span class="nv">:color</span><span class="w"> </span><span class="nv">+大红+</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="s">&quot;Simpson Rule&quot;</span><span class="w">  </span><span class="nv">:color</span><span class="w"> </span><span class="nv">+天蓝+</span><span class="p">)))</span>
<span class="nv">out-path</span>
</pre></div>
<p><img src="/_img/lisp/computational-physics/integrate-error.png" alt="/_img/lisp/computational-physics/integrate-error.png" /></p>
<p>emmm&#8230; 两个之间的误差基本可以忽略了. 直接计算的话, Simpson Rule
  <code>(integrate #&#39;sin 0 pi #&#39;simpson-rule)</code> 结果为 <code>2.0000064</code>;
  Midpoint Rule <code>(integrate #&#39;sin 0 pi #&#39;midpoint-rule)</code> 的结果为 <code>2.0000067</code>.</p>
<p>可能还跟浮点数精度有关. 用双精度的话, <code>(integrate #&#39;sin 0 pi #&#39;simpson-rule 1d-3)</code>
  的结果为 <code>1.9999999170346228d0</code>; <code>(integrate #&#39;sin 0 pi #&#39;midpoint-rule 1d-3)</code> 的结果为
  <code>2.0000000003679577d0</code>.</p>
</details>
<h3>Newton-Cotes Weights</h3>
<p>不难发现, 上面的 Taylor Expand 是假设采样点都是均匀分布的 (确切来说,
  是二等分的). 那如果对于非等分, 或者说任意的采样点呢? 即:</p>
<p>\[&int;_a^b f(x) \mathrm{d} x = &sum;_i w_i f(x_i), x_i &isin; [a, b]\]</p>
<p>因为 \(w_i\) 因与 \(f(x)\) 无关, 所以可以代入 \(f(x) = 1, x, x^2\),
  于是问题又变成了求解线性方程组.</p>
<ul>
  <li>Rectangle Rule: \(&int;_{x_1}^{x_2} f(x) \mathrm{d}x = h f_1\)</li>
  <li>Trapezium Rule: \(&int;_{x_1}^{x_2} f(x) \mathrm{d}x = \frac{h}{2} (f_1 + f_2) + o(h^3)\)</li>
</ul>
<p>(其实这部分完全就是矩形规则和梯形规则嘛&#8230; )</p>
<h3>Romberg's Method</h3>
<p>如何消除小量的误差? 还是 Richardson Extrapolation.</p>
<h3>Gaussian Quadrature</h3>
<p>\[&int;_{-1}^1 f(x) \mathrm{d} x = f(\frac{1}{\sqrt{3}}) + f(- \frac{1}{\sqrt{3}})\]</p>
<h2>Symbolic Differentiation</h2>
<p>这部分可以参考: <a href="/lisp/what-about-symbolic-df/">What about Symbolic df?</a>, 这里就不写了, 因为不是重点.
  不过我现在对之前的代码又有些不太满意了, 底层写得太死了, 无法支持更加灵活的修改.
  拓展性不足.</p>
<h1>Solving Equations</h1>
<p>(注: 复习时间不太多了, 一些不常用的我就跳过了&#8230;
  这里建议后面的参考 <a href="https://ucaskernel.com/d/810-writeup/">kernel</a> 上的笔记)</p>
<h2>One Variable</h2>
<p>方程的求解方式即构造一个迭代器, 以及提供一个更新方法, 若更新的解不够好,
  就继续更新, 反之则返回更新的解:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">convergence</span><span class="w"> </span><span class="p">(</span><span class="nf">update-fn</span><span class="w"> </span><span class="nv">init-x</span>
<span class="w">                  </span><span class="nv">&amp;key</span><span class="w"> </span><span class="p">(</span><span class="nf">tol</span><span class="w"> </span><span class="mi">1e-3</span><span class="p">)</span>
<span class="w">                    </span><span class="p">(</span><span class="nf">diff</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nf">a</span><span class="w"> </span><span class="nv">b</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">abs</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">b</span><span class="p">)))))</span>
<span class="w">  </span><span class="s">&quot;Calculate the root with `update-fn&#39; with `init-x&#39;. &quot;</span>
<span class="w">  </span><span class="p">(</span><span class="nf">labels</span><span class="w"> </span><span class="p">((</span><span class="nf">iter</span><span class="w"> </span><span class="p">(</span><span class="nf">x</span><span class="p">)</span>
<span class="w">             </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nf">update-x</span><span class="w"> </span><span class="p">(</span><span class="nf">funcall</span><span class="w"> </span><span class="nv">update-fn</span><span class="w"> </span><span class="nv">x</span><span class="p">)))</span>
<span class="w">               </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="p">(</span><span class="nf">funcall</span><span class="w"> </span><span class="nv">diff</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">update-x</span><span class="p">)</span><span class="w"> </span><span class="nv">tol</span><span class="p">)</span><span class="w"> </span><span class="nv">update-x</span>
<span class="w">                   </span><span class="p">(</span><span class="nf">iter</span><span class="w"> </span><span class="nv">update-x</span><span class="p">)))))</span>
<span class="w">    </span><span class="p">(</span><span class="nf">iter</span><span class="w"> </span><span class="nv">init-x</span><span class="p">)))</span>
</pre></div>
<p>对于类似这样的迭代法的通用思路, 有一套专门描述的理论语言:</p>
<ul>
  <li>Q-convergence: 在迭代的过程中, 每次更新的量 \(| x_{k+1} - x_k | = | &epsilon;_k |\) 有:
    <p>\[lim_{k &rarr; &infin;} \frac{| &epsilon;_{k+1} |}{| &epsilon;_k |^q} = &mu;\]</p>
  <details><summary>如何计算这个</summary>很遗憾, 只能理论推导 (手算) 吗?
    <ul>
      <li>令 \(x_{k+1} = &phi;(x_k), &xi; = lim_{k &rarr; &infin;} &phi;(x_k)\)</li>
      <li>\(&epsilon;_{k+1} = &epsilon;_k &phi;'(&xi;) &rArr; lim_{k &rarr; &infin;} \frac{| &epsilon;_{k+1} |}{| &epsilon;_k |^q} = &mu;\)</li>
      <li>\(&mu;\) 表示了收敛的速度</li>
      <li>\(q\) 表示了收敛的阶数 (order)</li>
    </ul>
  </details>
  </li>
  <li>近似值: (可以通过在迭代时候计算)
    <p>\[q &asymp; \frac{log \left| \frac{x_{k+1} - x_k}{x_k - x_{k-1}} \right|}{log \left| \frac{x_k - x_{k-1}}{x_{k-1} - x_{k-2}} \right|}\]</p>
  </li>
  <li>可收敛区域 (并不是所有初始点都可以收敛的)</li>
</ul>
<h3>Rearrange 不动点求解</h3>
<p>对于方程 \(\mathrm{eq}(x) = 0\), 手动变换形式为 \(x = f(x)\), 可以发现变成了一个求解不动点的问题.
  于是迭代就可以计算得到最后的结果.</p>
<details><summary>一个例子</summary>
<p>对于: \(x^5 - x - 1 = 0 &rArr; x = (x + 1)^{1/5}\), 可以计算得到:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">convergence</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nf">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">expt</span><span class="w"> </span><span class="p">(</span><span class="nb">1+</span><span class="w"> </span><span class="nv">x</span><span class="p">)</span><span class="w"> </span><span class="mi">1/5</span><span class="p">))</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="c1">;; =&gt; 1.1672806</span>
</pre></div>
<p>为什么不用 \(x = x^5 - 1\)?</p>
<p>emmm&#8230; 这里是一个简单的图示:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">with-present-to-file</span>
<span class="w">    </span><span class="p">(</span><span class="nf">plots</span><span class="w"> </span><span class="nv">horizontal-layout-presentation</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nf">out-path</span><span class="w"> </span><span class="nv">:width</span><span class="w"> </span><span class="mi">800</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">flet</span><span class="w"> </span><span class="p">((</span><span class="nf">data</span><span class="w"> </span><span class="p">(</span><span class="nf">fn</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="nv">xmin</span><span class="w"> </span><span class="nv">upto</span><span class="w"> </span><span class="nv">xmax</span><span class="w"> </span><span class="nv">by</span><span class="w"> </span><span class="mf">0.1</span>
<span class="w">                          </span><span class="nv">collect</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="p">(</span><span class="nf">funcall</span><span class="w"> </span><span class="nv">fn</span><span class="w"> </span><span class="nv">x</span><span class="p">))))</span>
<span class="w">         </span><span class="p">(</span><span class="nf">draw-path</span><span class="w"> </span><span class="p">(</span><span class="nf">fn</span><span class="p">)</span>
<span class="w">           </span><span class="p">(</span><span class="nf">loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="nv">below</span><span class="w"> </span><span class="mi">3</span>
<span class="w">                 </span><span class="nv">for</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="nv">then</span><span class="w"> </span><span class="nv">y</span>
<span class="w">                 </span><span class="nv">for</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nf">funcall</span><span class="w"> </span><span class="nv">fn</span><span class="w"> </span><span class="nv">x</span><span class="p">)</span>
<span class="w">                 </span><span class="nv">collect</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">x</span><span class="p">)</span>
<span class="w">                 </span><span class="nv">collect</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">y</span><span class="p">))))</span>
<span class="w">    </span><span class="p">(</span><span class="nf">add-component</span><span class="w"> </span><span class="nv">plots</span><span class="w"> </span><span class="ss">&#39;a</span>
<span class="w">                   </span><span class="p">(</span><span class="nf">with-present</span><span class="w"> </span><span class="p">(</span><span class="nf">plot</span><span class="w"> </span><span class="nv">plot</span><span class="w"> </span><span class="nv">:margin</span><span class="w"> </span><span class="mi">10</span>
<span class="w">                                            </span><span class="nv">:x-min</span><span class="w"> </span><span class="nv">xmin</span><span class="w"> </span><span class="nv">:x-max</span><span class="w"> </span><span class="nv">xmax</span>
<span class="w">                                            </span><span class="nv">:y-min</span><span class="w"> </span><span class="nv">ymin</span><span class="w"> </span><span class="nv">:y-max</span><span class="w"> </span><span class="nv">ymax</span><span class="p">)</span>
<span class="w">                     </span><span class="p">(</span><span class="nf">add-plot-data</span><span class="w"> </span><span class="nv">plot</span><span class="w"> </span><span class="p">(</span><span class="nf">line-plot-pane</span><span class="w"> </span><span class="nv">update</span><span class="w"> </span><span class="nv">:color</span><span class="w"> </span><span class="nv">+大红+</span><span class="p">)</span>
<span class="w">                       </span><span class="p">(</span><span class="nf">data</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nf">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">1-</span><span class="w"> </span><span class="p">(</span><span class="nb">expt</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="mi">5</span><span class="p">)))))</span>
<span class="w">                     </span><span class="p">(</span><span class="nf">add-plot-data</span><span class="w"> </span><span class="nv">plot</span><span class="w"> </span><span class="p">(</span><span class="nf">line-plot-pane</span><span class="w"> </span><span class="nv">y=x</span><span class="w"> </span><span class="nv">:color</span><span class="w"> </span><span class="nv">+天蓝+</span><span class="p">)</span>
<span class="w">                       </span><span class="p">(</span><span class="nf">data</span><span class="w"> </span><span class="o">#</span><span class="ss">&#39;identity</span><span class="p">))</span>
<span class="w">                     </span><span class="p">(</span><span class="nf">add-plot-data</span><span class="w"> </span><span class="nv">plot</span><span class="w"> </span><span class="p">(</span><span class="nf">line-plot-pane</span><span class="w"> </span><span class="nv">path</span><span class="p">)</span>
<span class="w">                       </span><span class="p">(</span><span class="nf">draw-path</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nf">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">1-</span><span class="w"> </span><span class="p">(</span><span class="nb">expt</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="mi">5</span><span class="p">))))))</span>
<span class="w">                   </span><span class="mf">0.5</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nf">add-component</span><span class="w"> </span><span class="nv">plots</span><span class="w"> </span><span class="ss">&#39;b</span>
<span class="w">                   </span><span class="p">(</span><span class="nf">with-present</span><span class="w"> </span><span class="p">(</span><span class="nf">plot</span><span class="w"> </span><span class="nv">plot</span><span class="w"> </span><span class="nv">:margin</span><span class="w"> </span><span class="mi">10</span>
<span class="w">                                            </span><span class="nv">:x-min</span><span class="w"> </span><span class="nv">xmin</span><span class="w"> </span><span class="nv">:x-max</span><span class="w"> </span><span class="nv">xmax</span>
<span class="w">                                            </span><span class="nv">:y-min</span><span class="w"> </span><span class="nv">ymin</span><span class="w"> </span><span class="nv">:y-max</span><span class="w"> </span><span class="nv">ymax</span><span class="p">)</span>
<span class="w">                     </span><span class="p">(</span><span class="nf">add-plot-data</span><span class="w"> </span><span class="nv">plot</span><span class="w"> </span><span class="p">(</span><span class="nf">line-plot-pane</span><span class="w"> </span><span class="nv">update</span><span class="w"> </span><span class="nv">:color</span><span class="w"> </span><span class="nv">+大红+</span><span class="p">)</span>
<span class="w">                       </span><span class="p">(</span><span class="nf">data</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nf">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">expt</span><span class="w"> </span><span class="p">(</span><span class="nb">1+</span><span class="w"> </span><span class="nv">x</span><span class="p">)</span><span class="w"> </span><span class="mi">1/5</span><span class="p">))))</span>
<span class="w">                     </span><span class="p">(</span><span class="nf">add-plot-data</span><span class="w"> </span><span class="nv">plot</span><span class="w"> </span><span class="p">(</span><span class="nf">line-plot-pane</span><span class="w"> </span><span class="nv">y=x</span><span class="w"> </span><span class="nv">:color</span><span class="w"> </span><span class="nv">+天蓝+</span><span class="p">)</span>
<span class="w">                       </span><span class="p">(</span><span class="nf">data</span><span class="w"> </span><span class="o">#</span><span class="ss">&#39;identity</span><span class="p">))</span>
<span class="w">                     </span><span class="p">(</span><span class="nf">add-plot-data</span><span class="w"> </span><span class="nv">plot</span><span class="w"> </span><span class="p">(</span><span class="nf">line-plot-pane</span><span class="w"> </span><span class="nv">path</span><span class="p">)</span>
<span class="w">                       </span><span class="p">(</span><span class="nf">draw-path</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nf">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">expt</span><span class="w"> </span><span class="p">(</span><span class="nb">1+</span><span class="w"> </span><span class="nv">x</span><span class="p">)</span><span class="w"> </span><span class="mi">1/5</span><span class="p">)))))</span>
<span class="w">                   </span><span class="mf">0.5</span><span class="p">)))</span>
<span class="nv">out-path</span>
</pre></div>
<p><img src="/_img/lisp/computational-physics/integrate-error.png" alt="/_img/lisp/computational-physics/integrate-error.png" /></p>
<p>从图中不难看出收敛的迭代线 (黑色) 的变化趋势吧.</p>
</details>
<h3>Newton Raphson Method</h3>
<p>\[x_{k+1} = x_k - \frac{f(x_k)}{f'(x_k)}\]</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">newton-raphson-solve</span><span class="w"> </span><span class="p">(</span><span class="nf">fn</span><span class="w"> </span><span class="nv">dfn</span><span class="w"> </span><span class="nv">init-x</span>
<span class="w">                             </span><span class="nv">&amp;key</span><span class="w"> </span><span class="p">(</span><span class="nf">tol</span><span class="w"> </span><span class="mi">1e-3</span><span class="p">)</span>
<span class="w">                               </span><span class="p">(</span><span class="nf">diff</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nf">a</span><span class="w"> </span><span class="nv">b</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">abs</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">b</span><span class="p">)))))</span>
<span class="w">  </span><span class="s">&quot;Newton Raphson. &quot;</span>
<span class="w">  </span><span class="p">(</span><span class="nf">convergence</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nf">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="p">(</span><span class="nf">funcall</span><span class="w"> </span><span class="nv">fn</span><span class="w"> </span><span class="nv">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">funcall</span><span class="w"> </span><span class="nv">dfn</span><span class="w"> </span><span class="nv">x</span><span class="p">))))</span>
<span class="w">               </span><span class="nv">init-x</span><span class="w"> </span><span class="nv">:tol</span><span class="w"> </span><span class="nv">tol</span><span class="w"> </span><span class="nv">:diff</span><span class="w"> </span><span class="nv">diff</span><span class="p">))</span>
</pre></div>
<ul>
  <li>\(q = 2\)</li>
  <li>\(&mu; = \frac{1}{2} \frac{f&#8221;(&xi;)}{f'(&xi;)}\)</li>
</ul>
<h3>Secant Method</h3>
<p>当 Newton Raphson 在使用 <code>first-forward</code> 数值求导的时候, 就会变成 Secant Method:</p>
<p>\[x_{k+1} = x_k - f(x_k)\frac{x_k - x_{k-1}}{f(x_1) - f(x_0)}\]</p>
<ul>
  <li>\(q = \frac{1 + \sqrt{5}}{2}\)</li>
</ul>
<h3>Bisection</h3>
<p>\[a_{k+1}, b_{k+1} = &phi;(a_k, b_k) = \left\{ \begin{matrix} (a_k, \frac{a_k + b_k}{2}) &amp; f(\frac{a_k + b_k}{2}) &gt; 0 &#92; (\frac{a_k + b_k}{2}, b_k) &amp; f(\frac{a_k + b_k}{2}) &lt; 0 \end{matrix} \right.\]</p>
<ul>
  <li>\(q = 1\)</li>
  <li>\(&mu; = \frac{1}{2}\)</li>
</ul>
<p>注: 通过拓展是可以变成多维的形式的, 见后文.</p>
<h3>Inverse Quadratic Interpolation</h3>
<p>\[x_{n+1} = \frac{f_{n-1} f_n}{(f_{n-2} - f_{n-1}) (f_{n-2} - f_n)} x_{n-2} + \frac{f_{n-2} f_n}{(f_{n-1} - f_{n-2}) (f_{n-1} - f_n)} x_{n-1} + \frac{f_{n-2} f_{n-1}}{(f_n - f_{n-2}) (f_n - f_{n-1})} x_n\]</p>
<h2>Multiple Variable</h2>
<h1>Optimize</h1>
<h2>Local</h2>
<h3>解方程 \(f'(x) = 0\)</h3>
<p>把问题变成求解 \(f'(x) = 0\) 的解方程问题.</p>
<h3>Gradient Descent</h3>
<p>\[\boldsymbol{x}_{k+1} = \boldsymbol{x}_k + &Delta; \boldsymbol{x}_k = \boldsymbol{x}_{k+1} - &alpha; \frac{&nabla; f(\boldsymbol{x}_k)}{| &nabla; f(\boldsymbol{x}_k) |}\]</p>
<p>其中缩放的尺度 \(&alpha;\) 通过 line search 方法进行确定:</p>
<ul>
  <li>\(f(\boldsymbol{x}_{k+1}) - f(\boldsymbol{x}_k) &lt; &alpha; c | &nabla; f(\boldsymbol{x}_k) |\)</li>
  <li>其中 \(c\) 为控制常数, \(&alpha;\) 通过 \(&tau;\) 进行缩放</li>
</ul>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="k">defmacro</span><span class="w"> </span><span class="nv">that</span><span class="w"> </span><span class="p">(</span><span class="nf">var</span><span class="w"> </span><span class="nv">&amp;key</span><span class="w"> </span><span class="nv">condition</span><span class="w"> </span><span class="nv">improve</span><span class="w"> </span><span class="nv">initial</span><span class="p">)</span>
<span class="w">  </span><span class="s">&quot;Get the `var&#39; that make the `condition&#39; for true.</span>
<span class="s">Improve the `var&#39; using improve procedure. &quot;</span>
<span class="w">  </span><span class="o">`</span><span class="p">(</span><span class="nf">loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="o">,</span><span class="nv">var</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="o">,</span><span class="nv">initial</span><span class="w"> </span><span class="nv">then</span><span class="w"> </span><span class="o">,</span><span class="nv">improve</span>
<span class="w">         </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nb">not</span><span class="w"> </span><span class="o">,</span><span class="nv">condition</span><span class="p">)</span>
<span class="w">         </span><span class="nv">finally</span><span class="w"> </span><span class="p">(</span><span class="nf">return</span><span class="w"> </span><span class="nv">var</span><span class="p">)))</span>

<span class="c1">;; pesudo-code</span>
<span class="p">(</span><span class="nf">that</span><span class="w"> </span><span class="nv">alpha</span>
<span class="w">      </span><span class="nv">:condition</span><span class="w"> </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nf">gradient</span><span class="w"> </span><span class="p">(</span><span class="err">∇</span><span class="w"> </span><span class="nv">f</span><span class="w"> </span><span class="nv">xk</span><span class="p">))</span>
<span class="w">                       </span><span class="p">(</span><span class="nf">xk+1</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="nv">xk</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="nv">alpha</span><span class="w"> </span><span class="p">(</span><span class="nf">uniform</span><span class="w"> </span><span class="nv">gradient</span><span class="p">)))))</span>
<span class="w">                   </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nf">f</span><span class="w"> </span><span class="nv">xk+1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">f</span><span class="w"> </span><span class="nv">xk</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="nv">alpha</span><span class="w"> </span><span class="nv">c</span><span class="w"> </span><span class="p">(</span><span class="nf">norm</span><span class="w"> </span><span class="nv">gradient</span><span class="p">))))</span>
<span class="w">      </span><span class="nv">:improve</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="nv">alpha</span><span class="w"> </span><span class="nv">c</span><span class="p">)</span>
<span class="w">      </span><span class="nv">:initial</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
</pre></div>
<p>(没时间了, 只能写伪代码了&#8230; )</p>
<h4>Eigenvector Following</h4>
<p>如果想要保证能够找到的就是最小值 (在一维问题的情况下,
  这个可以通过 Newton Raphson 计算 \(x_{k+1} = x_k - \frac{f'(x)}{| f&#8221;(x) |}\) 来实现).</p>
<p>对于 Gradient Search, 这是将上文中的 <code>∇</code> 算子替换为在本征矢上的投影:</p>
<p>\[&nabla;_{\bot} f = &nabla; f - (&nabla; f^{\mathrm{T}} &sdot; \boldsymbol{v}_{\mathrm{min}}) \boldsymbol{v}_{\mathrm{min}}\]</p>
<p>其中 \(\boldsymbol{v}_{\mathrm{min}}\) 为最小的本征值.</p>
<h4>The Rayleigh-Ritz Ratio</h4>
<p>用于求最小的本征值:</p>
<p>\[&lambda; (\boldsymbol{v}) = \frac{\boldsymbol{v}^T \boldsymbol{H} (\boldsymbol{x}) \boldsymbol{v}}{\boldsymbol{v}^{\mathrm{T}} \boldsymbol{v}}\]</p>
<p>\[&nabla; &lambda;(\boldsymbol{v}) = \frac{(\boldsymbol{v}^{\mathrm{T}} \boldsymbol{v}) (\boldsymbol{H} \boldsymbol{v} + \boldsymbol{H}^{\mathrm{T}} \boldsymbol{v}) - 2(\boldsymbol{v}^T \boldsymbol{H} \boldsymbol{v}) \boldsymbol{v}}{(\boldsymbol{v}^T \boldsymbol{v})^2}\]</p>
<p>在 \(\boldsymbol{v} \parallel \boldsymbol{v}_{\mathrm{min}}\) 时, \(&lambda;(\boldsymbol{v})\) 有唯一最小值.</p>
<h3>BFGS (Broyden-Fletcher-Goldfarb-Shanno) Method</h3>
<h3>Newton Raphson</h3>
<h3>Nelder-Mead Method</h3>
<h2>Global</h2>
<h3>Random Sampling</h3>
<ol>
  <li>在构型空间里面随机撒点</li>
  <li>从每个撒点开始做局部最小值搜索</li>
</ol>
<h3>Basin Hopping</h3>
<ol>
  <li>随机移动一定的步长并在该点附近寻找局部最小值</li>
  <li>计算移动前后的函数值 (能量值的差) 并通过 Metropolis 过程选择是否接受,
    若接受, 则移动; 反之, 保持原位</li>
  <li>重复执行上述步骤直到移动距离足够小</li>
</ol>
<h1>Differential Equation</h1>
<h2>ODE</h2>
<ol>
  <li>将方程降阶为一阶微分方程组, 变换为 \(\dot{\boldsymbol{x}} = \boldsymbol{f}(\boldsymbol{x})\) 的形式</li>
  <li>应用迭代器对方程从初始值开始进行演化:
    <ul>
      <li>Forward Eular: \(\boldsymbol{x}_{k+1} = \boldsymbol{x}_k + \boldsymbol{f}(\boldsymbol{x}_k) &Delta; t\)</li>
      <li>Backward Eular: \(\boldsymbol{x}_{k+1} = \boldsymbol{x}_k + \boldsymbol{f}(\boldsymbol{x}_{k+1}) &Delta; t\)
        <p>这里有两种做法:</p>
        <ol>
          <li>对迭代方程进行约化, 求解 \(\boldsymbol{x}_{k+1} = \boldsymbol{f}(\boldsymbol{x}_k, &Delta; t)\)</li>
          <li>通过 Forward Eular 计算出右式的 \(\boldsymbol{x}_{k+1}\), 并用其计算出左式的值</li>
        </ol>
      </li>
      <li>Runge Kutta (见下文折叠部分)</li>
    </ul>
  </li>
</ol>
<details><summary>这里可以参考的东西</summary>
<p>之前写的小报告:</p>
<p>\[y_{n+1} = y_n + h &sum;_{i=1}^s b_i k_i\]</p>
<p>where</p>
<p>\[\begin{matrix}
  k_1 &amp; = &amp; f(t_n, y_n) <br />
  k_2 &amp; = &amp; f(t_n + c_2 h, y_n + (a_{21} k_1) h) &#92;
  \cdots &amp; = &amp; \cdots &#92;
  k_s &amp; = &amp; f(t_n + c_s h, y_n + (a_{s1} k_1 + \cdots + a_{s,s-1} k_{s-1}) h)
  \end{matrix}\]</p>
<p>the parameter matrix would be like below (Butcher tableau) [fn:: from <a href="https://en.wikipedia.org/wiki/Runge–Kutta_methods">Wikipedia</a>]:</p>
<table>
  <tr><td>/</td><td>&lt;</td><td></td><td></td><td>/</td></tr>
  <tr><td>0</td><td></td><td></td><td></td><td></td></tr>
  <tr><td>c_2</td><td>a_{21}</td><td></td><td></td><td></td></tr>
  <tr><td>c_3</td><td>a_{31}</td><td>a_{32}</td><td></td><td></td></tr>
  <tr><td>&#8230;</td><td>&#8230;</td><td>&#8230;</td><td>&#8230;</td><td></td></tr>
  <tr><th>c_s</th><th>a_{s1}</th><th>a_{s2}</th><th>&#8230;</th><th>a_{s,s-1}</th></tr>
  <tr><td></td><td>b_1</td><td>b_2</td><td>&#8230;</td><td>b_s</td></tr>
</table>
<p>Below is the main iter process of Runge Kutta Method[fn:: the <code>def-runge-kutta</code> marco is just for making the same interface as <code>forward-euler</code> and other macros and functions, which is quite dirty]:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">make-runge-kutta-iter</span><span class="w"> </span><span class="p">(</span><span class="nf">bs</span><span class="w"> </span><span class="nv">c-as</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nf">bs</span><span class="w"> </span><span class="p">(</span><span class="nf">mapcar</span><span class="w"> </span><span class="o">#</span><span class="ss">&#39;float</span><span class="w"> </span><span class="nv">bs</span><span class="p">))</span><span class="w">        </span><span class="c1">; trun to float type for fast computing</span>
<span class="w">        </span><span class="p">(</span><span class="nf">c-as</span><span class="w"> </span><span class="p">(</span><span class="nf">mapcar</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nf">c-a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">mapcar</span><span class="w"> </span><span class="o">#</span><span class="ss">&#39;float</span><span class="w"> </span><span class="nv">c-a</span><span class="p">))</span><span class="w"> </span><span class="nv">c-as</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="nf">macrolet</span><span class="w"> </span><span class="p">((</span><span class="nf">w-sum</span><span class="w"> </span><span class="p">(</span><span class="nf">ws</span><span class="w"> </span><span class="nv">ks</span><span class="p">)</span>
<span class="w">                 </span><span class="o">`</span><span class="p">(</span><span class="nb">reduce</span><span class="w"> </span><span class="o">#</span><span class="ss">&#39;add</span><span class="w"> </span><span class="p">(</span><span class="nf">mapcar</span><span class="w"> </span><span class="o">#</span><span class="ss">&#39;mul</span><span class="w"> </span><span class="o">,</span><span class="nv">ws</span><span class="w"> </span><span class="o">,</span><span class="nv">ks</span><span class="p">)</span>
<span class="w">                          </span><span class="nv">:initial-value</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nf">fn</span><span class="w"> </span><span class="nv">init-y</span><span class="w"> </span><span class="nb">times</span><span class="w"> </span><span class="nv">dt</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="nf">loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="nv">init-y</span><span class="w">              </span><span class="c1">; y + dt * sum(bi * ki)</span>
<span class="w">                </span><span class="nv">then</span><span class="w"> </span><span class="p">(</span><span class="nf">add</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="p">(</span><span class="nf">mul</span><span class="w"> </span><span class="nv">dt</span><span class="w"> </span><span class="p">(</span><span class="nf">w-sum</span><span class="w"> </span><span class="nv">bs</span><span class="w"> </span><span class="nv">ks</span><span class="p">)))</span>
<span class="w">              </span><span class="nv">for</span><span class="w"> </span><span class="nv">time</span><span class="w"> </span><span class="nv">below</span><span class="w"> </span><span class="nb">times</span><span class="w"> </span><span class="nv">by</span><span class="w"> </span><span class="nv">dt</span>
<span class="w">              </span><span class="c1">;; ki = f(t + ci * dt, y + sum(a_ij * k_j) * dt)</span>
<span class="w">              </span><span class="nv">for</span><span class="w"> </span><span class="nv">ks</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nf">loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="p">(</span><span class="nf">c</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="nv">as</span><span class="p">)</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">c-as</span>
<span class="w">                             </span><span class="nv">collect</span><span class="w"> </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="nv">fn</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="nv">time</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="nv">c</span><span class="w"> </span><span class="nv">dt</span><span class="p">))</span>
<span class="w">                                            </span><span class="p">(</span><span class="nf">add</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="p">(</span><span class="nf">mul</span><span class="w"> </span><span class="p">(</span><span class="nf">w-sum</span><span class="w"> </span><span class="nv">as</span><span class="w"> </span><span class="nv">ks</span><span class="p">)</span><span class="w"> </span><span class="nv">dt</span><span class="p">)))</span>
<span class="w">                               </span><span class="nv">into</span><span class="w"> </span><span class="nv">ks</span>
<span class="w">                             </span><span class="nv">finally</span><span class="w"> </span><span class="p">(</span><span class="nf">return</span><span class="w"> </span><span class="nv">ks</span><span class="p">))</span>
<span class="w">              </span><span class="nv">collect</span><span class="w"> </span><span class="nv">y</span><span class="p">)))))</span>
</pre></div>
<p>The following macro <code>def-runge-kutta</code> defines a easy warpper for Runge Kutta:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="k">defmacro</span><span class="w"> </span><span class="nv">def-runge-kutta</span><span class="w"> </span><span class="p">(</span><span class="nf">name</span><span class="w"> </span><span class="nv">bs</span><span class="w"> </span><span class="nv">&amp;body</span><span class="w"> </span><span class="nv">c-as</span><span class="p">)</span>
<span class="w">  </span><span class="s">&quot;Define a explicit Runge-Kutta process marco `name&#39; and given tableau.</span>

<span class="s">The `bs&#39; will be a list like (b1 b2 ... bs);</span>
<span class="s">The `c-as&#39; will be like (c a1 a2 ... as-1).</span>

<span class="s">Example:</span>
<span class="s">  (def-runge-kutta rk1</span>
<span class="s">    (1)</span>
<span class="s">    (0))&quot;</span>
<span class="w">  </span><span class="p">(</span><span class="nf">with-gensyms</span><span class="w"> </span><span class="p">(</span><span class="nf">iter</span><span class="p">)</span>
<span class="w">    </span><span class="o">`</span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="o">,</span><span class="nv">iter</span><span class="w"> </span><span class="p">(</span><span class="nf">make-runge-kutta-iter</span><span class="w"> </span><span class="ss">&#39;,bs</span><span class="w"> </span><span class="ss">&#39;,c-as</span><span class="p">)))</span>
<span class="w">       </span><span class="p">(</span><span class="k">defmacro</span><span class="w"> </span><span class="o">,</span><span class="nv">name</span><span class="w"> </span><span class="p">(</span><span class="nf">lambda-list</span><span class="w"> </span><span class="nv">fn-body</span>
<span class="w">                        </span><span class="nv">&amp;key</span><span class="w"> </span><span class="p">(</span><span class="nf">dt</span><span class="w"> </span><span class="mf">0.001</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">time</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">var-t</span><span class="w"> </span><span class="ss">&#39;ti</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="k">let*</span><span class="w"> </span><span class="p">((</span><span class="nf">ys</span><span class="w"> </span><span class="p">(</span><span class="nf">mapcar</span><span class="w"> </span><span class="o">#</span><span class="ss">&#39;first</span><span class="w">  </span><span class="nv">lambda-list</span><span class="p">))</span>
<span class="w">                </span><span class="p">(</span><span class="nf">y0</span><span class="w"> </span><span class="p">(</span><span class="nf">mapcar</span><span class="w"> </span><span class="o">#</span><span class="ss">&#39;second</span><span class="w"> </span><span class="nv">lambda-list</span><span class="p">))</span>
<span class="w">                </span><span class="p">(</span><span class="nf">body</span><span class="w"> </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nf">eq</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">fn-body</span><span class="p">)</span><span class="w"> </span><span class="ss">&#39;quote</span><span class="p">)</span>
<span class="w">                          </span><span class="p">(</span><span class="nb">second</span><span class="w"> </span><span class="nv">fn-body</span><span class="p">)</span>
<span class="w">                          </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="ss">&#39;list</span><span class="w"> </span><span class="nv">fn-body</span><span class="p">))))</span>
<span class="w">           </span><span class="o">`</span><span class="p">(</span><span class="nf">funcall</span><span class="w"> </span><span class="o">,,</span><span class="nv">iter</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="o">,</span><span class="nv">var-t</span><span class="w"> </span><span class="o">,@</span><span class="nv">ys</span><span class="p">)</span>
<span class="w">                              </span><span class="p">(</span><span class="nf">declare</span><span class="w"> </span><span class="p">(</span><span class="nf">ignorable</span><span class="w"> </span><span class="o">,</span><span class="nv">var-t</span><span class="p">))</span>
<span class="w">                              </span><span class="o">,</span><span class="nv">body</span><span class="p">)</span>
<span class="w">                     </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="o">,@</span><span class="nv">y0</span><span class="p">)</span><span class="w"> </span><span class="o">,</span><span class="nv">time</span><span class="w"> </span><span class="o">,</span><span class="nv">dt</span><span class="p">))))))</span>
</pre></div>
<p>The most simple example of Runge Kutta process is first rank Runge Kutta:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">def-runge-kutta</span><span class="w"> </span><span class="nv">rk1</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
</pre></div>
<p>which is equal to forward euler method.</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">def-runge-kutta</span><span class="w"> </span><span class="nv">rk2</span>
<span class="w">    </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="mi">1/2</span><span class="w"> </span><span class="mi">1/2</span><span class="p">))</span>
</pre></div>
<p>also could have:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="k">defmacro</span><span class="w"> </span><span class="nv">def-rk2-alpha</span><span class="w"> </span><span class="p">(</span><span class="nf">alpha</span><span class="w"> </span><span class="nv">&amp;optional</span><span class="w"> </span><span class="p">(</span><span class="nf">name</span><span class="w"> </span><span class="nv">alpha</span><span class="p">))</span>
<span class="w">  </span><span class="s">&quot;Make a `rk2-alpha&#39; macro.&quot;</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nf">name</span><span class="w"> </span><span class="p">(</span><span class="nf">intern</span><span class="w"> </span><span class="p">(</span><span class="nb">format</span><span class="w"> </span><span class="nv">nil</span><span class="w"> </span><span class="s">&quot;RK2-~@:(~a~)&quot;</span><span class="w"> </span><span class="nv">name</span><span class="p">))))</span>
<span class="w">    </span><span class="o">`</span><span class="p">(</span><span class="nf">def-runge-kutta</span><span class="w"> </span><span class="o">,</span><span class="nv">name</span>
<span class="w">         </span><span class="p">(</span><span class="o">,</span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="mi">1/2</span><span class="w"> </span><span class="nv">alpha</span><span class="p">))</span><span class="w"> </span><span class="o">,</span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="mi">1/2</span><span class="w"> </span><span class="nv">alpha</span><span class="p">))</span>
<span class="w">       </span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="w">       </span><span class="p">(</span><span class="o">,</span><span class="nv">alpha</span><span class="w"> </span><span class="o">,</span><span class="nv">alpha</span><span class="p">))))</span>
</pre></div>
<p>in this way:</p>
<ul>
  <li>Midpoint Method: \(&alpha; = \frac{1}{2}\)
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">def-rk2-alpha</span><span class="w"> </span><span class="mi">1/2</span><span class="w"> </span><span class="nv">midpoint</span><span class="p">)</span>
</pre></div>
  </li>
  <li>Heun's Method: \(&alpha; = 1\)
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">def-rk2-alpha</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nv">heun-method</span><span class="p">)</span>
</pre></div>
  </li>
  <li>Ralston Method: \(&alpha; = \frac{2}{3}\)
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">def-rk2-alpha</span><span class="w"> </span><span class="mi">2/3</span><span class="w"> </span><span class="nv">ralston</span><span class="p">)</span>
</pre></div>
  </li>
</ul>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">def-runge-kutta</span><span class="w"> </span><span class="nv">rk4</span>
<span class="w">    </span><span class="p">(</span><span class="mi">1/6</span><span class="w"> </span><span class="mi">1/3</span><span class="w"> </span><span class="mi">1/3</span><span class="w"> </span><span class="mi">1/6</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="mi">1/2</span><span class="w"> </span><span class="mi">1/2</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="mi">1/2</span><span class="w"> </span><span class="mi">0</span><span class="w">   </span><span class="mi">1/2</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="mi">1</span><span class="w">   </span><span class="mi">0</span><span class="w">   </span><span class="mi">0</span><span class="w">   </span><span class="mi">1</span><span class="p">))</span>
</pre></div>
<p>求解的代码 (一个例子而已):</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">with-present-to-file</span>
<span class="w">    </span><span class="p">(</span><span class="nf">plots</span><span class="w"> </span><span class="nv">horizontal-layout-presentation</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nf">out-path</span><span class="w"> </span><span class="nv">:width</span><span class="w"> </span><span class="mi">1500</span><span class="w"> </span><span class="nv">:height</span><span class="w"> </span><span class="mi">500</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let*</span><span class="w"> </span><span class="p">((</span><span class="nf">phase</span><span class="w"> </span><span class="p">(</span><span class="nb">eval</span><span class="w"> </span><span class="o">`</span><span class="p">(</span><span class="o">,</span><span class="nv">method</span><span class="w"> </span><span class="p">((</span><span class="nf">x</span><span class="w"> </span><span class="o">,</span><span class="nv">x0</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">y</span><span class="w"> </span><span class="o">,</span><span class="nv">y0</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">z</span><span class="w"> </span><span class="o">,</span><span class="nv">z0</span><span class="p">))</span>
<span class="w">                                </span><span class="p">((</span><span class="nb">*</span><span class="w"> </span><span class="o">,</span><span class="nv">sigma</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nv">x</span><span class="p">))</span>
<span class="w">                                 </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="o">,</span><span class="nv">rho</span><span class="w"> </span><span class="nv">z</span><span class="p">))</span><span class="w"> </span><span class="nv">y</span><span class="p">)</span>
<span class="w">                                 </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="o">,</span><span class="nv">beta</span><span class="w"> </span><span class="nv">z</span><span class="p">)))</span>
<span class="w">                                </span><span class="nv">:dt</span><span class="w"> </span><span class="o">,</span><span class="nv">dt</span><span class="w"> </span><span class="nv">:time</span><span class="w"> </span><span class="o">,</span><span class="nv">time</span><span class="p">))))</span>
<span class="w">    </span><span class="p">(</span><span class="nf">add-component</span><span class="w"> </span><span class="nv">plots</span><span class="w"> </span><span class="ss">&#39;xy-trajectory</span>
<span class="w">                   </span><span class="p">(</span><span class="nf">with-present</span><span class="w"> </span><span class="p">(</span><span class="nf">plot</span><span class="w"> </span><span class="nv">plot</span><span class="w"> </span><span class="nv">:margin</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="nv">:x-label</span><span class="w"> </span><span class="s">&quot;x&quot;</span><span class="w"> </span><span class="nv">:y-label</span><span class="w"> </span><span class="s">&quot;y&quot;</span><span class="p">)</span>
<span class="w">                     </span><span class="p">(</span><span class="nf">add-plot-data</span><span class="w"> </span><span class="nv">plot</span>
<span class="w">                         </span><span class="p">(</span><span class="nf">line-plot-pane</span><span class="w"> </span><span class="nv">points-list</span>
<span class="w">                                         </span><span class="nv">:color</span><span class="w"> </span><span class="nv">+蛋青+</span><span class="p">)</span>
<span class="w">                       </span><span class="p">(</span><span class="nf">loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="p">(</span><span class="nf">x</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nb">-</span><span class="p">)</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">phase</span>
<span class="w">                             </span><span class="nv">collect</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">y</span><span class="p">))))</span>
<span class="w">                   </span><span class="mf">0.33</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nf">add-component</span><span class="w"> </span><span class="nv">plots</span><span class="w"> </span><span class="ss">&#39;xz-trajectory</span>
<span class="w">                   </span><span class="p">(</span><span class="nf">with-present</span><span class="w"> </span><span class="p">(</span><span class="nf">plot</span><span class="w"> </span><span class="nv">plot</span><span class="w"> </span><span class="nv">:margin</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="nv">:x-label</span><span class="w"> </span><span class="s">&quot;x&quot;</span><span class="w"> </span><span class="nv">:y-label</span><span class="w"> </span><span class="s">&quot;z&quot;</span><span class="p">)</span>
<span class="w">                     </span><span class="p">(</span><span class="nf">add-plot-data</span><span class="w"> </span><span class="nv">plot</span>
<span class="w">                         </span><span class="p">(</span><span class="nf">line-plot-pane</span><span class="w"> </span><span class="nv">points-list</span>
<span class="w">                                         </span><span class="nv">:color</span><span class="w"> </span><span class="nv">+大红+</span><span class="p">)</span>
<span class="w">                       </span><span class="p">(</span><span class="nf">loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="p">(</span><span class="nf">x</span><span class="w"> </span><span class="nb">-</span><span class="w"> </span><span class="nv">z</span><span class="p">)</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">phase</span>
<span class="w">                             </span><span class="nv">collect</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">z</span><span class="p">))))</span>
<span class="w">                   </span><span class="mf">0.33</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nf">add-component</span><span class="w"> </span><span class="nv">plots</span><span class="w"> </span><span class="ss">&#39;yz-trajectory</span>
<span class="w">                   </span><span class="p">(</span><span class="nf">with-present</span><span class="w"> </span><span class="p">(</span><span class="nf">plot</span><span class="w"> </span><span class="nv">plot</span><span class="w"> </span><span class="nv">:margin</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="nv">:x-label</span><span class="w"> </span><span class="s">&quot;y&quot;</span><span class="w"> </span><span class="nv">:y-label</span><span class="w"> </span><span class="s">&quot;z&quot;</span><span class="p">)</span>
<span class="w">                     </span><span class="p">(</span><span class="nf">add-plot-data</span><span class="w"> </span><span class="nv">plot</span>
<span class="w">                         </span><span class="p">(</span><span class="nf">line-plot-pane</span><span class="w"> </span><span class="nv">points-list</span>
<span class="w">                                         </span><span class="nv">:color</span><span class="w"> </span><span class="nv">+大红官绿+</span><span class="p">)</span>
<span class="w">                       </span><span class="p">(</span><span class="nf">loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nv">z</span><span class="p">)</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">phase</span>
<span class="w">                             </span><span class="nv">collect</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nv">z</span><span class="p">))))</span>
<span class="w">                   </span><span class="mf">0.33</span><span class="p">)))</span>

<span class="nv">out-path</span>
</pre></div>
</details>
<h2>PDE</h2>
<ol>
  <li>对求解区域进行网格划分</li>
  <li>将偏微分方程差分化, 并注意边界条件的构造</li>
  <li>应用迭代器迭代求解</li>
</ol>
<details><summary>还是之前的小笔记</summary>
<p>For a partial differential equation:</p>
<p>\[&sum; A_{ij} &part;_{q_i}^{k_j} u(q_i) = f(q_i)\]</p>
<p>expect the above equation to be:</p>
<p>\[&sum; a_i u(&delta;_i q_i) = f(q_i)\]</p>
<p>for 2-dimension example:</p>
<p>\[A_{12} &part;_x^2 u + A_{22} &part;_y^2 u = f(x, y)\]</p>
<p>expect to be:</p>
<p>\[A_{12} (u_{i + 1, j} - 2 u_{i, j} + u_{i - 1, j}) + A_{22} (u_{i, j + 1} - 2 u_{i, j} + u_{i, j - 1}) = 2 h f(i, j)\]</p>
<p>the process contains:</p>
<ul>
  <li>\(&part;_q^n\) to \(&sum; a_{lm} u_{i+l, j+m}\) for \(u_{i,j}\)</li>
  <li>iteration solve for discreate equation</li>
</ul>
</details>
<h1>Computer Simulation</h1>
<p>请参考 <a href="https://github.com/li-yiyang/com-phy">li-yiyang/com-phy</a>.</p>
<ul>
  <li>MC 我认为本质上就是在计算一个态密度 \(&omega;(E)\) 的分布,
    然后通过得到的分布进行热力学的统计 \(&rarr;\) 物理量的值</li>
</ul>
<details><summary>大作业的部分截取</summary>
<h2>势函数的截断</h2>
<p>Within the simulation, three pairwise interaction forms will be considered:</p>
<p>Jennard Jones Potential:</p>
<p>\[\begin{array}{l}&phi;_{\mathrm{LJ}}(r) = 4 &epsilon; \left[ \left( \frac{&sigma;}{r} \right)^{12} - \left( \frac{&sigma;}{r} \right)^{6} \right]\end{array}\]</p>
<p>The atomic and the colloidal potential follow the following equation:</p>
<p>\[\begin{array}{c}&phi;(r) = &epsilon; &alpha; \left( [\frac{&sigma;}{r}]^2 - 1 \right) \left( [\frac{r_{\mathrm{c}}}{r}]^2 - 1 \right)^2 \end{array}\]</p>
<p>where \(r_{\mathrm{c}} = 2.0\) for atomic potential and \(r_{\mathrm{c}} = 1.2\) for colloidal potential.</p>
<p>The \(&alpha;\) will ensure \(\mathrm{min} \{&phi;(r)\} = - |&epsilon;|\):</p>
<ul>
  <li>\(\left. &part;_r &phi;(r) \right\vert_{r = r_{\mathrm{min}}} = 0 &rArr; r_{\mathrm{min}} = \frac{\sqrt{3} r_{\mathrm{c}}}{\sqrt{1 + 2 r_{\mathrm{c}}^2}}\)</li>
  <li>\(&phi;(r_{\mathrm{min}}) = &epsilon; &rArr; &alpha; = - \frac{27 r_{\mathrm{c}}^2}{4 (r_{\mathrm{c}}^2 - 1)^3}\), assuming \(&epsilon; = -1 &lt; 0\)</li>
</ul>
<p>So in summary, the pairwise potential and their parameters can be concluded
  into the table:</p>
<table>
  <tr><th>Potential</th><th>Lennard Jones</th><th>Atomic</th><th>Colloidal</th></tr>
  <tr><td>Minimum r_{min}</td><td>1.122</td><td>1.155</td><td>1.055</td></tr>
  <tr><td>Cut-off r_{c}</td><td>2.5</td><td>2.0</td><td>1.2</td></tr>
  <tr><td>Prefactor &alpha;</td><td>N.A.</td><td>-1.000</td><td>-114.106</td></tr>
</table>
<h2>Finite Size Scaling</h2>
<p>通过尺度上的缩放来对系统在近无穷大 (足够大) 尺度下的统计分布做一个了解.</p>
<h2>径向分布函数 RDF</h2>
<p>\[\begin{array}{rcl} g(r) &amp; = &amp; \frac{1}{V_r} &sum;_i^N &sum;_{j = 1}^{i - 1} &theta;(r_{ij} - r) &theta;(r + &Delta; r - r_{ij}) &#92; &theta;(x) &amp; = &amp; \left\{ \begin{matrix} 1 &amp; \mathrm{if}\ x &gt; 0 &#92; 0 &amp; \mathrm{else} \end{matrix} \right. \end{array}\]</p>
<p>可以用来计算压强:</p>
<p>\[p = &rho; k T + &int;_V \boldsymbol{f}(r) &sdot; \hat{\boldsymbol{r}} g(r) \mathrm{d}V \]</p>
</details>
<h1>Appendix</h1>
<h2>Common Lisp</h2>
<p>一个我觉得很好的 brief review:
  <a href="https://www.zhihu.com/question/346774385/answer/832250120">为什么国内计算机专业不以lisp入门？ - CodeArhat的回答 - 知乎</a>.</p>
<details><summary>关于编程语言的一己之见</summary>
<p>叠甲, 仅出于我这个双非物理系学生的一己之见, 纯粹暴论.</p>
<p>编程语言在我看来更像是工具. 什么工作适合, 就应该用什么语言.
  比如 Python 有 Numpy, 很适合快速的矩阵, 线性代数运算,
  用来处理多维数据非常方便, 用它肯定是合适的.</p>
<p>但是如果到底层, 又会因为调库的封装而导致无法自由控制底层,
  所以这个时候用 Python 就会很麻烦, 不如用 C.</p>
<p>所谓的调库其实更像是在已有的底层上进行封装, 这个可以去看
  SDF (Software Designed for Flexibility).</p>
<p>应当去根据自己需要解决的问题去设计工具, 从而方便解决问题.</p>
</details>
<p>你可以配合 VSCode + <a href="https://lispcookbook.github.io/cl-cookbook/vscode-alive.html">ALIVE</a> 或者 <a href="https://lispcookbook.github.io/cl-cookbook/emacs-ide.html">Emacs + SLY/SLIME</a> 来进行使用.
  CL 的发行版可以使用 <a href="https://www.sbcl.org/platform-table.html">SBCL</a>.</p>
<p>这里尝试给一个不自量力的 Common Lisp 基础介绍,
  内容上参考老师课上的 Python 基础介绍 (其实要论上手速度,
  我觉得 CL 绝对是比 Python 要能打得多的.
  对于一个没有学过编程的人来说, CL 就像是 <a href="https://scratch.mit.edu">Scratch</a> 一样简单,
  如果你把所有的括号填上颜色的话; 而对于一个学过编程的人来说,
  如果接受了 CL 的括号, 那么就会很爽了).</p>
<h3>Basic I</h3>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">factorial</span><span class="w"> </span><span class="p">(</span><span class="nf">n</span><span class="p">)</span>
<span class="w">  </span><span class="s">&quot;Evaluates n! = 1 * 2 * ... * (n - 1) * n&quot;</span>
<span class="w">  </span><span class="p">(</span><span class="nf">assert</span><span class="w"> </span><span class="p">(</span><span class="nb">&gt;</span><span class="w"> </span><span class="nv">n</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w">             </span><span class="c1">;; n &gt; 0</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nf">n-factorial</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<span class="w">    </span><span class="p">(</span><span class="nf">dotimes</span><span class="w"> </span><span class="p">(</span><span class="nf">i</span><span class="w"> </span><span class="nv">n</span><span class="w"> </span><span class="nv">n-factorial</span><span class="p">)</span><span class="w"> </span><span class="c1">;; i = 0, 1, 2, ..., n - 1</span>
<span class="w">      </span><span class="p">(</span><span class="nf">setf</span><span class="w"> </span><span class="nv">n-factorial</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="nv">n-factorial</span><span class="w"> </span><span class="p">(</span><span class="nb">1+</span><span class="w"> </span><span class="nv">i</span><span class="p">))))))</span>
</pre></div>
<p>我们可以一个块一个块 (按括号为单位) 来看上面的这个代码:</p>
<p>(阅读建议: 请不必对代码中的解释过于深究, 因为这不过是我自己的理解,
  不是 cltl2 的标准也不一定正确, 仅旨在给一个简单的认识)</p>
<ol>
  <li>最外层 <a href="http://clhs.lisp.se/Body/m_defun.htm">defun</a>: 定义一个叫作 <code>factorial</code> 的函数.
    <p>如果你使用的编辑器有 <a href="https://www.lispworks.com/documentation/lw50/CLHS/Body/03_d.htm">lambda-list</a> 提示的话,
      你可以看到 <code>defun</code> 对应的提示如下: <code>(defun name lambda-list &amp;body body)</code>.</p>
    <ul>
      <li><code>name</code> 在这里对应的是函数名称 <code>factorial</code>.
        <p>也就是我们要定义一个叫作 <code>factorial</code> 名字的函数.</p>
     <details><summary>Tips: 以防你遇到一些小小问题</summary>
        <ul>
          <li>这里说 &#8220;名字&#8221; 其实并不是很准确, 更应该算是一个符号 (symbol)</li>
          <li>在 CL 中, 一般来说我们并不对符号的大小写做区分,
            所以如果你又想要定义一个这样的函数: <code>FaCtoriaL</code>,
            实际上 CL 会将其和 <code>factorial</code> 相等价的.
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">eq</span><span class="w"> </span><span class="ss">&#39;FaCtorial</span><span class="w"> </span><span class="ss">&#39;factorial</span><span class="p">)</span><span class="w"> </span><span class="c1">;; =&gt; t ;; `t&#39; 或者非 `nil&#39; 在 CL 中表示真</span>
</pre></div>
          </li>
          <li>那么难道就不能对大小写进行区分了吗? 可以, 但是没有必要.
            比如你可以用 <code>|FaCtoriaL|</code> 的形式来写, 只是不建议这样.
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">eq</span><span class="w"> </span><span class="ss">&#39;|FaCtoriaL|</span><span class="w"> </span><span class="ss">&#39;factorial</span><span class="p">)</span><span class="w"> </span><span class="c1">;; =&gt; nil ;; `nil&#39; 在 CL 中表示否</span>
</pre></div>
          </li>
        </ul>
     </details>
      </li>
      <li><code>lambda-list</code> 在这里对应的是 <code>(n)</code>, 也就是一个输入的变量列表.
        <p>自然地, 你可以构造多变量的输入参数:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">factorial</span><span class="w"> </span><span class="p">(</span><span class="nf">n</span><span class="w"> </span><span class="nv">product</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nf">zerop</span><span class="w"> </span><span class="nv">n</span><span class="p">)</span>
<span class="w">      </span><span class="nv">product</span>
<span class="w">      </span><span class="p">(</span><span class="nf">factorial</span><span class="w"> </span><span class="p">(</span><span class="nb">1-</span><span class="w"> </span><span class="nv">n</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="nv">n</span><span class="w"> </span><span class="nv">product</span><span class="p">))))</span>
</pre></div>
        <p>我们可以通过跟踪函数的调用 (通过 <code>(trace factorial)</code> 来实现)
          来对输入的参数有一个比较直观的认识:</p>
        <pre class="example">
0: (FACTORIAL 5 1)
  1: (FACTORIAL 4 5)
    2: (FACTORIAL 3 20)
      3: (FACTORIAL 2 60)
        4: (FACTORIAL 1 120)
          5: (FACTORIAL 0 120)
          5: factorial returned 120
        4: factorial returned 120
      3: factorial returned 120
    2: factorial returned 120
  1: factorial returned 120
0: factorial returned 120
        </pre>
     <details><summary>假如你是一个注重性能的 C 程序员&#8230; </summary>是这样的, 递归可能性能上会有一些的损失, 栈的维护和开销确实是个问题.
        <p>(但是假如你就是个拿来主义的物理系学生, 并且你的电脑不至于是上古电脑,
          那么大可不必担心, CL 至少跑的速度是不慢的 (相比 C/C++/Rust)).</p>
        <p>但是如果你要说真的是递归吗? 其实也不必然, 通过指定 <code>optimize</code> 的优化水平,
          以及依靠编译器大爹的尾递归优化, 出来的结果其实和写循环是差不多的.</p>
        <p>并且很多时候, 物理系的计算在公式上的优化 (对, 没错,
          就是把数学系同学最爱的公式严谨性和简单优美性抛开,
          然后进行各种随意的舍去和消减), 一般都会比计算机系在算法,
          数据结构上面的优化要稍微强那么一些.</p>
        <p>(比如在计算 <a href="https://github.com/li-yiyang/com-phy/blob/bb38d518764ae6c9facbfc5652a423acac4f11f2/monte-carlo.lisp#L120">pairwise potential</a> 的时候, 用 C++ (+ 调库) 的同学甚至还不如我快&#8230;
          当然, 代码不一样肯定是没法比的&#8230; )</p>
     </details>
      </li>
      <li><code>&amp;body body</code>: 在这里对应的是函数体的代码.
        <p>这个 <code>&amp;body</code> 标记表示输入的剩余部分都是 <code>body</code> 的内容.</p>
      </li>
    </ul>
  </li>
  <li>=&#8221;Evaluates &#8230;&#8221;=: 用双引号包裹的东西是字符串.
    <p><del>一个安心事实是, CL 里面没有单双引号的圣战.</del></p>
  </li>
  <li><code>(assert test-form)</code>: 这个语句会对表达式的结果 <code>(&gt; n 0)</code> 进行判断,
    若不成立则会报错.
    <p>不过这里的重点还是 <code>(&gt; n 0)</code>, 也就是一个表达式,
      当符号 <code>n</code> 对应的值大于 <code>0</code> 时, 返回真 (<code>t</code>), 否则为假 (<code>nil</code>).</p>
    <p>在 CL 中, 所有的表达式都有一个返回值.</p>
  </li>
  <li><code>(let bindings &amp;body body)</code>: 进行局部赋值.
    <ul>
      <li><code>bindings</code> 为一个列表, 其中的元素的形式可以类似于 <code>(变量名 变量值表达式)</code>.</li>
      <li>所谓的局部赋值, 就是在 <code>bindings</code> 中声明的变量名的绑定仅在 <code>let</code> 的 <code>body</code> 中有效.
        于是你可以做到类似如下的形式:
<div class="highlight"><pre><span></span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nf">a</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="nf">print</span><span class="w"> </span><span class="nv">a</span><span class="p">)</span><span class="w">                 </span><span class="c1">; =&gt; 1</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nf">a</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nf">print</span><span class="w"> </span><span class="nv">a</span><span class="p">))</span><span class="w">   </span><span class="c1">; =&gt; 2</span>
<span class="w">  </span><span class="p">(</span><span class="nf">print</span><span class="w"> </span><span class="nv">a</span><span class="p">))</span><span class="w">                </span><span class="c1">; =&gt; 1</span>
</pre></div>
     <details><summary>Advanced: Closures 闭包</summary>
        <p>直观地认识这个值的局域性其实是非常简单的.
          毕竟语法上的括号就是值的作用范围.</p>
        <p>(这里留个坑, 感觉现在讲得不是很好, 可以看 Let Over Lambda,
          或者等我之后读完了之后写的笔记, 至少关键词是 closure).</p>
     </details>
      </li>
    </ul>
  </li>
  <li><code>(dotimes (var count &amp;optional result) &amp;body body)</code>: 重复 <code>n</code> 次.
    <p>重复过程中的变量为 <code>i</code>, 最后返回 <code>result</code>, 也就是 <code>n-factorial</code>.</p>
    <p>这里的 <code>&amp;optional</code> 表示后面跟着的参数都是可选的参数, 假如不填的话默认为 <code>nil</code>.</p>
  </li>
  <li><code>(setf &amp;rest args)</code>: 表示赋值.
    <p>比如上面的就是把符号 <code>n-factorial</code> 的值设为 <code>(* n-factorial (1+ i))</code> 的计算结果,
      这里 <code>1+</code> 等价于 <code>(+ 1 i)</code>.</p>
    <p>其中 <code>&amp;rest args</code> 表示后面的所有的参数都会被当作 <code>args</code> 来处理.</p>
  </li>
</ol>
<p>OK, 现在基本上你可以去读任何的 CL 代码了. (bushi)</p>
<details><summary>Advanced: 一些 CL 的错误处理机制</summary>
<p>其实如果不考虑错误处理的话 (就是上面代码的 <code>assert</code> 部分),
  整个代码就会更简单, 但是如果只是这样加上了这个错误处理,
  其实还不是什么比较有意思的东西, 你还可以用 <code>restart-case</code>
  的机制来实现一些类似 <code>try ... rescue</code> 的操作,
  但是这个的可行性和互动性就比较多了:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">factorial</span><span class="w"> </span><span class="p">(</span><span class="nf">n</span><span class="p">)</span>
<span class="w">  </span><span class="s">&quot;Evaluates n! = 1 * 2 * ... * (n - 1) * n&quot;</span>
<span class="w">  </span><span class="p">(</span><span class="nf">restart-case</span>
<span class="w">      </span><span class="p">(</span><span class="nf">progn</span><span class="w"> </span><span class="p">(</span><span class="nf">assert</span><span class="w"> </span><span class="p">(</span><span class="nb">&gt;</span><span class="w"> </span><span class="nv">n</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
<span class="w">             </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nf">n-factorial</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<span class="w">               </span><span class="p">(</span><span class="nf">dotimes</span><span class="w"> </span><span class="p">(</span><span class="nf">i</span><span class="w"> </span><span class="nv">n</span><span class="w"> </span><span class="nv">n-factorial</span><span class="p">)</span>
<span class="w">                 </span><span class="p">(</span><span class="nf">setf</span><span class="w"> </span><span class="nv">n-factorial</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="nv">n-factorial</span><span class="w"> </span><span class="p">(</span><span class="nb">1+</span><span class="w"> </span><span class="nv">i</span><span class="p">))))))</span>
<span class="w">    </span><span class="c1">;; 根据用户的不同输入进行错误处理</span>
<span class="w">    </span><span class="p">(</span><span class="nf">return-zero</span><span class="w"> </span><span class="p">()</span>
<span class="w">      </span><span class="nv">:report</span><span class="w"> </span><span class="s">&quot;Return result = 0.&quot;</span>
<span class="w">      </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nf">use-value</span><span class="w"> </span><span class="p">(</span><span class="nf">fix-n</span><span class="p">)</span>
<span class="w">      </span><span class="nv">:report</span><span class="w"> </span><span class="s">&quot;Use another n for n!. &quot;</span>
<span class="w">      </span><span class="nv">:interactive</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="nb">read</span><span class="p">)))</span><span class="w"> </span><span class="c1">;; 可以重新绑定 `n&#39; 的值</span>
<span class="w">      </span><span class="p">(</span><span class="nf">factorial</span><span class="w"> </span><span class="nv">fix-n</span><span class="p">))</span>
<span class="w">    </span><span class="p">(</span><span class="nf">use-abs</span><span class="w"> </span><span class="p">()</span>
<span class="w">      </span><span class="nv">:report</span><span class="w"> </span><span class="s">&quot;Use n = |n|. &quot;</span>
<span class="w">      </span><span class="p">(</span><span class="nf">factorial</span><span class="w"> </span><span class="p">(</span><span class="nb">abs</span><span class="w"> </span><span class="nv">n</span><span class="p">)))))</span>
</pre></div>
<p>这一步完全是可交互的错误处理机制, 对于在调试算法/运行大量计算的时候,
  可能仅仅只是有几个小例外 (用物理的说法就是, 误差范围内的涨落),
  单独写自动化程序去剔除也太麻烦了 (也不是不行, 见下文),
  这种手动的错误处理其实是很香的.</p>
<p>自动化的处理的类型:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">handler-case</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">division-by-zero</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
</pre></div>
</details>
<h3>Basic II</h3>
<h2>模拟考试 writeUP</h2>
<h3>Number and Precision</h3>
<ol>
  <li>What floating-point values do the following 32-bit strings encode?
    <ul>
      <li><code>01000000000000000000000000000000</code>: <code>2.0</code>
        <p>特征: 符号位 <code>0</code> 正数, 指数位第一位为 <code>1</code>, 其余为 <code>0</code>.
          又: <code>11000000000000000000000000000000</code> 为 <code>-2.0</code>.</p>
      </li>
      <li><code>10111111100000000000000000000000</code>: <code>-1.0</code>
        <p>特征: 符号位 <code>1</code> 负数, 指数位除第一位填满, 分数位为空.
          又: <code>00111111100000000000000000000000</code> 为 <code>1.0</code>.</p>
      </li>
      <li><code>01111111101010111001001001110110</code>: <code>NaN</code>
        <p>特征: 指数位全 <code>1</code>, 分数位非全 <code>1</code></p>
      </li>
      <li><code>10111101110011001100110011001101</code>: <code>-0.1</code>
        <p>嗯算&#8230;</p>
      </li>
    </ul>
  </li>
  <li>\(sin (x + y) - sin x\): \(y &rarr; 0\) 会有小量误差</li>
  <li>\(sin (x + y) - sin x = y cos x\) 使用 Taylor 展开消除误差</li>
  <li><code>0.1 + 0.1 + 0.1 == 0.3</code> 在 Python 中的返回结果为 <code>False</code>.</li>
</ol>
<h3>Numerical Calculus</h3>
<table>
  <tr><th>time / s</th><th>0.0</th><th>0.5</th><th>1.0</th><th>1.5</th><th>2.0</th><th>2.5</th><th>3.0</th><th>3.5</th><th>4.0</th></tr>
  <tr><td>speed / m s^-1</td><td>0.00</td><td>4.83</td><td>9.27</td><td>13.05</td><td>16.06</td><td>18.32</td><td>19.97</td><td>21.13</td><td>21.92</td></tr>
</table>
<ol>
  <li>\(t = 4.0 \mathrm{s}\) 的加速度, 且要求误差分别为 1, 2 阶的 \(&Delta; t\)
    <ul>
      <li>\(o(&Delta; t)\): first backward: \(a(4.0) = \frac{v(4.0) - v(3.5)}{0.5} = 1.58\)</li>
      <li>\(o((&Delta; t)^2)\) 对应 \(\{-2h, -h, 0\}\) 的取点, 即
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">make-finite-differentor-matrix</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="mi">-2</span><span class="w"> </span><span class="mi">-1</span><span class="p">))</span>
</pre></div>
        <pre class="example">
#2A((1.5d0 0.5d0 -2.0d0) (0.5d0 0.5d0 -1.0d0))
        </pre>
        <p>\[f'(x) = \left[ \frac{3}{2} f(x) + \frac{1}{2} f(x-2h) - 2 f(x-h) \right] / h &rArr; a(4.0) = 1.21\]</p>
      </li>
    </ul>
  </li>
  <li>积分移动距离
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">n-reduce</span><span class="w"> </span><span class="p">(</span><span class="nf">n</span><span class="w"> </span><span class="nv">function</span><span class="w"> </span><span class="nv">sequence</span><span class="w"> </span><span class="nv">&amp;key</span><span class="w"> </span><span class="p">(</span><span class="nf">initial-value</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="nv">sequence</span><span class="p">)</span><span class="w"> </span><span class="nv">n</span><span class="p">)</span><span class="w"> </span><span class="nv">initial-value</span>
<span class="w">      </span><span class="p">(</span><span class="nf">n-reduce</span><span class="w"> </span><span class="nv">n</span><span class="w"> </span><span class="nv">function</span><span class="w"> </span><span class="p">(</span><span class="nf">nthcdr</span><span class="w"> </span><span class="p">(</span><span class="nb">1-</span><span class="w"> </span><span class="nv">n</span><span class="p">)</span><span class="w"> </span><span class="nv">sequence</span><span class="p">)</span>
<span class="w">                </span><span class="nv">:initial-value</span>
<span class="w">                </span><span class="p">(</span><span class="nb">apply</span><span class="w"> </span><span class="nv">function</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="nv">initial-value</span>
<span class="w">                                      </span><span class="p">(</span><span class="nf">subseq</span><span class="w"> </span><span class="nv">sequence</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nv">n</span><span class="p">))))))</span>
</pre></div>
    <ul>
      <li>Trapezium:
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">trapezium</span><span class="w"> </span><span class="p">(</span><span class="nf">sequence</span><span class="w"> </span><span class="nv">dh</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">n-reduce</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nf">sum</span><span class="w"> </span><span class="nv">fa</span><span class="w"> </span><span class="nv">fb</span><span class="p">)</span>
<span class="w">                </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="nv">sum</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="nv">fa</span><span class="w"> </span><span class="nv">fb</span><span class="p">)</span><span class="w"> </span><span class="nv">dh</span><span class="p">)</span><span class="w"> </span><span class="mi">2</span><span class="p">)))</span>
<span class="w">            </span><span class="nv">sequence</span><span class="p">))</span>

<span class="p">(</span><span class="nf">trapezium</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="mf">0.00</span><span class="w"> </span><span class="mf">4.83</span><span class="w"> </span><span class="mf">9.27</span><span class="w"> </span><span class="mf">13.05</span><span class="w"> </span><span class="mf">16.06</span><span class="w"> </span><span class="mf">18.32</span><span class="w"> </span><span class="mf">19.97</span><span class="w"> </span><span class="mf">21.13</span><span class="w"> </span><span class="mf">21.92</span><span class="p">)</span><span class="w"> </span><span class="mf">0.5</span><span class="p">)</span><span class="w"> </span><span class="c1">;; =&gt; 56.795</span>
</pre></div>
        <p>注意到求和的时候可以手动合并, 手算的时候可以加速计算.</p>
      </li>
      <li>Simpson:
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">simpson</span><span class="w"> </span><span class="p">(</span><span class="nf">sequence</span><span class="w"> </span><span class="nv">dh</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">n-reduce</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nf">sum</span><span class="w"> </span><span class="nv">fa</span><span class="w"> </span><span class="nv">fa+b/2</span><span class="w"> </span><span class="nv">fb</span><span class="p">)</span>
<span class="w">                </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="nv">sum</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="nv">dh</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="nv">fa</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="nv">fa+b/2</span><span class="p">)</span><span class="w"> </span><span class="nv">fb</span><span class="p">))</span><span class="w"> </span><span class="mi">3</span><span class="p">)))</span>
<span class="w">            </span><span class="nv">sequence</span><span class="p">))</span>

<span class="p">(</span><span class="nf">simpson</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="mf">0.00</span><span class="w"> </span><span class="mf">4.83</span><span class="w"> </span><span class="mf">9.27</span><span class="w"> </span><span class="mf">13.05</span><span class="w"> </span><span class="mf">16.06</span><span class="w"> </span><span class="mf">18.32</span><span class="w"> </span><span class="mf">19.97</span><span class="w"> </span><span class="mf">21.13</span><span class="w"> </span><span class="mf">21.92</span><span class="p">)</span><span class="w"> </span><span class="mf">0.5</span><span class="p">)</span><span class="w"> </span><span class="c1">;; =&gt; 56.9733</span>
</pre></div>
      </li>
    </ul>
  </li>
</ol>
<h3>Equation Solving and Optimisation</h3>
<p>运动方程:</p>
<p>\[y(t) / \mathrm{m} = 57 - \frac{v_{\mathrm{ter}}^2}{g} log \left( cosh (\frac{g t}{v_{\mathrm{ter}}}) \right)\]</p>
<ol>
  <li>q-convergence 的定义:
    <p>\[lim_{k &rarr; &infin;} \frac{| &epsilon;_{k+1} |}{| &epsilon;_k |^q} = &mu;\]</p>
  </li>
  <li>Newton-Raphson 迭代公式:
    <p>\[x_{k+1} = x_k - \frac{f(x_k)}{f'(x_k)}\]</p>
  </li>
  <li>使用 Newton Raphson 计算落地时刻:
    <p>求导得到 \(y'(t) = - \frac{v_{\mathrm{ter}}^2}{g} \left( \frac{g tanh \frac{g t}{v_{\mathrm{ter}}}}{v_{\mathrm{ter}}} \right)\)</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nf">g</span><span class="w"> </span><span class="mf">9.8</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nf">v-ter</span><span class="w"> </span><span class="mi">55</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="nf">flet</span><span class="w"> </span><span class="p">((</span><span class="nf">square</span><span class="w"> </span><span class="p">(</span><span class="nf">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">x</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="nf">newton-raphson-solve</span>
<span class="w">     </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nf">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="mi">57</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="p">(</span><span class="nf">square</span><span class="w"> </span><span class="nv">v-ter</span><span class="p">)</span><span class="w"> </span><span class="nv">g</span><span class="p">)</span>
<span class="w">                          </span><span class="p">(</span><span class="nb">log</span><span class="w"> </span><span class="p">(</span><span class="nb">cosh</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="nv">g</span><span class="w"> </span><span class="nv">x</span><span class="p">)</span><span class="w"> </span><span class="nv">v-ter</span><span class="p">))))))</span>
<span class="w">     </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nf">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="p">(</span><span class="nf">square</span><span class="w"> </span><span class="nv">v-ter</span><span class="p">)</span><span class="w"> </span><span class="nv">g</span><span class="p">)</span>
<span class="w">                    </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="nv">g</span><span class="w"> </span><span class="nv">v-ter</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">tanh</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="nv">g</span><span class="w"> </span><span class="nv">x</span><span class="p">)</span><span class="w"> </span><span class="nv">v-ter</span><span class="p">)))))</span>
<span class="w">     </span><span class="mf">1.0</span><span class="p">)))</span><span class="w"> </span><span class="c1">;; =&gt; 3.5165417</span>
</pre></div>
  </li>
  <li>描述找到多元函数局部最小值的一个算法
    <p>Gradient Decent:</p>
  </li>
  <li>关于全局极值的说法, 判断正确与否:
    <ul>
      <li>We can <b>never</b> be sure we have found the global minimum of a function [False]
        <p>(意思是说某些函数是可以证明的么)</p>
      </li>
      <li>In general, we cannot prove we have found the global minimum of a function [True]
        <p>是这样的</p>
      </li>
      <li>Basin-hopping global optimisation employs the Metropolis criterion
        in order to ensure sampling of the canonical distribution. [False]
        <p>否, 此处的 Metropolis 和 Monte Carlo 中的毫无关系 (因为过了一次局部求最小值? )</p>
      </li>
      <li>In basin-hopping global optimisation, the Metropolis criterion is one
        of many possible criteria for determining whether to accept or reject
        a new configuration. [True]</li>
      <li>Basin-hopping global optimisation will always find the global minimum of a
        function in a <b>finite time</b>. [False]</li>
    </ul>
  </li>
</ol>
<h3>Differential Equations</h3>
<ol>
  <li>将迭代公式和名称进行对应:
    <table>
      <tr><td>Runge Kutta</td><td>\(x_{n+1} = x_n + &Delta; t F(x_n + \frac{1}{2} F(x_n) &Delta; t)\)</td></tr>
      <tr><td>Forward Eular</td><td>\(x_{n+1} = x_n + F(x_n) &Delta; t\)</td></tr>
      <tr><td>Backward Eular</td><td>\(x_{n+1} = x_n + F(x_{n+1}) &Delta; t\)</td></tr>
    </table>
  </li>
  <li>将具体的 \(F\) 的公式代入, 并判断 <b>稳定性</b>:</li>
  <li>将偏微分方程的迭代公式和具体的格点形式对应:</li>
</ol>
<h3>Simulations</h3>
<ol>
  <li>描述 2-D Ising 模型的 MC 算法</li>
  <li>判断说法的正确与否:
    <ul>
      <li>In MC, we always accept trial moves that result in a lower energy [True]</li>
      <li>The probability of rejecting a test move in MC is always less than <code>0.513</code> [False]</li>
      <li>In MD, we solve Newton's equations of motion, therefore we always predict
        correct physical trajectories of the system for arbitrary times. [False]
        <p>解 Newton 方程是对的, 但是随着时间的增长, 误差会累积.</p>
      </li>
      <li></li>
    </ul>
  </li>
</ol>
<h1>后记</h1>
<p>老师考前: 我们觉得模拟试卷出得太简单了, 所以我们上强度了.</p>
<p>考后: 大家都绷不住笑了&#8230; 根本做不完, 更别说做得来了.</p>
<p><del>怎么会有考前上强度的&#8230;</del></p>

  </div><a class="u-url" href="/learning/computational-physics/" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">My Blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">My Blog</li><li><a class="u-email" href="mailto:thebigbigwordl@qq.com">thebigbigwordl@qq.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/li-yiyang"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">li-yiyang</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>某不知名的很硬的双非学校的物理系学生的无聊博客</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
