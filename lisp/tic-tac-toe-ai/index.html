<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>TicTacToe AI | My Blog</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="TicTacToe AI" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="About 接下来几天, 我要进行一个 Blog 大产出 (注水), 回复 @sikesibian 对我近来博客没啥好活的质疑. 首先这一次关于是我最近做的 cl-webview 的一个简单的应用的例子, 配合之前看了一部分的 Common Lisp Modules 的 Part II 的一些简单知识. 灵感来源于跳蚤群里的一个学弟/妹的计算机科学导论大作业. (就让学弟/妹们看看考完试的学长可以有多么浪吧) (浪不了一点&#8230; 实验室里打工真快乐) 那么 CL Modules 的 Part II 哪里去了呢? 很遗憾, 答案是因为我发现书里面的模型其实已经非常老旧, 加上那段时间在忙着写 GURAFU 的代码 (主要是为了满足计算物理的论文), 原始的阅读笔记被改得乱七八糟, 估计之后重新阅读的时候可以考虑再写一个. 这部分我把它塞到了文章的后面. (defpackage #:tictactoe (:use :cl :cl-webview) (:export #:run-tictactoe))" />
<meta property="og:description" content="About 接下来几天, 我要进行一个 Blog 大产出 (注水), 回复 @sikesibian 对我近来博客没啥好活的质疑. 首先这一次关于是我最近做的 cl-webview 的一个简单的应用的例子, 配合之前看了一部分的 Common Lisp Modules 的 Part II 的一些简单知识. 灵感来源于跳蚤群里的一个学弟/妹的计算机科学导论大作业. (就让学弟/妹们看看考完试的学长可以有多么浪吧) (浪不了一点&#8230; 实验室里打工真快乐) 那么 CL Modules 的 Part II 哪里去了呢? 很遗憾, 答案是因为我发现书里面的模型其实已经非常老旧, 加上那段时间在忙着写 GURAFU 的代码 (主要是为了满足计算物理的论文), 原始的阅读笔记被改得乱七八糟, 估计之后重新阅读的时候可以考虑再写一个. 这部分我把它塞到了文章的后面. (defpackage #:tictactoe (:use :cl :cl-webview) (:export #:run-tictactoe))" />
<link rel="canonical" href="/lisp/tic-tac-toe-ai/" />
<meta property="og:url" content="/lisp/tic-tac-toe-ai/" />
<meta property="og:site_name" content="My Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-06-30T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="TicTacToe AI" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-06-30T00:00:00+00:00","datePublished":"2024-06-30T00:00:00+00:00","description":"About 接下来几天, 我要进行一个 Blog 大产出 (注水), 回复 @sikesibian 对我近来博客没啥好活的质疑. 首先这一次关于是我最近做的 cl-webview 的一个简单的应用的例子, 配合之前看了一部分的 Common Lisp Modules 的 Part II 的一些简单知识. 灵感来源于跳蚤群里的一个学弟/妹的计算机科学导论大作业. (就让学弟/妹们看看考完试的学长可以有多么浪吧) (浪不了一点&#8230; 实验室里打工真快乐) 那么 CL Modules 的 Part II 哪里去了呢? 很遗憾, 答案是因为我发现书里面的模型其实已经非常老旧, 加上那段时间在忙着写 GURAFU 的代码 (主要是为了满足计算物理的论文), 原始的阅读笔记被改得乱七八糟, 估计之后重新阅读的时候可以考虑再写一个. 这部分我把它塞到了文章的后面. (defpackage #:tictactoe (:use :cl :cl-webview) (:export #:run-tictactoe))","headline":"TicTacToe AI","mainEntityOfPage":{"@type":"WebPage","@id":"/lisp/tic-tac-toe-ai/"},"url":"/lisp/tic-tac-toe-ai/"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css">

  <style type="text/css">
    img {
      margin-left: auto; 
      margin-right:auto; 
      display:block;
    }
  </style><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="My Blog" /><script>
  document.addEventListener("DOMContentLoaded", function() {
      renderMathInElement(document.body, {
        // customised options
        // • auto-render specific keys, e.g.:
        delimiters: [
            {left: '$$', right: '$$', display: true},
            {left: '$', right: '$', display: false},
            {left: '\\(', right: '\\)', display: false},
            {left: '\\[', right: '\\]', display: true}
        ],
        // • rendering keys, e.g.:
        throwOnError : false
      });
  });
</script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.23/dist/katex.min.css" integrity="sha384-z91AFMXXGZasvxZz5DtKJse3pKoTPU0QcNFj/B4gDFRmq6Q2bi1StsT7SOcIzLEN" crossorigin="anonymous">

<!-- The loading of KaTeX is deferred to speed up page rendering -->
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.23/dist/katex.min.js" integrity="sha384-Af7YmksQNWRLMvro3U9F84xa0paoIu7Pu2niAIUmZoI09Q4aCsbha5dvaj1tHy6K" crossorigin="anonymous"></script>

<!-- To automatically render math in text elements, include the auto-render extension: -->
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.23/dist/contrib/auto-render.min.js" integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"
        onload="renderMathInElement(document.body);"></script>
</head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">My Blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a><a class="page-link" href="/categories/">Categories</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">TicTacToe AI</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2024-06-30T00:00:00+00:00" itemprop="datePublished">Jun 30, 2024
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <h1>About</h1>
<p>接下来几天, 我要进行一个 Blog 大产出 (<del>注水</del>),
  回复 <a href="https://sikesibian.tech/">@sikesibian</a> 对我近来博客没啥好活的质疑.</p>
<p>首先这一次关于是我最近做的 <a href="https://github.com/li-yiyang/cl-webview">cl-webview</a> 的一个简单的应用的例子,
  配合之前看了一部分的 Common Lisp Modules 的 Part II 的一些简单知识.
  灵感来源于跳蚤群里的一个学弟/妹的计算机科学导论大作业.</p>
<p><del>(就让学弟/妹们看看考完试的学长可以有多么浪吧)</del></p>
<p>(浪不了一点&#8230; 实验室里打工真快乐)</p>
<details><summary>那么 CL Modules 的 Part II 哪里去了呢? </summary>
<p>很遗憾, 答案是因为我发现书里面的模型其实已经非常老旧,
  加上那段时间在忙着写 <a href="https://github.com/li-yiyang/gurafu">GURAFU</a> 的代码 (主要是为了满足计算物理的论文),
  原始的阅读笔记被改得乱七八糟, 估计之后重新阅读的时候可以考虑再写一个.</p>
<p>这部分我把它塞到了文章的后面.</p>
</details>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defpackage</span><span class="w"> </span><span class="kd">#:tictactoe</span>
<span class="w">  </span><span class="p">(</span><span class="nf">:use</span><span class="w"> </span><span class="nv">:cl</span><span class="w"> </span><span class="nv">:cl-webview</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">:export</span><span class="w"> </span><span class="kd">#:run-tictactoe</span><span class="p">))</span>

<span class="p">(</span><span class="nf">in-package</span><span class="w"> </span><span class="nv">:tictactoe</span><span class="p">)</span>
</pre></div>
<p>注: 我的代码应该写得还算注释清晰, 没有黑魔法的简单代码了, 欢迎入坑 Common Lisp.</p>
<h1>TicTacToe</h1>
<h2>游戏是个简单的状态机</h2>
<details><summary>啊, 和正文有些无关, 折叠了</summary>
<p>学过计算机科学导论的都应该对状态机非常熟悉了吧 (不熟悉的可以看:
  <a href="/ruby/turing-machine/">Make a Turing Machine Yourself</a>, 虽然是图灵机而不是状态机;
  关于为什么要学状态机, 除了体系结构以外, 在编译原理里也有应用:
  <a href="/misc/simple-regexp-for-parser/">A Simple Regexp for Parser</a>).</p>
<p>那么为什么会说游戏是个 &#8220;简单的&#8221; 状态机呢?</p>
<p>(以下参考: <a href="https://www.youtube.com/watch?v=N-dPDsLTrTE">GDC Tunes of the Kingdom: Evolving Physics and Sounds for ‘The Legend of Zelda: Tears of the Kingdom’ (youtube)</a>,
  在 b 站有人搬运和翻译, 可以搜索关键词: <code>GDC 塞尔达 王国之泪</code>)</p>
<p>在某个状态下, 由于用户做了某种事情而改变了状态: 比如你将炸弹花绑定到弓箭上,
  (有段时间没玩了, 考试嘛, 我记得会变红, 然后发出烟), 这里就有一个 &#8220;点燃&#8221;, &#8220;准备&#8221;
  的状态切换; 同时, 在不同的状态下, 需要去做不同的相应:
  比如你在死亡火山那边装备炸弹花&#8230; (强烈建议试试, 就是要小心会被偷袭 :p)</p>
<p>这里做的游戏都是一些简单的小游戏, 所以我们并不需要一个复杂的状态机机制.
  对于一些比较简单的状态机, 人力还是可以 handle 的, 你大可以做一个 Excel,
  然后把各种元素的相互关系做成一个相关矩阵, 然后进行人工跟踪.</p>
<p>但是复杂的状态机制呢? 一个想法就是写一个规则约束程序来进行辅助 (比如逻辑规约,
  我的一个想法就是引入 <a href="https://www.cs.utexas.edu/~moore/acl2/">ACL2</a> 这样的推理引擎来辅助; 或者是 <a href="https://github.com/sharplispers/ops5">OPS5</a>, <a href="https://www.isi.edu/websites/LOOM/">LOOM</a> 或者
  <a href="https://franz.com">Franz Knowledge Graph</a> 这样的专家系统). 不过在上面塞尔达的例子里面,
  开发者的做法是通过自己实现了一套物理模型 (物理规律) 以及声音渲染模型,
  来处理不同情况下的事件以及声音渲染. (规则约束)</p>
<p>也许你会说, 那么最近很火的 LLM 的 AI 呢? 能否被应用到这种方面呢?
  我觉得是可能的, 但是有一个问题: 站在玩家的角度, 我们并不需要知道游戏的背后究竟是什么,
  哪怕这个游戏的背后是几百个印度抠脚老哥在跟你聊天也无所谓, 只要足够好玩;
  而站在开发者角度, 我们需要的是一个可以快速实现原型, 快速开发修改迭代的工具/技术,
  哪怕是我上面提到的专家系统, 逻辑规约系统, 看起来都已经非常自动化了,
  但是实际上因为并没有对游戏开发流程进行优化 (不过我也并不知道是否真的有人/公司这么做),
  这么看来其实还是很缺乏吸引力的. 毕竟手算 \(1 + 1\) 就行了的问题,
  真的有必要引入一台计算机来帮忙吗?</p>
<p>叠甲: 并不是说技术并不重要, 比如渲染速度提高了, 玩家可以感知到, 这就是一种提升.
  但是一味地追求开发技术的提升, 而让游戏的迭代和设计变得死板而难以修改,
  就是一个比较大的缺憾了. (虽然我想说的是我目前也做不到这个事情, 只能说是以此为目标而已)</p>
<p>这里有一个我觉得完全是超帅的 demo: <a href="https://www.youtube.com/watch?v=72y2EC5fkcE">Tomorrow Corporation Tech Demo (youtube)</a>
  (在 b 站上貌似没有人搬运). 我觉得绝对是一个正确可学习的方向:</p>
<ul>
  <li>我们需要有一个对状态机转移的跟踪, 不仅可以步进, 还要可以步退
    <p>我觉得最帅的就是这个部分, 以下是我对该方法的一个可能的实现的一个想法:</p>
    <p>通过构造一个列表来记录已经历遍的状态, 就像是一个历史记录,
      然后这样就可以去回溯这个历史记录, 同时也可以更改节点去切换,
      进入一个新的状态节点.</p>
    <p>不过这部分我的想法还不是很完善, 之后有空可以试试往这个方向做点小玩具.</p>
  </li>
  <li>动态调试和动态重载的功能 (Lisp&#8230; )</li>
</ul>
</details>
<h2>井字棋核心的落子与控制代码</h2>
<p>(注: 在这里我会用 OOP 的方式来写代码, 不过需要注意的是,
  Common Lisp 是一个多范式的编程语言, 你完全可以用命令式的方法,
  或者函数式的方式来修改这段代码, 只是我觉得用 OOP 的方式非常适合)</p>
<p>在井字棋这个情况下, 需要保持的信息/状态有: 棋盘信息, 当前控制者.</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defclass</span><span class="w"> </span><span class="nv">tictactoe</span><span class="w"> </span><span class="p">()</span>
<span class="w">  </span><span class="p">(</span><span class="c1">;; 棋子的信息 (初始为空)</span>
<span class="w">   </span><span class="p">(</span><span class="nf">chessboard</span><span class="w"> </span><span class="nv">:initform</span><span class="w"> </span><span class="p">(</span><span class="nb">make-array</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="nv">:initial-element</span><span class="w"> </span><span class="nv">:empty</span><span class="p">))</span>
<span class="w">   </span><span class="c1">;; 当前的控制者 (初始为 `:red&#39; 红方)</span>
<span class="w">   </span><span class="p">(</span><span class="nf">player</span><span class="w">     </span><span class="nv">:initform</span><span class="w"> </span><span class="nv">:red</span><span class="w">  </span><span class="nv">:reader</span><span class="w"> </span><span class="nv">player</span><span class="p">)</span>
<span class="w">   </span><span class="c1">;; 游戏状态</span>
<span class="w">   </span><span class="p">(</span><span class="nf">status</span><span class="w">     </span><span class="nv">:initform</span><span class="w"> </span><span class="nv">:play</span><span class="w"> </span><span class="nv">:reader</span><span class="w"> </span><span class="nv">status</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="nf">:documentation</span><span class="w"> </span><span class="s">&quot;井字棋核心逻辑. &quot;</span><span class="p">))</span>
</pre></div>
<details><summary>假如你不了解 Common Lisp</summary>
<p>你可以参考一下我的 <a href="/learning/computational-physics/">计算物理</a> (的附录) 了解一些简单的 Common Lisp 语法.</p>
<p>在这里, 使用了 <code>(defclass direct-superclass direct-slots &amp;rest options)</code>
  这个声明类的宏:</p>
<ul>
  <li>我们定义了一个叫作 <code>tictactoe</code> 的类, 当我们要新建一个这个类的实例的时候,
    我们只需要 <code>(make-instance &#39;tictactoe)</code> 即可.</li>
  <li>在这里 <code>tictactoe</code> 类没有直接的父类, 我们可以认为是最根本的类,
    接下来的各种操作相关的类都是其的子类</li>
  <li>其中 <code>chessboard</code>, <code>player</code>, <code>status</code> 为类的实例的变量,
    每个实例都有相同名字的实例变量, 但是这些实例变量对应的值随着不同的实例而变化.</li>
  <li>在声明实例变量的时候 <code>:initform</code> 表示初始缺省值; <code>:reader</code> 会构造一个读值函数,
    于是你可以通过 <code>(player tictactoe)</code> 来读取 <code>(slot-value tictactoe &#39;player)</code>.</li>
</ul>
<details><summary>等等, 假如上面的词汇对你来说有点陌生, 你可能需要了解一点 OOP</summary>
<p>很遗憾, 我没法给出一个让我接受的描述&#8230; 毕竟我也没有对象.</p>
<p>还请自行查找关键词 &#8220;面向对象编程&#8221;. 这里是一个简单的说明,
  以及对于 Common Lisp 的 OOP 的一个小小补充:</p>
<p>子类可以继承父类的方法, 也可以覆写父类的方法. 很常见吧.
  比如鸟类都会飞, 鸡是鸟的子类, 所以鸡也有飞这个方法.</p>
<p>但是如果子类的方法是父类方法的修改呢? 比如对于鸡来说,
  飞需要在父类飞的方法的基础上先起跳:</p>
<div class="highlight"><pre><span></span><span class="c1"># Ruby Code Example</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Chicken</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="no">Bird</span>
<span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">fly</span>
<span class="w">    </span><span class="n">jump</span>
<span class="w">    </span><span class="k">super</span>
<span class="w">  </span><span class="k">end</span>
<span class="k">end</span>
</pre></div>
<p>在 Common Lisp (CLOS) 中, 你可以使用 <code>:before</code> 修饰词:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defmethod</span><span class="w"> </span><span class="nv">fly</span><span class="w"> </span><span class="p">((</span><span class="nf">obj</span><span class="w"> </span><span class="nv">bird</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="nf">let-the-brid-fly-code</span><span class="w"> </span><span class="nv">obj</span><span class="p">))</span>

<span class="p">(</span><span class="nf">defmethod</span><span class="w"> </span><span class="nv">fly</span><span class="w"> </span><span class="nv">:before</span><span class="w"> </span><span class="p">((</span><span class="nf">obj</span><span class="w"> </span><span class="nv">chicken</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="nf">jump</span><span class="w"> </span><span class="nv">obj</span><span class="p">))</span>
</pre></div>
<p>你可以将其理解为一种方法的组合. 类似的, 还有 <code>:after</code>,
  <code>:around</code> 这样的修饰词来提供不同方式的组合方法.
  比如 Python 中的 decorator:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">wrap_in_tag</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&lt;div&gt;&quot;</span><span class="p">)</span>
    <span class="n">fn</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&lt;/div&gt;&quot;</span><span class="p">)</span>

<span class="nd">@wrap_in_tag</span>
<span class="k">def</span> <span class="nf">para</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</pre></div>
<p>就可以用 CLOS 中的 <code>:around</code> 来实现:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defmethod</span><span class="w"> </span><span class="nv">para</span><span class="w"> </span><span class="p">(</span><span class="nf">text</span><span class="w"> </span><span class="nv">stream</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">print</span><span class="w"> </span><span class="nv">text</span><span class="p">))</span>

<span class="p">(</span><span class="nf">defmethod</span><span class="w"> </span><span class="nv">para</span><span class="w"> </span><span class="nv">:around</span><span class="w"> </span><span class="p">(</span><span class="nf">text</span><span class="w"> </span><span class="nv">stream</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">declare</span><span class="w"> </span><span class="p">(</span><span class="nf">ignore</span><span class="w"> </span><span class="nv">text</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="nf">print</span><span class="w"> </span><span class="s">&quot;&lt;div&gt;&quot;</span><span class="w"> </span><span class="nv">stream</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">call-next-method</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">print</span><span class="w"> </span><span class="s">&quot;&lt;/div&gt;&quot;</span><span class="w"> </span><span class="nv">stream</span><span class="p">))</span>
</pre></div>
<p>当然, 我更加喜欢的用法是这样的:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defmethod</span><span class="w"> </span><span class="nv">para</span><span class="w"> </span><span class="nv">:around</span><span class="w"> </span><span class="p">((</span><span class="nf">text</span><span class="w"> </span><span class="nv">upper-style</span><span class="p">)</span><span class="w"> </span><span class="nv">stream</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">call-next-method</span><span class="w"> </span><span class="p">(</span><span class="nb">string-upcase</span><span class="w"> </span><span class="nv">text</span><span class="p">)</span><span class="w"> </span><span class="nv">stream</span><span class="p">))</span>
</pre></div>
<p>相当于对参数进行一个 wrap.</p>
</details>
</details>
<p>对于一个井字棋游戏, 最核心的基本操作应当为:</p>
<ul>
  <li>落子 <code>drop-chess</code>:
  <details><summary>具体的实现</summary>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defmethod</span><span class="w"> </span><span class="nv">drop-chess</span><span class="w"> </span><span class="p">((</span><span class="nf">game</span><span class="w"> </span><span class="nv">tictactoe</span><span class="p">)</span><span class="w"> </span><span class="nv">chess-id</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">with-slots</span><span class="w"> </span><span class="p">(</span><span class="nf">chessboard</span><span class="w"> </span><span class="nv">player</span><span class="p">)</span><span class="w"> </span><span class="nv">game</span>
<span class="w">    </span><span class="p">(</span><span class="k">when</span><span class="w"> </span><span class="p">(</span><span class="nf">eq</span><span class="w"> </span><span class="p">(</span><span class="nf">aref</span><span class="w"> </span><span class="nv">chessboard</span><span class="w"> </span><span class="nv">chess-id</span><span class="p">)</span><span class="w"> </span><span class="nv">:empty</span><span class="p">)</span><span class="w">  </span><span class="c1">; `chess-id&#39; 处为空</span>
<span class="w">      </span><span class="p">(</span><span class="nf">setf</span><span class="w"> </span><span class="p">(</span><span class="nf">aref</span><span class="w"> </span><span class="nv">chessboard</span><span class="w"> </span><span class="nv">chess-id</span><span class="p">)</span><span class="w"> </span><span class="nv">player</span><span class="p">))))</span><span class="w"> </span><span class="c1">; 在 `chess-id&#39; 处落子</span>
</pre></div>
  </details>
  </li>
  <li>交换控制方 <code>swap-player</code>:
  <details><summary>具体的实现</summary>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defmethod</span><span class="w"> </span><span class="nv">swap-player</span><span class="w"> </span><span class="p">((</span><span class="nf">game</span><span class="w"> </span><span class="nv">tictactoe</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="nf">with-slots</span><span class="w"> </span><span class="p">(</span><span class="nf">player</span><span class="p">)</span><span class="w"> </span><span class="nv">game</span>
<span class="w">    </span><span class="c1">;; 若当前为 `:red&#39; 则交换为 `:blue&#39; 反之亦然</span>
<span class="w">    </span><span class="p">(</span><span class="nf">setf</span><span class="w"> </span><span class="nv">player</span><span class="w"> </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nf">eq</span><span class="w"> </span><span class="nv">player</span><span class="w"> </span><span class="nv">:red</span><span class="p">)</span><span class="w"> </span><span class="nv">:blue</span><span class="w"> </span><span class="nv">:red</span><span class="p">))))</span>
</pre></div>
  </details>
  </li>
  <li>更新棋局状态 <code>update-status</code>:
  <details><summary>具体的实现</summary>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">%chessboard-status</span><span class="w"> </span><span class="p">(</span><span class="nf">chessboard</span><span class="p">)</span>
<span class="w">  </span><span class="s">&quot;根据 `chessboard&#39; 得到可能的状态. &quot;</span>
<span class="w">  </span><span class="c1">;; `flet&#39; 类似 `let&#39;, 前者绑定局部函数, 后者绑定局部变量</span>
<span class="w">  </span><span class="p">(</span><span class="nf">flet</span><span class="w"> </span><span class="p">((</span><span class="nf">line?</span><span class="w"> </span><span class="p">(</span><span class="nf">i</span><span class="w"> </span><span class="nv">j</span><span class="w"> </span><span class="nv">k</span><span class="p">)</span>
<span class="w">           </span><span class="c1">;; 判断坐标上的点的 grid 是否相同, 若相同, 返回相同的值</span>
<span class="w">           </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nf">value</span><span class="w"> </span><span class="p">(</span><span class="nb">reduce</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nf">a</span><span class="w"> </span><span class="nv">b</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nf">eq</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">b</span><span class="p">)</span><span class="w"> </span><span class="nv">a</span><span class="w"> </span><span class="nv">nil</span><span class="p">))</span>
<span class="w">                                </span><span class="p">(</span><span class="nf">mapcar</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nf">idx</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">aref</span><span class="w"> </span><span class="nv">chessboard</span><span class="w"> </span><span class="nv">idx</span><span class="p">))</span>
<span class="w">                                        </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="nv">j</span><span class="w"> </span><span class="nv">k</span><span class="p">)))))</span>
<span class="w">             </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">not</span><span class="w"> </span><span class="p">(</span><span class="nf">eq</span><span class="w"> </span><span class="nv">value</span><span class="w"> </span><span class="nv">:empty</span><span class="p">))</span><span class="w"> </span><span class="nv">value</span><span class="p">))))</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nf">full?</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="c1">;; 对非空 grid 计数并求和, 判断是否和为 9 (全填满)</span>
<span class="w">                    </span><span class="p">(</span><span class="nb">reduce</span><span class="w"> </span><span class="o">#</span><span class="ss">&#39;+</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="ss">&#39;list</span>
<span class="w">                                     </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nf">grid</span><span class="p">)</span>
<span class="w">                                       </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nf">eq</span><span class="w"> </span><span class="nv">grid</span><span class="w"> </span><span class="nv">:empty</span><span class="p">)</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<span class="w">                                     </span><span class="nv">chessboard</span><span class="p">))))</span>
<span class="w">          </span><span class="p">(</span><span class="nf">line?</span><span class="w"> </span><span class="p">(</span><span class="k">or</span>
<span class="w">                  </span><span class="c1">;; 横向相连</span>
<span class="w">                  </span><span class="p">(</span><span class="nf">line?</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">line?</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">line?</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span>
<span class="w">                  </span><span class="c1">;; 纵向相连</span>
<span class="w">                  </span><span class="p">(</span><span class="nf">line?</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">line?</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">7</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">line?</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span>
<span class="w">                  </span><span class="c1">;; 对角线相连</span>
<span class="w">                  </span><span class="p">(</span><span class="nf">line?</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">line?</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="mi">6</span><span class="p">))))</span>
<span class="w">      </span><span class="c1">;; 根据 `chessboard&#39; 返回状态</span>
<span class="w">      </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nf">eq</span><span class="w"> </span><span class="nv">line?</span><span class="w"> </span><span class="nv">:red</span><span class="p">)</span><span class="w">  </span><span class="nv">:red-win</span><span class="p">)</span>
<span class="w">            </span><span class="p">((</span><span class="nf">eq</span><span class="w"> </span><span class="nv">line?</span><span class="w"> </span><span class="nv">:blue</span><span class="p">)</span><span class="w"> </span><span class="nv">:blue-win</span><span class="p">)</span>
<span class="w">            </span><span class="p">(</span><span class="nf">full?</span><span class="w">            </span><span class="nv">:full</span><span class="p">)</span>
<span class="w">            </span><span class="p">(</span><span class="nf">t</span><span class="w">                </span><span class="nv">:play</span><span class="p">)))))</span>

<span class="p">(</span><span class="nf">defmethod</span><span class="w"> </span><span class="nv">update-status</span><span class="w"> </span><span class="p">((</span><span class="nf">game</span><span class="w"> </span><span class="nv">tictactoe</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="nf">with-slots</span><span class="w"> </span><span class="p">(</span><span class="nf">chessboard</span><span class="w"> </span><span class="nv">status</span><span class="p">)</span><span class="w"> </span><span class="nv">game</span>
<span class="w">    </span><span class="p">(</span><span class="nf">setf</span><span class="w"> </span><span class="nv">status</span><span class="w"> </span><span class="p">(</span><span class="nf">%chessboard-status</span><span class="w"> </span><span class="nv">chessboard</span><span class="p">))))</span>
</pre></div>
  </details>
  </li>
  <li>清空棋盘 <code>clear-board</code>:
  <details><summary>具体的实现</summary>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defmethod</span><span class="w"> </span><span class="nv">clear-board</span><span class="w"> </span><span class="p">((</span><span class="nf">game</span><span class="w"> </span><span class="nv">tictactoe</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="nf">with-slots</span><span class="w"> </span><span class="p">(</span><span class="nf">chessboard</span><span class="w"> </span><span class="nv">player</span><span class="w"> </span><span class="nv">status</span><span class="p">)</span><span class="w"> </span><span class="nv">game</span>
<span class="w">    </span><span class="p">(</span><span class="nf">loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="nv">below</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="p">(</span><span class="nf">setf</span><span class="w"> </span><span class="p">(</span><span class="nf">aref</span><span class="w"> </span><span class="nv">chessboard</span><span class="w"> </span><span class="nv">i</span><span class="p">)</span><span class="w"> </span><span class="nv">:empty</span><span class="p">))</span><span class="w"> </span><span class="c1">; 清空为 `:empty&#39;</span>
<span class="w">    </span><span class="p">(</span><span class="nf">setf</span><span class="w"> </span><span class="nv">player</span><span class="w"> </span><span class="p">(</span><span class="k">case</span><span class="w"> </span><span class="nv">status</span><span class="w">           </span><span class="c1">; 交换控制方, 输者先攻</span>
<span class="w">                   </span><span class="p">(</span><span class="nf">:red-win</span><span class="w">  </span><span class="nv">:blue</span><span class="p">)</span>
<span class="w">                   </span><span class="p">(</span><span class="nf">:blue-win</span><span class="w"> </span><span class="nv">:red</span><span class="p">)</span>
<span class="w">                   </span><span class="p">(</span><span class="nf">otherwise</span><span class="w"> </span><span class="nv">player</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="nf">setf</span><span class="w"> </span><span class="nv">status</span><span class="w"> </span><span class="nv">:play</span><span class="p">)))</span><span class="w">               </span><span class="c1">; 重置 `status&#39;</span>
</pre></div>
  </details>
  </li>
</ul>
<p>如上所示, 基本的基础操作已经完成了, 那么每次下子只需要:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">drop-chess</span><span class="w"> </span><span class="nv">game</span><span class="w"> </span><span class="nv">id</span><span class="p">)</span>
<span class="p">(</span><span class="nf">update-status</span><span class="w"> </span><span class="nv">game</span><span class="p">)</span>
<span class="p">(</span><span class="nf">swap-player</span><span class="w">  </span><span class="nv">game</span><span class="p">)</span>
</pre></div>
<p>是不是有点太麻烦了?</p>
<p>所以通过 CLOS 的 <code>:after</code>, <code>:around</code> 的机制, 可以将这些方法组合在一起:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defmethod</span><span class="w"> </span><span class="nv">drop-chess</span><span class="w"> </span><span class="nv">:around</span><span class="w"> </span><span class="p">((</span><span class="nf">game</span><span class="w"> </span><span class="nv">tictactoe</span><span class="p">)</span><span class="w"> </span><span class="nv">chess-id</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">with-slots</span><span class="w"> </span><span class="p">(</span><span class="nf">status</span><span class="p">)</span><span class="w"> </span><span class="nv">game</span>
<span class="w">    </span><span class="p">(</span><span class="k">when</span><span class="w"> </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nf">eq</span><span class="w"> </span><span class="nv">status</span><span class="w"> </span><span class="nv">:play</span><span class="p">)</span><span class="w">        </span><span class="c1">; 状态为 :play 时才可落子</span>
<span class="w">               </span><span class="p">(</span><span class="nf">call-next-method</span><span class="p">))</span><span class="w">      </span><span class="c1">; 可以落子 (落子结果非 nil)</span>
<span class="w">      </span><span class="p">(</span><span class="nf">update-status</span><span class="w"> </span><span class="nv">game</span><span class="p">)</span><span class="w">              </span><span class="c1">; 更新棋局状态</span>
<span class="w">      </span><span class="p">(</span><span class="nf">swap-player</span><span class="w">   </span><span class="nv">game</span><span class="p">))))</span><span class="w">           </span><span class="c1">; 交换控制方</span>
</pre></div>
<details><summary>以文本的形式输出游戏状态 (假如你不想使用 cl-webview 来交互的话)</summary>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defmethod</span><span class="w"> </span><span class="nv">print-object</span><span class="w"> </span><span class="nv">:after</span><span class="w"> </span><span class="p">((</span><span class="nf">game</span><span class="w"> </span><span class="nv">tictactoe</span><span class="p">)</span><span class="w"> </span><span class="nv">stream</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">with-slots</span><span class="w"> </span><span class="p">(</span><span class="nf">chessboard</span><span class="w"> </span><span class="nv">player</span><span class="w"> </span><span class="nv">status</span><span class="p">)</span><span class="w"> </span><span class="nv">game</span>
<span class="w">    </span><span class="p">(</span><span class="nb">format</span><span class="w"> </span><span class="nv">stream</span><span class="w"> </span><span class="s">&quot;~&amp; PLAYER: ~A, STATUS: ~A&quot;</span><span class="w"> </span><span class="nv">player</span><span class="w"> </span><span class="nv">status</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nf">loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="nv">row</span><span class="w"> </span><span class="nv">below</span><span class="w"> </span><span class="mi">3</span>
<span class="w">          </span><span class="k">do</span><span class="w"> </span><span class="p">(</span><span class="nb">format</span><span class="w"> </span><span class="nv">stream</span><span class="w"> </span><span class="s">&quot;~&amp;| &quot;</span><span class="p">)</span>
<span class="w">          </span><span class="k">do</span><span class="w"> </span><span class="p">(</span><span class="nf">loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="nv">col</span><span class="w"> </span><span class="nv">below</span><span class="w"> </span><span class="mi">3</span>
<span class="w">                   </span><span class="k">do</span><span class="w"> </span><span class="p">(</span><span class="nb">format</span><span class="w"> </span><span class="nv">stream</span><span class="w"> </span><span class="s">&quot;~A | &quot;</span>
<span class="w">                              </span><span class="p">(</span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="nf">aref</span><span class="w"> </span><span class="nv">chessboard</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="nv">row</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="nv">col</span><span class="p">))</span>
<span class="w">                                </span><span class="p">(</span><span class="nf">:empty</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="p">)</span>
<span class="w">                                </span><span class="p">(</span><span class="nf">:red</span><span class="w">   </span><span class="s">&quot;X&quot;</span><span class="p">)</span>
<span class="w">                                </span><span class="p">(</span><span class="nf">:blue</span><span class="w">  </span><span class="s">&quot;O&quot;</span><span class="p">)))))))</span>
</pre></div>
<p>效果如下:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nf">game</span><span class="w"> </span><span class="p">(</span><span class="nf">make-instance</span><span class="w"> </span><span class="ss">&#39;tictactoe</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="nf">dotimes</span><span class="w"> </span><span class="p">(</span><span class="nf">i</span><span class="w"> </span><span class="mi">50</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nf">drop-chess</span><span class="w"> </span><span class="nv">game</span><span class="w"> </span><span class="p">(</span><span class="nb">random</span><span class="w"> </span><span class="mi">9</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="nf">print</span><span class="w"> </span><span class="nv">game</span><span class="p">))</span>
</pre></div>
<pre class="example">

#&lt;TICTACTOE {70091FADE3}&gt;
 PLAYER: BLUE, STATUS: RED-WIN
| X | O |   | 
| X | O |   | 
| X | X | O |  
</pre>
</details>
<h2>cl-webview 的绘制以及事件的交互</h2>
<p>(注: 这里先不管美观与否, 总之就是上了再说)</p>
<p>使用 cl-webview 绘制界面的操作和 HTML+CSS+JS 的那一套流程是完全相同的,
  (可以参考: <a href="/jekyll/how-to-make-a-static-web/">How to Make a Website</a>). 这里通过 mixin 的方式添加 webview
  相关的功能:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defclass</span><span class="w"> </span><span class="nv">webview-mixin</span><span class="w"> </span><span class="p">()</span>
<span class="w">  </span><span class="p">(</span><span class="c1">;; 棋盘的尺寸</span>
<span class="w">   </span><span class="p">(</span><span class="nf">size</span><span class="w"> </span><span class="nv">:initform</span><span class="w"> </span><span class="mi">400</span>
<span class="w">         </span><span class="nv">:initarg</span><span class="w">  </span><span class="nv">:size</span>
<span class="w">         </span><span class="nv">:reader</span><span class="w">   </span><span class="nv">size</span><span class="p">)</span>
<span class="w">   </span><span class="c1">;; 控制组件的高度</span>
<span class="w">   </span><span class="p">(</span><span class="nf">control-height</span><span class="w"> </span><span class="nv">:initform</span><span class="w"> </span><span class="mi">100</span>
<span class="w">                   </span><span class="nv">:initarg</span><span class="w">  </span><span class="nv">:control-height</span>
<span class="w">                   </span><span class="nv">:reader</span><span class="w">   </span><span class="nv">control-height</span><span class="p">)</span>
<span class="w">   </span><span class="c1">;; webview 窗体</span>
<span class="w">   </span><span class="nv">webview</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">:documentation</span><span class="w"> </span><span class="s">&quot;绘制到 webview 窗体上的相关模块. &quot;</span><span class="p">))</span>
</pre></div>
<p>在 <code>webview-mixin</code> 中, 主要的工作有两个: 绘制, 以及绑定交互的事件.</p>
<p>对于绘制, 这里将输出的 HTML 分为两个部分, 一个是 <code>size * size</code> 的棋盘,
  另一个这是控制的按钮组件:</p>
<ol>
  <li>绘制棋盘 <code>dump-chessboard</code>:
   <details><summary>具体实现</summary>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defconstant</span><span class="w"> </span><span class="nv">+table-control-string+</span>
<span class="w">  </span><span class="s">&quot;&lt;td style=&#39;width: ~dpx; height: ~dpx&#39; id=&#39;~A&#39; onclick=&#39;drop_chess(~d)&#39;&gt;&lt;/td&gt;&quot;</span>
<span class="w">  </span><span class="s">&quot;用于输出 td. &quot;</span><span class="p">)</span>

<span class="p">(</span><span class="nf">defmethod</span><span class="w"> </span><span class="nv">dump-chessboard</span><span class="w"> </span><span class="p">((</span><span class="nf">win</span><span class="w"> </span><span class="nv">webview-mixin</span><span class="p">)</span><span class="w"> </span><span class="nv">stream</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let*</span><span class="w"> </span><span class="p">((</span><span class="nf">gridsize</span><span class="w">  </span><span class="p">(</span><span class="nb">floor</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="p">(</span><span class="nf">size</span><span class="w"> </span><span class="nv">win</span><span class="p">)</span><span class="w"> </span><span class="mi">3</span><span class="p">))))</span>
<span class="w">    </span><span class="p">(</span><span class="nb">format</span><span class="w"> </span><span class="nv">stream</span><span class="w"> </span><span class="s">&quot;&lt;table border=&#39;1&#39;&gt;&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nf">loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="nv">row</span><span class="w"> </span><span class="nv">below</span><span class="w"> </span><span class="mi">3</span>
<span class="w">          </span><span class="k">do</span><span class="w"> </span><span class="p">(</span><span class="nb">format</span><span class="w"> </span><span class="nv">stream</span><span class="w"> </span><span class="s">&quot;&lt;tr&gt;&quot;</span><span class="p">)</span>
<span class="w">          </span><span class="k">do</span><span class="w"> </span><span class="p">(</span><span class="nf">loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="nv">col</span><span class="w"> </span><span class="nv">below</span><span class="w"> </span><span class="mi">3</span>
<span class="w">                   </span><span class="nv">for</span><span class="w"> </span><span class="nv">chess-id</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="nv">row</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="nv">col</span><span class="p">)</span>
<span class="w">                   </span><span class="k">do</span><span class="w"> </span><span class="p">(</span><span class="nb">format</span><span class="w"> </span><span class="nv">stream</span><span class="w"> </span><span class="nv">+table-control-string+</span>
<span class="w">                              </span><span class="nv">gridsize</span><span class="w"> </span><span class="nv">gridsize</span><span class="w"> </span><span class="nv">chess-id</span><span class="w"> </span><span class="nv">chess-id</span><span class="p">))</span>
<span class="w">          </span><span class="k">do</span><span class="w"> </span><span class="p">(</span><span class="nb">format</span><span class="w"> </span><span class="nv">stream</span><span class="w"> </span><span class="s">&quot;&lt;/tr&gt;&quot;</span><span class="p">))</span>
<span class="w">    </span><span class="p">(</span><span class="nb">format</span><span class="w"> </span><span class="nv">stream</span><span class="w"> </span><span class="s">&quot;&lt;/table&gt;&quot;</span><span class="p">)))</span>
</pre></div>
   </details>
  </li>
  <li>绘制控制组件 <code>dump-controls</code>:
   <details><summary>具体实现</summary>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defmethod</span><span class="w"> </span><span class="nv">dump-controls</span><span class="w"> </span><span class="nv">:around</span><span class="w"> </span><span class="p">((</span><span class="nf">win</span><span class="w"> </span><span class="nv">webview-mixin</span><span class="p">)</span><span class="w"> </span><span class="nv">stream</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nb">format</span><span class="w"> </span><span class="nv">stream</span><span class="w"> </span><span class="s">&quot;&lt;div&gt;&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">call-next-method</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nb">format</span><span class="w"> </span><span class="nv">stream</span><span class="w"> </span><span class="s">&quot;&lt;/div&gt;&quot;</span><span class="p">))</span>

<span class="p">(</span><span class="nf">defmethod</span><span class="w"> </span><span class="nv">dump-controls</span><span class="w"> </span><span class="p">((</span><span class="nf">win</span><span class="w"> </span><span class="nv">webview-mixin</span><span class="p">)</span><span class="w"> </span><span class="nv">stream</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nb">format</span><span class="w"> </span><span class="nv">stream</span><span class="w"> </span><span class="s">&quot;&lt;button onclick=&#39;clear_board()&#39;&gt;Clear Board&lt;/button&gt;&quot;</span><span class="p">))</span>
</pre></div>
   </details>
  </li>
  <li>最后得到 HTML 的输出
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">html</span><span class="w"> </span><span class="p">(</span><span class="nf">tictactoe</span><span class="p">)</span>
<span class="w">  </span><span class="s">&quot;返回一个绘制井字棋 `tictactoe&#39; 的 HTML. &quot;</span>
<span class="w">  </span><span class="p">(</span><span class="nb">with-output-to-string</span><span class="w"> </span><span class="p">(</span><span class="nf">stream</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">format</span><span class="w"> </span><span class="nv">stream</span><span class="w"> </span><span class="s">&quot;&lt;body&gt;&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nf">dump-chessboard</span><span class="w"> </span><span class="nv">tictactoe</span><span class="w"> </span><span class="nv">stream</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nf">dump-controls</span><span class="w">   </span><span class="nv">tictactoe</span><span class="w"> </span><span class="nv">stream</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">format</span><span class="w"> </span><span class="nv">stream</span><span class="w"> </span><span class="s">&quot;&lt;/body&gt;&quot;</span><span class="p">)))</span>

<span class="p">(</span><span class="nf">defmethod</span><span class="w"> </span><span class="nv">initialize-instance</span><span class="w"> </span><span class="nv">:after</span><span class="w"> </span><span class="p">((</span><span class="nf">game</span><span class="w"> </span><span class="nv">webview-mixin</span><span class="p">)</span><span class="w"> </span><span class="nv">&amp;key</span><span class="w"> </span><span class="nv">debug</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">with-slots</span><span class="w"> </span><span class="p">(</span><span class="nf">size</span><span class="w"> </span><span class="nv">control-height</span><span class="w"> </span><span class="nv">webview</span><span class="p">)</span><span class="w"> </span><span class="nv">game</span>
<span class="w">    </span><span class="c1">;; 初始化时绑定窗体大小以及 HTML</span>
<span class="w">    </span><span class="p">(</span><span class="nf">setf</span><span class="w"> </span><span class="nv">webview</span><span class="w"> </span><span class="p">(</span><span class="nf">make-webview</span><span class="w"> </span><span class="nv">:debug</span><span class="w">  </span><span class="nv">debug</span>
<span class="w">                                </span><span class="nv">:width</span><span class="w">  </span><span class="nv">size</span>
<span class="w">                                </span><span class="nv">:height</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="nv">size</span><span class="w"> </span><span class="nv">control-height</span><span class="p">)</span>
<span class="w">                                </span><span class="nv">:title</span><span class="w">  </span><span class="s">&quot;TicTacToe&quot;</span>
<span class="w">                                </span><span class="nv">:hints</span><span class="w">  </span><span class="nv">:fixed</span>
<span class="w">                                </span><span class="nv">:html</span><span class="w">   </span><span class="p">(</span><span class="nf">html</span><span class="w"> </span><span class="nv">game</span><span class="p">)))</span>
<span class="w">    </span><span class="c1">;; 绑定交互的事件的逻辑</span>
<span class="w">    </span><span class="p">(</span><span class="nf">webview-bind</span><span class="w"> </span><span class="p">(</span><span class="nf">webview</span><span class="w"> </span><span class="nv">chess-id</span><span class="p">)</span><span class="w"> </span><span class="s">&quot;drop_chess&quot;</span>
<span class="w">      </span><span class="p">(</span><span class="nf">drop-chess</span><span class="w"> </span><span class="nv">game</span><span class="w"> </span><span class="nv">chess-id</span><span class="p">))</span>
<span class="w">    </span><span class="p">(</span><span class="nf">webview-bind</span><span class="w"> </span><span class="p">(</span><span class="nf">webview</span><span class="p">)</span><span class="w"> </span><span class="s">&quot;clear_board&quot;</span>
<span class="w">      </span><span class="p">(</span><span class="nf">clear-board</span><span class="w"> </span><span class="nv">game</span><span class="p">))))</span>
</pre></div>
  </li>
  <li>并且还要注意到, 当 <code>drop-chess</code>, <code>clear-board</code> 这些 <code>tictactoe</code> 类的方法执行后,
    对应的窗体也需要进行更新:
    <ul>
      <li><code>drop-chess</code> 后, 将对应落子区域的格子的颜色进行更新:
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defconstant</span><span class="w"> </span><span class="nv">+drop-control-string+</span>
<span class="w">  </span><span class="s">&quot;document.getElementById(&#39;~d&#39;).style.background = &#39;~(~A~)&#39;;&quot;</span>
<span class="w">  </span><span class="s">&quot;落子的 JS 控制代码. &quot;</span><span class="p">)</span>

<span class="c1">;; 在落子后将对应格子的颜色更新</span>
<span class="p">(</span><span class="nf">defmethod</span><span class="w"> </span><span class="nv">drop-chess</span><span class="w"> </span><span class="nv">:after</span><span class="w"> </span><span class="p">((</span><span class="nf">game</span><span class="w"> </span><span class="nv">webview-mixin</span><span class="p">)</span><span class="w"> </span><span class="nv">chess-id</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">with-slots</span><span class="w"> </span><span class="p">(</span><span class="nf">webview</span><span class="w"> </span><span class="nv">chessboard</span><span class="p">)</span><span class="w"> </span><span class="nv">game</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nf">grid</span><span class="w"> </span><span class="p">(</span><span class="nf">aref</span><span class="w"> </span><span class="nv">chessboard</span><span class="w"> </span><span class="nv">chess-id</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nf">webview-eval</span><span class="w"> </span><span class="nv">webview</span><span class="w"> </span><span class="p">(</span><span class="nb">format</span><span class="w"> </span><span class="nv">nil</span><span class="w"> </span><span class="nv">+drop-control-string+</span>
<span class="w">                                    </span><span class="nv">chess-id</span><span class="w"> </span><span class="p">(</span><span class="k">case</span><span class="w"> </span><span class="nv">grid</span>
<span class="w">                                               </span><span class="p">(</span><span class="nf">:red</span><span class="w"> </span><span class="s">&quot;red&quot;</span><span class="p">)</span>
<span class="w">                                               </span><span class="p">(</span><span class="nf">:blue</span><span class="w"> </span><span class="s">&quot;blue&quot;</span><span class="p">)))))))</span>
</pre></div>
      </li>
      <li><code>clear-board</code> 前, 将棋盘中的所有棋子都清空颜色:
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defconstant</span><span class="w"> </span><span class="nv">+title-format-control+</span>
<span class="w">         </span><span class="s">&quot;TicTacToe (~A)&quot;</span>
<span class="w">         </span><span class="s">&quot;显示窗口的 title 的格式. &quot;</span><span class="p">)</span>

<span class="p">(</span><span class="nf">defmethod</span><span class="w"> </span><span class="nv">clear-board</span><span class="w"> </span><span class="nv">:before</span><span class="w"> </span><span class="p">((</span><span class="nf">game</span><span class="w"> </span><span class="nv">webview-mixin</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="nf">with-slots</span><span class="w"> </span><span class="p">(</span><span class="nf">webview</span><span class="w"> </span><span class="nv">player</span><span class="p">)</span><span class="w"> </span><span class="nv">game</span>
<span class="w">    </span><span class="p">(</span><span class="nf">dotimes</span><span class="w"> </span><span class="p">(</span><span class="nf">i</span><span class="w"> </span><span class="mi">9</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nf">webview-eval</span><span class="w"> </span><span class="nv">webview</span><span class="w"> </span><span class="p">(</span><span class="nb">format</span><span class="w"> </span><span class="nv">nil</span><span class="w"> </span><span class="nv">+drop-control-string+</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="s">&quot;white&quot;</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="nf">webview-set-title</span><span class="w"> </span><span class="nv">webview</span><span class="w"> </span><span class="p">(</span><span class="nb">format</span><span class="w"> </span><span class="nv">nil</span><span class="w"> </span><span class="nv">+title-format-control+</span><span class="w"> </span><span class="nv">player</span><span class="p">)))))</span>
</pre></div>
      </li>
      <li><code>update-status</code> 后, 如果游戏结束, 则将 <code>title</code> 设置为显示棋局状态:
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defmethod</span><span class="w"> </span><span class="nv">update-status</span><span class="w"> </span><span class="nv">:after</span><span class="w"> </span><span class="p">((</span><span class="nf">game</span><span class="w"> </span><span class="nv">webview-mixin</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="nf">with-slots</span><span class="w"> </span><span class="p">(</span><span class="nf">status</span><span class="w"> </span><span class="nv">webview</span><span class="p">)</span><span class="w"> </span><span class="nv">game</span>
<span class="w">    </span><span class="p">(</span><span class="k">unless</span><span class="w"> </span><span class="p">(</span><span class="nf">eq</span><span class="w"> </span><span class="nv">status</span><span class="w"> </span><span class="nv">:play</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nf">webview-set-title</span><span class="w"> </span><span class="nv">webview</span><span class="w"> </span><span class="p">(</span><span class="nb">format</span><span class="w"> </span><span class="nv">nil</span><span class="w"> </span><span class="nv">+title-format-control+</span><span class="w"> </span><span class="nv">status</span><span class="p">)))))</span>
</pre></div>
      </li>
      <li><code>swap-player</code> 后, 如果游戏仍在进行, 则将 <code>title</code> 设置为当前玩家:
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defmethod</span><span class="w"> </span><span class="nv">swap-player</span><span class="w"> </span><span class="nv">:after</span><span class="w"> </span><span class="p">((</span><span class="nf">game</span><span class="w"> </span><span class="nv">webview-mixin</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="nf">with-slots</span><span class="w"> </span><span class="p">(</span><span class="nf">status</span><span class="w"> </span><span class="nv">player</span><span class="w"> </span><span class="nv">webview</span><span class="p">)</span><span class="w"> </span><span class="nv">game</span>
<span class="w">    </span><span class="p">(</span><span class="k">when</span><span class="w"> </span><span class="p">(</span><span class="nf">eq</span><span class="w"> </span><span class="nv">status</span><span class="w"> </span><span class="nv">:play</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nf">webview-set-title</span><span class="w"> </span><span class="nv">webview</span><span class="w"> </span><span class="p">(</span><span class="nb">format</span><span class="w"> </span><span class="nv">nil</span><span class="w"> </span><span class="nv">+title-format-control+</span><span class="w"> </span><span class="nv">player</span><span class="p">)))))</span>
</pre></div>
      </li>
    </ul>
  </li>
</ol>
<p>于是就完成了一个井字棋游戏的类:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defclass</span><span class="w"> </span><span class="nv">tictactoe-webview</span><span class="w"> </span><span class="p">(</span><span class="nf">tictactoe</span><span class="w"> </span><span class="nv">webview-mixin</span><span class="p">)</span><span class="w"> </span><span class="p">()</span>
<span class="w">  </span><span class="p">(</span><span class="nf">:documentation</span><span class="w"> </span><span class="s">&quot;井字棋游戏&quot;</span><span class="p">))</span>
</pre></div>
<details><summary>一个简单的测试 (代码)</summary>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nf">game</span><span class="w"> </span><span class="p">(</span><span class="nf">make-instance</span><span class="w"> </span><span class="ss">&#39;tictactoe-webview</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="nf">def-dispatch-callback</span><span class="w"> </span><span class="nv">random-drop</span><span class="w"> </span><span class="p">(</span><span class="nf">webview</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">unless</span><span class="w"> </span><span class="p">(</span><span class="nf">eq</span><span class="w"> </span><span class="p">(</span><span class="nf">status</span><span class="w"> </span><span class="nv">game</span><span class="p">)</span><span class="w"> </span><span class="nv">:play</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nf">clear-board</span><span class="w"> </span><span class="nv">game</span><span class="p">))</span>
<span class="w">    </span><span class="p">(</span><span class="nf">drop-chess</span><span class="w"> </span><span class="nv">game</span><span class="w"> </span><span class="p">(</span><span class="nb">random</span><span class="w"> </span><span class="mi">9</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="nf">dotimes</span><span class="w"> </span><span class="p">(</span><span class="nf">i</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nf">webview-dispatch-fn</span><span class="w"> </span><span class="p">(</span><span class="nf">slot-value</span><span class="w"> </span><span class="nv">game</span><span class="w"> </span><span class="ss">&#39;webview</span><span class="p">)</span><span class="w"> </span><span class="ss">&#39;random-drop</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">sleep</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)))</span>
</pre></div>
</details>
<p><img src="/_img/lisp/misc/tictactoe/tictactoe.gif" alt="/_img/lisp/misc/tictactoe/tictactoe.gif" /></p>
<p>(效果确实有点子丑了&#8230; )</p>
<h1>AI?</h1>
<p>终于到了比较有意思的地方了:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defclass</span><span class="w"> </span><span class="nv">ai-player-mixin</span><span class="w"> </span><span class="p">()</span>
<span class="w">  </span><span class="p">((</span><span class="nf">ai-player</span><span class="w"> </span><span class="nv">:initform</span><span class="w"> </span><span class="nv">:blue</span><span class="w"> </span><span class="nv">:initarg</span><span class="w"> </span><span class="nv">:ai</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="nf">:documentation</span><span class="w"> </span><span class="s">&quot;AI mixin for tictactoe class. &quot;</span><span class="p">))</span>
</pre></div>
<p>这里考虑的是一个没有历史发展记忆, 仅考虑当前棋局进行决策的 AI.
  在每次交换落子控制方的时候, 就会进行思考并落子.</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defgeneric</span><span class="w"> </span><span class="nv">ai-choose-drop</span><span class="w"> </span><span class="p">(</span><span class="nf">tictactoe</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">:documentation</span><span class="w"> </span><span class="s">&quot;返回 AI 决定的落子位置. &quot;</span><span class="p">))</span>

<span class="p">(</span><span class="nf">defmethod</span><span class="w"> </span><span class="nv">swap-player</span><span class="w"> </span><span class="nv">:after</span><span class="w"> </span><span class="p">((</span><span class="nf">game</span><span class="w"> </span><span class="nv">ai-player-mixin</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="nf">with-slots</span><span class="w"> </span><span class="p">(</span><span class="nf">player</span><span class="w"> </span><span class="nv">ai-player</span><span class="w"> </span><span class="nv">status</span><span class="p">)</span><span class="w"> </span><span class="nv">game</span>
<span class="w">    </span><span class="p">(</span><span class="k">when</span><span class="w"> </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nf">eq</span><span class="w"> </span><span class="nv">player</span><span class="w"> </span><span class="nv">ai-player</span><span class="p">)</span><span class="w">    </span><span class="c1">; 轮到 AI</span>
<span class="w">               </span><span class="p">(</span><span class="nf">eq</span><span class="w"> </span><span class="nv">status</span><span class="w"> </span><span class="nv">:play</span><span class="p">))</span><span class="w">       </span><span class="c1">; 游戏还能继续玩</span>
<span class="w">      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nb">drop</span><span class="w"> </span><span class="p">(</span><span class="nf">ai-choose-drop</span><span class="w"> </span><span class="nv">game</span><span class="p">)))</span>
<span class="w">        </span><span class="p">(</span><span class="nf">drop-chess</span><span class="w"> </span><span class="nv">game</span><span class="w"> </span><span class="nb">drop</span><span class="p">)))))</span>

<span class="p">(</span><span class="nf">defmethod</span><span class="w"> </span><span class="nv">clear-board</span><span class="w"> </span><span class="nv">:after</span><span class="w"> </span><span class="p">((</span><span class="nf">game</span><span class="w"> </span><span class="nv">ai-player-mixin</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="nf">with-slots</span><span class="w"> </span><span class="p">(</span><span class="nf">player</span><span class="w"> </span><span class="nv">ai-player</span><span class="w"> </span><span class="nv">status</span><span class="p">)</span><span class="w"> </span><span class="nv">game</span>
<span class="w">    </span><span class="p">(</span><span class="k">when</span><span class="w"> </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nf">eq</span><span class="w"> </span><span class="nv">player</span><span class="w"> </span><span class="nv">ai-player</span><span class="p">)</span><span class="w">    </span><span class="c1">; 轮到 AI</span>
<span class="w">               </span><span class="p">(</span><span class="nf">eq</span><span class="w"> </span><span class="nv">status</span><span class="w"> </span><span class="nv">:play</span><span class="p">))</span><span class="w">       </span><span class="c1">; 游戏还能继续玩</span>
<span class="w">      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nb">drop</span><span class="w"> </span><span class="p">(</span><span class="nf">ai-choose-drop</span><span class="w"> </span><span class="nv">game</span><span class="p">)))</span>
<span class="w">        </span><span class="p">(</span><span class="nf">drop-chess</span><span class="w"> </span><span class="nv">game</span><span class="w"> </span><span class="nb">drop</span><span class="p">)))))</span>
</pre></div>
<details><summary>等等, defgeneric 是什么? 为什么不用 defmethod? </summary>
<p>在前面的代码里面, 我有意忽略了 <code>defgeneric</code> 的使用, 而只使用 <code>defmethod</code>.
  尽管实际上并不会有什么问题.</p>
</details>
<h2>Montain Gorilla Algorithm</h2>
<p>这是一个著名的算法, 中文直译是山地黑猩猩算法. 令人惊讶的是,
  尽管这个算法名字听上去非常的好笑, 但是它确实非常好笑, 因为是我瞎编的.</p>
<p>什么 AI 不 AI 的, 随机就完事了:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defclass</span><span class="w"> </span><span class="nv">montain-gorilla-mixin</span><span class="w"> </span><span class="p">(</span><span class="nf">ai-player-mixin</span><span class="p">)</span><span class="w"> </span><span class="p">()</span>
<span class="w">  </span><span class="p">(</span><span class="nf">:documentation</span><span class="w"> </span><span class="s">&quot;随机落子的 AI. &quot;</span><span class="p">))</span>

<span class="p">(</span><span class="nf">defclass</span><span class="w"> </span><span class="nv">tictactoe-gorilla</span><span class="w"> </span><span class="p">(</span><span class="nf">tictactoe-webview</span><span class="w"> </span><span class="nv">montain-gorilla-mixin</span><span class="p">)</span><span class="w"> </span><span class="p">())</span>

<span class="p">(</span><span class="nf">defmethod</span><span class="w"> </span><span class="nv">ai-choose-drop</span><span class="w"> </span><span class="p">((</span><span class="nf">game</span><span class="w"> </span><span class="nv">montain-gorilla-mixin</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="nf">with-slots</span><span class="w"> </span><span class="p">(</span><span class="nf">chessboard</span><span class="p">)</span><span class="w"> </span><span class="nv">game</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nf">remain</span><span class="w"> </span><span class="p">(</span><span class="nf">loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="nv">below</span><span class="w"> </span><span class="mi">9</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nf">eq</span><span class="w"> </span><span class="p">(</span><span class="nf">aref</span><span class="w"> </span><span class="nv">chessboard</span><span class="w"> </span><span class="nv">i</span><span class="p">)</span><span class="w"> </span><span class="nv">:empty</span><span class="p">)</span>
<span class="w">                          </span><span class="nv">collect</span><span class="w"> </span><span class="nv">i</span><span class="p">)))</span>
<span class="w">      </span><span class="c1">;; 在剩余的空格子中随便挑出一个落子</span>
<span class="w">      </span><span class="p">(</span><span class="nf">nth</span><span class="w"> </span><span class="p">(</span><span class="nb">random</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="nv">remain</span><span class="p">))</span><span class="w"> </span><span class="nv">remain</span><span class="p">))))</span>
</pre></div>
<h2>Minimax Algorithm</h2>
<p>那么说正经的, 如何实现一个有用一点的 AI 呢? 一个方法就是使用 <a href="https://en.wikipedia.org/wiki/Minimax">Minimax</a> 算法:</p>
<p>(以下来源于 Algorithm in Nutshell Figure 7-15, 简单的来说, Minimax
  算法就是一种最大深度有限的深度优先搜索算法, 搜索的目标是使得己方分数最大,
  敌方分数最小. 所以其实需要配合打分表, 或者说打分规则进行使用. )</p>
<details><summary>解说略, 直接是代码, 因为我累了. 重点还是放在后面那个东西上吧. </summary>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">%empty-grids</span><span class="w"> </span><span class="p">(</span><span class="nf">chessboard</span><span class="p">)</span>
<span class="w">  </span><span class="s">&quot;找到 `chessboard&#39; 中所有空格子. &quot;</span>
<span class="w">  </span><span class="p">(</span><span class="nf">loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="nv">below</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nf">eq</span><span class="w"> </span><span class="p">(</span><span class="nf">aref</span><span class="w"> </span><span class="nv">chessboard</span><span class="w"> </span><span class="nv">i</span><span class="p">)</span><span class="w"> </span><span class="nv">:empty</span><span class="p">)</span><span class="w"> </span><span class="nv">collect</span><span class="w"> </span><span class="nv">i</span><span class="p">))</span>

<span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">%get-score</span><span class="w"> </span><span class="p">(</span><span class="nf">status</span><span class="w"> </span><span class="nv">ai-player</span><span class="p">)</span>
<span class="w">  </span><span class="s">&quot;对当前棋局进行打分. &quot;</span>
<span class="w">  </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="k">or</span><span class="w"> </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nf">eq</span><span class="w"> </span><span class="nv">ai-player</span><span class="w"> </span><span class="nv">:red</span><span class="p">)</span>
<span class="w">                  </span><span class="p">(</span><span class="nf">eq</span><span class="w"> </span><span class="nv">status</span><span class="w"> </span><span class="nv">:red-win</span><span class="p">))</span>
<span class="w">             </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nf">eq</span><span class="w"> </span><span class="nv">ai-player</span><span class="w"> </span><span class="nv">:blue</span><span class="p">)</span>
<span class="w">                  </span><span class="p">(</span><span class="nf">eq</span><span class="w"> </span><span class="nv">status</span><span class="w"> </span><span class="nv">:blue-win</span><span class="p">)))</span>
<span class="w">         </span><span class="mi">1</span><span class="p">)</span><span class="w">                </span><span class="c1">; 若 AI 获胜, score = 1</span>
<span class="w">        </span><span class="p">((</span><span class="k">or</span><span class="w"> </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nf">eq</span><span class="w"> </span><span class="nv">ai-player</span><span class="w"> </span><span class="nv">:red</span><span class="p">)</span>
<span class="w">                  </span><span class="p">(</span><span class="nf">eq</span><span class="w"> </span><span class="nv">status</span><span class="w"> </span><span class="nv">:blue-win</span><span class="p">))</span>
<span class="w">             </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nf">eq</span><span class="w"> </span><span class="nv">ai-player</span><span class="w"> </span><span class="nv">:blue</span><span class="p">)</span>
<span class="w">                  </span><span class="p">(</span><span class="nf">eq</span><span class="w"> </span><span class="nv">status</span><span class="w"> </span><span class="nv">:red-win</span><span class="p">)))</span>
<span class="w">         </span><span class="mi">-1</span><span class="p">)</span><span class="w">               </span><span class="c1">; 若非 AI 获胜, score = -1</span>
<span class="w">        </span><span class="p">(</span><span class="nf">t</span><span class="w">                 </span><span class="c1">; 平局, score = 0</span>
<span class="w">         </span><span class="mi">0</span><span class="p">)))</span><span class="w">         </span>

<span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">%minimax</span><span class="w"> </span><span class="p">(</span><span class="nf">chessboard</span><span class="w"> </span><span class="nv">player</span><span class="w"> </span><span class="nv">ai-player</span><span class="w"> </span><span class="nv">&amp;optional</span><span class="w"> </span><span class="p">(</span><span class="nf">depth</span><span class="w"> </span><span class="mi">3</span><span class="p">))</span>
<span class="w">  </span><span class="s">&quot;返回一个最适合的落点点位, 以及其对应的打分.</span>
<span class="s">Return (values score choose). &quot;</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nf">status</span><span class="w"> </span><span class="p">(</span><span class="nf">%chessboard-status</span><span class="w"> </span><span class="nv">chessboard</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">or</span><span class="w"> </span><span class="p">(</span><span class="nf">zerop</span><span class="w"> </span><span class="nv">depth</span><span class="p">)</span>
<span class="w">            </span><span class="p">(</span><span class="nb">not</span><span class="w"> </span><span class="p">(</span><span class="nf">eq</span><span class="w"> </span><span class="nv">status</span><span class="w"> </span><span class="nv">:play</span><span class="p">)))</span>
<span class="w">        </span><span class="p">(</span><span class="nf">%get-score</span><span class="w"> </span><span class="nv">status</span><span class="w"> </span><span class="nv">ai-player</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nf">best</span><span class="w"> </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nf">eq</span><span class="w"> </span><span class="nv">player</span><span class="w"> </span><span class="nv">ai-player</span><span class="p">)</span>
<span class="w">                        </span><span class="nv">most-negative-fixnum</span><span class="w">   </span><span class="c1">; 最大化边界</span>
<span class="w">                        </span><span class="nv">most-positive-fixnum</span><span class="p">))</span><span class="w"> </span><span class="c1">; 最小化边界</span>
<span class="w">              </span><span class="p">(</span><span class="nf">choose</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w">                      </span><span class="c1">; 选择的点位</span>
<span class="w">              </span><span class="nv">score</span><span class="p">)</span>
<span class="w">          </span><span class="p">(</span><span class="nf">dolist</span><span class="w"> </span><span class="p">(</span><span class="nf">next</span><span class="w"> </span><span class="p">(</span><span class="nf">%empty-grids</span><span class="w"> </span><span class="nv">chessboard</span><span class="p">))</span>
<span class="w">            </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nf">chessboard</span><span class="w"> </span><span class="p">(</span><span class="nf">alexandria:copy-array</span><span class="w"> </span><span class="nv">chessboard</span><span class="p">)))</span>
<span class="w">              </span><span class="p">(</span><span class="nf">setf</span><span class="w"> </span><span class="p">(</span><span class="nf">aref</span><span class="w"> </span><span class="nv">chessboard</span><span class="w"> </span><span class="nv">next</span><span class="p">)</span><span class="w"> </span><span class="nv">player</span><span class="p">)</span><span class="w"> </span><span class="c1">; 落子</span>
<span class="w">              </span><span class="p">(</span><span class="nf">setf</span><span class="w"> </span><span class="nv">score</span><span class="w"> </span><span class="p">(</span><span class="nf">%minimax</span><span class="w"> </span><span class="nv">chessboard</span><span class="w">     </span><span class="c1">; 计算落子后 `chessboard&#39; 对应的分数</span>
<span class="w">                                    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nf">eq</span><span class="w"> </span><span class="nv">player</span><span class="w"> </span><span class="nv">:red</span><span class="p">)</span><span class="w"> </span><span class="nv">:blue</span><span class="w"> </span><span class="nv">:red</span><span class="p">)</span>
<span class="w">                                    </span><span class="nv">ai-player</span><span class="w"> </span><span class="p">(</span><span class="nb">1-</span><span class="w"> </span><span class="nv">depth</span><span class="p">))))</span>
<span class="w">            </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nf">eq</span><span class="w"> </span><span class="nv">player</span><span class="w"> </span><span class="nv">ai-player</span><span class="p">)</span>
<span class="w">                        </span><span class="p">(</span><span class="nb">&gt;</span><span class="w"> </span><span class="nv">score</span><span class="w"> </span><span class="nv">best</span><span class="p">))</span><span class="w">   </span><span class="c1">; 最大化己方得分</span>
<span class="w">                   </span><span class="p">(</span><span class="nf">setf</span><span class="w"> </span><span class="nv">best</span><span class="w">   </span><span class="nv">score</span>
<span class="w">                         </span><span class="nv">choose</span><span class="w"> </span><span class="nv">next</span><span class="p">))</span>
<span class="w">                  </span><span class="p">((</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nb">not</span><span class="w"> </span><span class="p">(</span><span class="nf">eq</span><span class="w"> </span><span class="nv">player</span><span class="w"> </span><span class="nv">ai-player</span><span class="p">))</span>
<span class="w">                        </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="nv">score</span><span class="w"> </span><span class="nv">best</span><span class="p">))</span><span class="w">   </span><span class="c1">; 最小化敌方得分</span>
<span class="w">                   </span><span class="p">(</span><span class="nf">setf</span><span class="w"> </span><span class="nv">best</span><span class="w"> </span><span class="nv">score</span>
<span class="w">                         </span><span class="nv">choose</span><span class="w"> </span><span class="nv">next</span><span class="p">))))</span>
<span class="w">          </span><span class="p">(</span><span class="nb">values</span><span class="w"> </span><span class="nv">best</span><span class="w"> </span><span class="nv">choose</span><span class="p">)))))</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defclass</span><span class="w"> </span><span class="nv">minimax-mixin</span><span class="w"> </span><span class="p">(</span><span class="nf">ai-player-mixin</span><span class="p">)</span><span class="w"> </span><span class="p">()</span>
<span class="w">  </span><span class="p">(</span><span class="nf">:documentation</span><span class="w"> </span><span class="s">&quot;Minimax AI&quot;</span><span class="p">))</span>

<span class="p">(</span><span class="nf">defmethod</span><span class="w"> </span><span class="nv">ai-choose-drop</span><span class="w"> </span><span class="p">((</span><span class="nf">game</span><span class="w"> </span><span class="nv">ai-player-mixin</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="nf">with-slots</span><span class="w"> </span><span class="p">(</span><span class="nf">chessboard</span><span class="w"> </span><span class="nv">player</span><span class="w"> </span><span class="nv">ai-player</span><span class="p">)</span><span class="w"> </span><span class="nv">game</span>
<span class="w">    </span><span class="p">(</span><span class="nf">multiple-value-bind</span><span class="w"> </span><span class="p">(</span><span class="nf">score</span><span class="w"> </span><span class="nv">choose</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="nf">%minimax</span><span class="w"> </span><span class="nv">chessboard</span><span class="w"> </span><span class="nv">player</span><span class="w"> </span><span class="nv">ai-player</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nf">declare</span><span class="w"> </span><span class="p">(</span><span class="nf">ignore</span><span class="w"> </span><span class="nv">score</span><span class="p">))</span>
<span class="w">      </span><span class="nv">choose</span><span class="p">)))</span>

<span class="p">(</span><span class="nf">defclass</span><span class="w"> </span><span class="nv">tictactoe-minimax</span><span class="w"> </span><span class="p">(</span><span class="nf">tictactoe-webview</span><span class="w"> </span><span class="nv">minimax-mixin</span><span class="p">)</span><span class="w"> </span><span class="p">())</span>
</pre></div>
<p>(注: 感觉有点子弱? 可能是打分算法不够好. )</p>
</details>
<p>下面有请山地黑猩猩与 Minimax 选手进行一场友好的较量&#8230;</p>
<p><img src="/_img/lisp/misc/tictactoe/gorilla-vs-minimax.gif" alt="/_img/lisp/misc/tictactoe/gorilla-vs-minimax.gif" /></p>
<p>真是场酣畅淋漓的鏖战啊&#8230; (狗头)</p>
<h2>Neural Network</h2>
<p>其实如果你仔细看上面的打分算法 (<code>%get-score</code>), 就会发现这个打分算法是非常朴素的,
  并且如果你再仔细观察 Minimax 的方法, 就会发现, 其实 Minimax 是对所有可能的落点
  都进行了一个通过深度优先搜索的一个打分过程.</p>
<p>说白了, 所有的过程都是在对棋局进行一个打分. 并选择分高的下.</p>
<details><summary>如果是同分呢? </summary>
<p>理论上对于同分的情况, 应该是随机进行选择的 (山地黑猩猩算法).
  但是我上面的代码没有写就是了. 因为懒.</p>
</details>
<p>对于上面的 Minimax 算法, 一个比较抽象的描述就是构造了一个打分函数
  \(f(\mathrm{chessboard}, i), i = 0, 1, \cdots, 8\), 使得其的值为在格点 \(i\) 上下子的分数 (概率).
  而每次选择落点时通过比较概率 (分数) 对落点位置进行选择.</p>
<p>那么机器学习不就很适合干这种工作吗? (也就是找出原函数 \(f(\mathrm{chessboard}, i)\))</p>
<p>(以下参考: <a href="https://www.tensorflowtictactoe.co">AI Trainable Tic Tac Toe</a>, 因为这也差不多是我第一次写机器学习的代码,
  所以不能保证代码的正确性. )</p>
<p>于是构造一个 9-64-64-9 的三层的神经网络, 其中两个隐藏层使用 <code>ReLU</code> 作为激活函数,
  输出层使用 <code>Softmax</code> 为激活函数. (参考原仓库 <a href="https://github.com/GantMan/tictactoe-ai-tfjs/blob/ddc6f883127222fd208dedc0d437880927e1894d/src/train.js#L42">constructModel</a> 的代码).</p>
<p>于是思路如下:</p>
<ul>
  <li>在每一局比赛结束的时候进行学习.</li>
  <li>去学习胜利的一方的下棋方法, (当平局时, 随机挑选一方进行学习),
    于是就要要求对下棋过程有一个历史记录.</li>
</ul>
<h3>历史记录</h3>
<p>简单来说就是通过栈的 <code>push</code> 和 <code>pop</code> 实现一个简单的历史记录功能.</p>
<details><summary>略, 其实是为了添加一个历史记录功能</summary>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defclass</span><span class="w"> </span><span class="nv">history-mixin</span><span class="w"> </span><span class="p">()</span>
<span class="w">  </span><span class="p">((</span><span class="nf">history</span><span class="w"> </span><span class="nv">:initform</span><span class="w"> </span><span class="p">()))</span>
<span class="w">  </span><span class="p">(</span><span class="nf">:documentation</span><span class="w"> </span><span class="s">&quot;历史记录&quot;</span><span class="p">))</span>

<span class="c1">;; 往历史记录中添加记录: (落点 . 玩家)</span>
<span class="p">(</span><span class="nf">defmethod</span><span class="w"> </span><span class="nv">drop-chess</span><span class="w"> </span><span class="nv">:before</span><span class="w"> </span><span class="p">((</span><span class="nf">game</span><span class="w"> </span><span class="nv">history-mixin</span><span class="p">)</span><span class="w"> </span><span class="nv">chess-id</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">with-slots</span><span class="w"> </span><span class="p">(</span><span class="nf">history</span><span class="p">)</span><span class="w"> </span><span class="nv">game</span>
<span class="w">    </span><span class="p">(</span><span class="nf">push</span><span class="w"> </span><span class="nv">chess-id</span><span class="w"> </span><span class="nv">history</span><span class="p">)))</span>

<span class="p">(</span><span class="nf">defmethod</span><span class="w"> </span><span class="nv">undrop-chess</span><span class="w"> </span><span class="p">((</span><span class="nf">game</span><span class="w"> </span><span class="nv">history-mixin</span><span class="p">)</span><span class="w"> </span><span class="nv">chess-id</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">with-slots</span><span class="w"> </span><span class="p">(</span><span class="nf">chessboard</span><span class="p">)</span><span class="w"> </span><span class="nv">game</span>
<span class="w">    </span><span class="p">(</span><span class="nf">setf</span><span class="w"> </span><span class="p">(</span><span class="nf">aref</span><span class="w"> </span><span class="nv">chessboard</span><span class="w"> </span><span class="nv">chess-id</span><span class="p">)</span><span class="w"> </span><span class="nv">:empty</span><span class="p">)))</span>

<span class="p">(</span><span class="nf">defmethod</span><span class="w"> </span><span class="nv">undrop-chess</span><span class="w"> </span><span class="nv">:before</span><span class="w"> </span><span class="p">((</span><span class="nf">game</span><span class="w"> </span><span class="nv">webview-mixin</span><span class="p">)</span><span class="w"> </span><span class="nv">chess-id</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">with-slots</span><span class="w"> </span><span class="p">(</span><span class="nf">webview</span><span class="p">)</span><span class="w"> </span><span class="nv">game</span>
<span class="w">    </span><span class="p">(</span><span class="nf">webview-eval</span><span class="w"> </span><span class="nv">webview</span><span class="w"> </span><span class="p">(</span><span class="nb">format</span><span class="w"> </span><span class="nv">nil</span><span class="w"> </span><span class="nv">+drop-control-string+</span><span class="w"> </span><span class="nv">chess-id</span><span class="w"> </span><span class="s">&quot;white&quot;</span><span class="p">))))</span>

<span class="c1">;; 悔棋</span>
<span class="p">(</span><span class="nf">defmethod</span><span class="w"> </span><span class="nv">undo</span><span class="w"> </span><span class="p">((</span><span class="nf">game</span><span class="w"> </span><span class="nv">history-mixin</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="nf">with-slots</span><span class="w"> </span><span class="p">(</span><span class="nf">history</span><span class="p">)</span><span class="w"> </span><span class="nv">game</span>
<span class="w">    </span><span class="p">(</span><span class="k">when</span><span class="w"> </span><span class="nv">history</span><span class="w"> </span><span class="c1">;; 有历史记录可以回退</span>
<span class="w">      </span><span class="c1">;; 清空历史记录中的格点</span>
<span class="w">      </span><span class="p">(</span><span class="nf">undrop-chess</span><span class="w"> </span><span class="nv">game</span><span class="w"> </span><span class="p">(</span><span class="nf">pop</span><span class="w"> </span><span class="nv">history</span><span class="p">))</span>
<span class="w">      </span><span class="c1">;; 交换控制方</span>
<span class="w">      </span><span class="p">(</span><span class="nf">swap-player</span><span class="w"> </span><span class="nv">game</span><span class="p">))))</span>

<span class="p">(</span><span class="nf">defclass</span><span class="w"> </span><span class="nv">tictactoe-undo</span><span class="w"> </span><span class="p">(</span><span class="nf">tictactoe</span><span class="w"> </span><span class="nv">history-mixin</span><span class="w"> </span><span class="nv">webview-mixin</span><span class="p">)</span><span class="w"> </span><span class="p">())</span>

<span class="p">(</span><span class="nf">defmethod</span><span class="w"> </span><span class="nv">dump-controls</span><span class="w"> </span><span class="p">((</span><span class="nf">game</span><span class="w"> </span><span class="nv">tictactoe-undo</span><span class="p">)</span><span class="w"> </span><span class="nv">stream</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">declare</span><span class="w"> </span><span class="p">(</span><span class="nf">ignore</span><span class="w"> </span><span class="nv">game</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="nb">format</span><span class="w"> </span><span class="nv">stream</span><span class="w"> </span><span class="s">&quot;&lt;button onclick=&#39;clear_board()&#39;&gt;Clear Board&lt;/button&gt;&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nb">format</span><span class="w"> </span><span class="nv">stream</span><span class="w"> </span><span class="s">&quot;&lt;button onclick=&#39;undo()&#39;&gt;Undo&lt;/button&gt;&quot;</span><span class="p">))</span>

<span class="p">(</span><span class="nf">defmethod</span><span class="w"> </span><span class="nv">initialize-instance</span><span class="w"> </span><span class="nv">:after</span><span class="w"> </span><span class="p">((</span><span class="nf">game</span><span class="w"> </span><span class="nv">tictactoe-undo</span><span class="p">)</span><span class="w"> </span><span class="nv">&amp;key</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">with-slots</span><span class="w"> </span><span class="p">(</span><span class="nf">webview</span><span class="p">)</span><span class="w"> </span><span class="nv">game</span>
<span class="w">    </span><span class="p">(</span><span class="nf">webview-bind</span><span class="w"> </span><span class="p">(</span><span class="nf">webview</span><span class="p">)</span><span class="w"> </span><span class="s">&quot;undo&quot;</span>
<span class="w">      </span><span class="p">(</span><span class="nf">undo</span><span class="w"> </span><span class="nv">game</span><span class="p">))))</span>
</pre></div>
</details>
<h3>神经网络的实现</h3>
<p>在这里我们会手写一个神经网络.</p>
<details><summary>那么为什么不调库呢? </summary>
<p>对啊, 为什么呢?</p>
<p><a href="https://github.com/hikettei/cl-waffe2">cl-waffe2</a> 是一个日本高中生写的 (只能说日本高中生拯救世界并不是动漫里才有的),
  并且最牛皮的是老哥甚至都已经发了论文, 参加过不少会议了&#8230;</p>
<p>诶, 人和人之间的差异啊&#8230;</p>
<p>不过我没怎么用过, 并且对一般的神经网络也不是很熟悉, 所以这里还是手搓一个,
  了解一下大概的思路吧&#8230;</p>
<p>而关于线性代数, 你可以使用 <a href="https://github.com/quil-lang/magicl">magicl</a> 或者 <a href="https://github.com/Lisp-Stat/lla">lla</a> 来进行实现. 不过这里我觉得并不必要,
  (主要是我线性代数部分忘得差不多了, 所以我会用我自己的 <a href="https://github.com/li-yiyang/ryo">ryo</a> 的库来写.)</p>
<p>为了和 Common Lisp 的默认方法进行区分, 我这里用 <code>ryo:at</code> 这样的形式来调用我的方法.</p>
<p>这里不得不提一下关于 Common Lisp 中类似于 C++ 或者 Ruby 中的 Namespace 的东西了.
  在我们定义一个 package 的时候, 实际上我们定义了一个 Namespace.</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defpackage</span><span class="w"> </span><span class="kd">#:foo</span>
<span class="w">  </span><span class="p">(</span><span class="nf">:use</span><span class="w"> </span><span class="nv">:cl</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">:export</span><span class="w"> </span><span class="kd">#:bar</span><span class="p">))</span>

<span class="p">(</span><span class="nf">in-package</span><span class="w"> </span><span class="nv">:foo</span><span class="p">)</span>
</pre></div>
<p>然后在 <code>foo</code> 这个包中定义的各种方法, 都可以被 <code>export</code> 出来在其他的包中引用,
  如: <code>(foo:bar ...)</code>. 当然, 你也可以不 <code>export</code> 直接使用 <code>(foo::bar ...)</code>
  的方式调用内部的名字.</p>
<p>这里会有一个需要注意的点: 为什么用 <code>#:foo</code> 和 <code>#:bar</code>? 这是为了防止和已有的名字发生冲突.</p>
</details>
<p>整体的思路如下:</p>
<ul>
  <li>把棋盘 <code>chessboard</code> 看作是一个 <code>{-1, 0, 1}</code> 的 9 维矢量的输入</li>
  <li>激活函数:
    <ul>
      <li>sigmoid
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">square</span><span class="w"> </span><span class="p">(</span><span class="nf">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">x</span><span class="p">))</span>

<span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">sigmoid</span><span class="w"> </span><span class="p">(</span><span class="nf">x</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nf">expx</span><span class="w"> </span><span class="p">(</span><span class="nb">exp</span><span class="w"> </span><span class="nv">x</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="nv">expx</span><span class="w"> </span><span class="p">(</span><span class="nb">1+</span><span class="w"> </span><span class="nv">expx</span><span class="p">))))</span>

<span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">d-sigmoid</span><span class="w"> </span><span class="p">(</span><span class="nf">x</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nf">expx</span><span class="w"> </span><span class="p">(</span><span class="nb">exp</span><span class="w"> </span><span class="nv">x</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="nv">expx</span><span class="w"> </span><span class="p">(</span><span class="nf">square</span><span class="w"> </span><span class="p">(</span><span class="nb">1+</span><span class="w"> </span><span class="nv">expx</span><span class="p">)))))</span>
</pre></div>
      </li>
      <li>ReLU
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">relu</span><span class="w"> </span><span class="p">(</span><span class="nf">x</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">&gt;</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>

<span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">d-relu</span><span class="w"> </span><span class="p">(</span><span class="nf">x</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">&gt;</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
</pre></div>
      </li>
    </ul>
  </li>
  <li>定义一个 <code>layer</code> 类型用做单层:
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defclass</span><span class="w"> </span><span class="nv">layer</span><span class="w"> </span><span class="p">()</span>
<span class="w">  </span><span class="p">((</span><span class="nf">weights</span><span class="w">  </span><span class="nv">:accessor</span><span class="w"> </span><span class="nv">weights</span><span class="p">)</span>
<span class="w">   </span><span class="p">(</span><span class="nf">%out</span><span class="w">     </span><span class="nv">:accessor</span><span class="w"> </span><span class="nv">%out</span><span class="p">)</span><span class="w">            </span><span class="c1">; 当前计算未过激活函数的输出</span>
<span class="w">   </span><span class="p">(</span><span class="nf">%in</span><span class="w">      </span><span class="nv">:accessor</span><span class="w"> </span><span class="nv">%in</span><span class="p">)</span><span class="w">             </span><span class="c1">; 当前计算的输入</span>
<span class="w">   </span><span class="p">(</span><span class="nf">%rms</span><span class="w">     </span><span class="nv">:accessor</span><span class="w"> </span><span class="nv">%rms</span><span class="p">)</span><span class="w">            </span><span class="c1">; 当前计算的误差</span>
<span class="w">   </span><span class="p">(</span><span class="nf">inputs</span><span class="w">   </span><span class="nv">:initform</span><span class="w"> </span><span class="mi">10</span><span class="w">          </span><span class="nv">:initarg</span><span class="w"> </span><span class="nv">:inputs</span><span class="w">   </span><span class="nv">:reader</span><span class="w">   </span><span class="nv">inputs</span><span class="p">)</span>
<span class="w">   </span><span class="p">(</span><span class="nf">outputs</span><span class="w">  </span><span class="nv">:initform</span><span class="w"> </span><span class="mi">64</span><span class="w">          </span><span class="nv">:initarg</span><span class="w"> </span><span class="nv">:outputs</span><span class="w">  </span><span class="nv">:reader</span><span class="w">   </span><span class="nv">outputs</span><span class="p">)</span>
<span class="w">   </span><span class="p">(</span><span class="nf">active</span><span class="w">   </span><span class="nv">:initform</span><span class="w"> </span><span class="o">#</span><span class="ss">&#39;sigmoid</span><span class="w">   </span><span class="nv">:initarg</span><span class="w"> </span><span class="nv">:active</span><span class="w">   </span><span class="nv">:reader</span><span class="w">   </span><span class="nv">active</span><span class="p">)</span>
<span class="w">   </span><span class="p">(</span><span class="nf">d-active</span><span class="w"> </span><span class="nv">:initform</span><span class="w"> </span><span class="o">#</span><span class="ss">&#39;d-sigmoid</span><span class="w"> </span><span class="nv">:initarg</span><span class="w"> </span><span class="nv">:d-active</span><span class="w"> </span><span class="nv">:reader</span><span class="w">   </span><span class="nv">d-active</span><span class="p">)</span>
<span class="w">   </span><span class="p">(</span><span class="nf">learning-rate</span><span class="w"> </span><span class="nv">:initform</span><span class="w"> </span><span class="mi">1e-3</span>
<span class="w">                  </span><span class="nv">:initarg</span><span class="w">  </span><span class="nv">:learning-rate</span>
<span class="w">                  </span><span class="nv">:accessor</span><span class="w"> </span><span class="nv">learning-rate</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="nf">:documentation</span><span class="w"> </span><span class="s">&quot;一层神经元&quot;</span><span class="p">))</span>
</pre></div>
  <details><summary>初始化时给 weights 设置初始的噪声</summary>
<div class="highlight"><pre><span></span><span class="c1">;; 初始噪声的强度通过 `:noise&#39; 来进行控制</span>
<span class="p">(</span><span class="nf">defmethod</span><span class="w"> </span><span class="nv">initialize-instance</span><span class="w"> </span><span class="nv">:after</span><span class="w"> </span><span class="p">((</span><span class="nf">layer</span><span class="w"> </span><span class="nv">layer</span><span class="p">)</span><span class="w"> </span><span class="nv">&amp;key</span><span class="w"> </span><span class="p">(</span><span class="nf">noise</span><span class="w"> </span><span class="mf">0.1d0</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="nf">with-slots</span><span class="w"> </span><span class="p">(</span><span class="nf">weights</span><span class="w"> </span><span class="nv">inputs</span><span class="w"> </span><span class="nv">outputs</span><span class="p">)</span><span class="w"> </span><span class="nv">layer</span>
<span class="w">    </span><span class="p">(</span><span class="nf">setf</span><span class="w"> </span><span class="nv">weights</span>
<span class="w">          </span><span class="p">(</span><span class="nb">make-array</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="nf">outputs</span><span class="w"> </span><span class="nv">layer</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">inputs</span><span class="w"> </span><span class="nv">layer</span><span class="p">))</span>
<span class="w">                      </span><span class="nv">:initial-contents</span>
<span class="w">                      </span><span class="p">(</span><span class="nf">ryo:collect-i*</span><span class="w"> </span><span class="p">((</span><span class="nf">i</span><span class="w"> </span><span class="p">(</span><span class="nf">inputs</span><span class="w"> </span><span class="nv">layer</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nf">j</span><span class="w"> </span><span class="p">(</span><span class="nf">outputs</span><span class="w"> </span><span class="nv">layer</span><span class="p">)))</span>
<span class="w">                        </span><span class="p">(</span><span class="nb">random</span><span class="w"> </span><span class="nv">noise</span><span class="p">))))))</span>
</pre></div>
  </details>
    <p>其需要有如下的方法:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defgeneric</span><span class="w"> </span><span class="nv">feedforward</span><span class="w"> </span><span class="p">(</span><span class="nf">layer</span><span class="w"> </span><span class="nv">input</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">:documentation</span><span class="w"> </span><span class="s">&quot;计算前向传播&quot;</span><span class="p">))</span>

<span class="p">(</span><span class="nf">defgeneric</span><span class="w"> </span><span class="nv">feedbackward</span><span class="w"> </span><span class="p">(</span><span class="nf">layer</span><span class="w"> </span><span class="nv">err</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">:documentation</span><span class="w"> </span><span class="s">&quot;反向传播误差并更新权重&quot;</span><span class="p">))</span>
</pre></div>
  </li>
  <li><code>feedforward</code> 的实现:
    <p>\[\mathrm{out}_j = w_{ij} \mathrm{in}_i\]</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defmethod</span><span class="w"> </span><span class="nv">feedforward</span><span class="w"> </span><span class="p">((</span><span class="nf">layer</span><span class="w"> </span><span class="nv">layer</span><span class="p">)</span><span class="w"> </span><span class="nv">input</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">with-slots</span><span class="w"> </span><span class="p">(</span><span class="nf">%in</span><span class="w"> </span><span class="nv">%out</span><span class="w"> </span><span class="nv">outputs</span><span class="w"> </span><span class="nv">inputs</span><span class="w"> </span><span class="nv">weights</span><span class="w"> </span><span class="nv">active</span><span class="p">)</span><span class="w"> </span><span class="nv">layer</span>
<span class="w">    </span><span class="p">(</span><span class="nf">setf</span><span class="w"> </span><span class="nv">%in</span><span class="w"> </span><span class="nv">input</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nf">setf</span><span class="w"> </span><span class="nv">%out</span>
<span class="w">          </span><span class="p">(</span><span class="nb">make-array</span><span class="w"> </span><span class="nv">outputs</span>
<span class="w">                      </span><span class="nv">:initial-contents</span>
<span class="w">                      </span><span class="p">(</span><span class="nf">ryo:collect-i*</span><span class="w"> </span><span class="p">((</span><span class="nf">j</span><span class="w"> </span><span class="nv">outputs</span><span class="p">))</span>
<span class="w">                        </span><span class="p">(</span><span class="nf">ryo:sum-iter-i*</span><span class="w"> </span><span class="p">((</span><span class="nf">i</span><span class="w"> </span><span class="nv">inputs</span><span class="p">))</span>
<span class="w">                          </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nf">aref</span><span class="w"> </span><span class="nv">weights</span><span class="w"> </span><span class="nv">j</span><span class="w"> </span><span class="nv">i</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">aref</span><span class="w"> </span><span class="nv">input</span><span class="w"> </span><span class="nv">i</span><span class="p">))))))</span>
<span class="w">    </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="ss">&#39;vector</span><span class="w"> </span><span class="nv">active</span><span class="w"> </span><span class="nv">%out</span><span class="p">)))</span>
</pre></div>
  </li>
  <li><code>feedbackward</code> 通过反传 (backpropagation) 来实现: (参考 <a href="https://en.wikipedia.org/wiki/Multilayer_perceptron">MLP | Wikipedia</a>)
  <details><summary>一些简单的向量函数</summary>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">declaim</span><span class="w"> </span><span class="p">(</span><span class="nf">inline</span><span class="w"> </span><span class="nv">dot</span><span class="w"> </span><span class="nv">vec-sub</span><span class="w"> </span><span class="nv">num-mul</span><span class="p">))</span>
<span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">dot</span><span class="w"> </span><span class="p">(</span><span class="nf">vec1</span><span class="w"> </span><span class="nv">vec2</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="ss">&#39;vector</span><span class="w"> </span><span class="o">#</span><span class="ss">&#39;*</span><span class="w"> </span><span class="nv">vec1</span><span class="w"> </span><span class="nv">vec2</span><span class="p">))</span>

<span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">cross</span><span class="w"> </span><span class="p">(</span><span class="nf">vec1</span><span class="w"> </span><span class="nv">vec2</span><span class="w"> </span><span class="nv">&amp;optional</span><span class="w"> </span><span class="p">(</span><span class="nf">scale</span><span class="w"> </span><span class="mi">1d0</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nf">n</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="nv">vec1</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="nf">m</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="nv">vec2</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="nb">make-array</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="nv">m</span><span class="w"> </span><span class="nv">n</span><span class="p">)</span>
<span class="w">                </span><span class="nv">:initial-contents</span>
<span class="w">                </span><span class="p">(</span><span class="nf">ryo:collect-i*</span><span class="w"> </span><span class="p">((</span><span class="nf">i</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="nv">vec1</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nf">j</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="nv">vec2</span><span class="p">)))</span>
<span class="w">                  </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="nv">scale</span><span class="w"> </span><span class="p">(</span><span class="nf">aref</span><span class="w"> </span><span class="nv">vec1</span><span class="w"> </span><span class="nv">i</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">aref</span><span class="w"> </span><span class="nv">vec2</span><span class="w"> </span><span class="nv">j</span><span class="p">))))))</span>

<span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">num-mul</span><span class="w"> </span><span class="p">(</span><span class="nf">num</span><span class="w"> </span><span class="nv">vec</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="ss">&#39;vector</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nf">vi</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="nv">vi</span><span class="w"> </span><span class="nv">num</span><span class="p">))</span><span class="w"> </span><span class="nv">vec</span><span class="p">))</span>

<span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">vec-sub</span><span class="w"> </span><span class="p">(</span><span class="nf">vec1</span><span class="w"> </span><span class="nv">vec2</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="ss">&#39;vector</span><span class="w"> </span><span class="o">#</span><span class="ss">&#39;-</span><span class="w"> </span><span class="nv">vec1</span><span class="w"> </span><span class="nv">vec2</span><span class="p">))</span>
</pre></div>
  </details>
    <p>向前一层传的误差:</p>
    <p>\[&epsilon;_i' = w_{ij} &epsilon;_j\]</p>
    <p>其中 \(&epsilon;_j\) 为当前层的误差.</p>
    <p>\[&Delta; w_{ij} = - &eta; \frac{&part; &epsilon;}{&part; v_j} y_i\]</p>
    <p>其中 \(&eta;\) 为学习率;</p>
    <p>\[- \frac{&part; &epsilon;}{&part; v_j} = e_j &phi;'(v_j)\]</p>
    <p>其中 \(e_j\) 为误差, \(&phi;'\) 为激活函数的导数;</p>
<div class="highlight"><pre><span></span><span class="c1">;; 返回传递给上一级的误差</span>
<span class="p">(</span><span class="nf">defmethod</span><span class="w"> </span><span class="nv">feedbackward</span><span class="w"> </span><span class="p">((</span><span class="nf">layer</span><span class="w"> </span><span class="nv">layer</span><span class="p">)</span><span class="w"> </span><span class="nv">err</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">with-slots</span><span class="w"> </span><span class="p">(</span><span class="nf">inputs</span><span class="w"> </span><span class="nv">outputs</span><span class="w"> </span><span class="nv">weights</span><span class="p">)</span><span class="w"> </span><span class="nv">layer</span>
<span class="w">    </span><span class="p">(</span><span class="nb">make-array</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="nv">inputs</span><span class="p">)</span>
<span class="w">                </span><span class="nv">:initial-contents</span>
<span class="w">                </span><span class="p">(</span><span class="nf">ryo:collect-i*</span><span class="w"> </span><span class="p">((</span><span class="nf">i</span><span class="w"> </span><span class="nv">inputs</span><span class="p">))</span>
<span class="w">                  </span><span class="p">(</span><span class="nf">ryo:sum-iter-i*</span><span class="w"> </span><span class="p">((</span><span class="nf">j</span><span class="w"> </span><span class="nv">outputs</span><span class="p">))</span>
<span class="w">                    </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nf">ryo:at</span><span class="w"> </span><span class="nv">weights</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="nv">j</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">ryo:at</span><span class="w"> </span><span class="nv">err</span><span class="w"> </span><span class="nv">j</span><span class="p">)))))))</span>

<span class="c1">;; 更新当前权值</span>
<span class="p">(</span><span class="nf">defmethod</span><span class="w"> </span><span class="nv">feedbackward</span><span class="w"> </span><span class="nv">:after</span><span class="w"> </span><span class="p">((</span><span class="nf">layer</span><span class="w"> </span><span class="nv">layer</span><span class="p">)</span><span class="w"> </span><span class="nv">err</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">with-slots</span><span class="w"> </span><span class="p">(</span><span class="nf">inputs</span><span class="w"> </span><span class="nv">outputs</span><span class="w"> </span><span class="nv">d-active</span><span class="w"> </span><span class="nv">%in</span><span class="w"> </span><span class="nv">%out</span><span class="w"> </span><span class="nv">weights</span><span class="w"> </span><span class="nv">learning-rate</span><span class="p">)</span>
<span class="w">      </span><span class="nv">layer</span>
<span class="w">    </span><span class="p">(</span><span class="k">let*</span><span class="w"> </span><span class="p">((</span><span class="nf">dedv</span><span class="w"> </span><span class="p">(</span><span class="nf">dot</span><span class="w"> </span><span class="nv">err</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="ss">&#39;vector</span><span class="w"> </span><span class="nv">d-active</span><span class="w"> </span><span class="nv">%out</span><span class="p">))))</span>
<span class="w">      </span><span class="c1">;; weights_ij = learning_rate * dedv_j * y_i</span>
<span class="w">      </span><span class="p">(</span><span class="nf">ryo:iter-i*</span><span class="w"> </span><span class="p">((</span><span class="nf">i</span><span class="w"> </span><span class="nv">inputs</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">j</span><span class="w"> </span><span class="nv">outputs</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="nf">incf</span><span class="w"> </span><span class="p">(</span><span class="nf">ryo:at</span><span class="w"> </span><span class="nv">weights</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="nv">j</span><span class="p">)</span>
<span class="w">              </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="nv">learning-rate</span><span class="w"> </span><span class="p">(</span><span class="nf">ryo:at</span><span class="w"> </span><span class="nv">dedv</span><span class="w"> </span><span class="nv">j</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">ryo:at</span><span class="w"> </span><span class="nv">%in</span><span class="w"> </span><span class="nv">i</span><span class="p">)))))))</span>
</pre></div>
  </li>
  <li><code>train</code> 训练:
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">%train</span><span class="w"> </span><span class="p">(</span><span class="nf">layer</span><span class="w"> </span><span class="nv">input</span><span class="w"> </span><span class="nv">output</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nf">err</span><span class="w"> </span><span class="p">(</span><span class="nf">vec-sub</span><span class="w"> </span><span class="nv">output</span><span class="w"> </span><span class="p">(</span><span class="nf">feedforward</span><span class="w"> </span><span class="nv">layer</span><span class="w"> </span><span class="nv">input</span><span class="p">))))</span>
<span class="w">    </span><span class="p">(</span><span class="nf">feedbackward</span><span class="w"> </span><span class="nv">layer</span><span class="w"> </span><span class="nv">err</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nb">format</span><span class="w"> </span><span class="nv">t</span><span class="w"> </span><span class="s">&quot;~&amp;ERROR: ~f&quot;</span><span class="w"> </span><span class="p">(</span><span class="nb">reduce</span><span class="w"> </span><span class="o">#</span><span class="ss">&#39;+</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="ss">&#39;list</span><span class="w"> </span><span class="o">#</span><span class="ss">&#39;square</span><span class="w"> </span><span class="nv">err</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="nb">force-output</span><span class="p">)))</span>

<span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">train</span><span class="w"> </span><span class="p">(</span><span class="nf">layer</span><span class="w"> </span><span class="nv">input-output*</span>
<span class="w">              </span><span class="nv">&amp;key</span><span class="w"> </span><span class="p">(</span><span class="nf">learning-rate</span><span class="w"> </span><span class="p">(</span><span class="nf">learning-rate</span><span class="w"> </span><span class="nv">layer</span><span class="p">))</span>
<span class="w">                </span><span class="p">(</span><span class="nf">repeat</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="nf">setf</span><span class="w"> </span><span class="p">(</span><span class="nf">learning-rate</span><span class="w"> </span><span class="nv">layer</span><span class="p">)</span><span class="w"> </span><span class="nv">learning-rate</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">dotimes</span><span class="w"> </span><span class="p">(</span><span class="nf">i</span><span class="w"> </span><span class="nv">repeat</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nf">dolist</span><span class="w"> </span><span class="p">(</span><span class="nf">samples</span><span class="w"> </span><span class="nv">input-output*</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nf">%train</span><span class="w"> </span><span class="nv">layer</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">samples</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="nv">samples</span><span class="p">)))))</span>
</pre></div>
  <details><summary>一些注记</summary>我比较怀疑这个东西是否真的靠谱. 不过没有一个很好的检验方法,
    并且关键是它能动&#8230;
  </details>
  </li>
  <li>将层与层之间连接起来形成网络
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defclass</span><span class="w"> </span><span class="nv">network</span><span class="w"> </span><span class="p">()</span>
<span class="w">  </span><span class="p">((</span><span class="nf">layers</span><span class="w"> </span><span class="nv">:accessor</span><span class="w"> </span><span class="nv">layers</span><span class="p">)))</span>

<span class="p">(</span><span class="nf">defmethod</span><span class="w"> </span><span class="p">(</span><span class="nf">setf</span><span class="w"> </span><span class="nv">learning-rate</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">lr</span><span class="w"> </span><span class="p">(</span><span class="nf">net</span><span class="w"> </span><span class="nv">network</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="nf">with-slots</span><span class="w"> </span><span class="p">(</span><span class="nf">layers</span><span class="p">)</span><span class="w"> </span><span class="nv">net</span>
<span class="w">    </span><span class="p">(</span><span class="nf">loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="nv">below</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="nv">layers</span><span class="p">)</span>
<span class="w">          </span><span class="nv">for</span><span class="w"> </span><span class="nv">layer</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nf">aref</span><span class="w"> </span><span class="nv">layers</span><span class="w"> </span><span class="nv">i</span><span class="p">)</span>
<span class="w">          </span><span class="k">do</span><span class="w"> </span><span class="p">(</span><span class="nf">setf</span><span class="w"> </span><span class="p">(</span><span class="nf">learning-rate</span><span class="w"> </span><span class="nv">layer</span><span class="p">)</span><span class="w"> </span><span class="nv">lr</span><span class="p">))))</span>

<span class="p">(</span><span class="nf">defmethod</span><span class="w"> </span><span class="nv">feedforward</span><span class="w"> </span><span class="p">((</span><span class="nf">net</span><span class="w"> </span><span class="nv">network</span><span class="p">)</span><span class="w"> </span><span class="nv">input</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">with-slots</span><span class="w"> </span><span class="p">(</span><span class="nf">layers</span><span class="p">)</span><span class="w"> </span><span class="nv">net</span>
<span class="w">    </span><span class="p">(</span><span class="nf">loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="nv">below</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="nv">layers</span><span class="p">)</span>
<span class="w">          </span><span class="nv">for</span><span class="w"> </span><span class="nv">layer</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nf">aref</span><span class="w"> </span><span class="nv">layers</span><span class="w"> </span><span class="nv">i</span><span class="p">)</span>
<span class="w">          </span><span class="nv">for</span><span class="w"> </span><span class="nv">output</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nf">feedforward</span><span class="w"> </span><span class="nv">layer</span><span class="w"> </span><span class="nv">input</span><span class="p">)</span>
<span class="w">            </span><span class="nv">then</span><span class="w"> </span><span class="p">(</span><span class="nf">feedforward</span><span class="w"> </span><span class="nv">layer</span><span class="w"> </span><span class="nv">output</span><span class="p">)</span>
<span class="w">          </span><span class="nv">finally</span><span class="w"> </span><span class="p">(</span><span class="nf">return</span><span class="w"> </span><span class="nv">output</span><span class="p">))))</span>

<span class="p">(</span><span class="nf">defmethod</span><span class="w"> </span><span class="nv">feedbackward</span><span class="w"> </span><span class="p">((</span><span class="nf">net</span><span class="w"> </span><span class="nv">network</span><span class="p">)</span><span class="w"> </span><span class="nv">err</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">with-slots</span><span class="w"> </span><span class="p">(</span><span class="nf">layers</span><span class="p">)</span><span class="w"> </span><span class="nv">net</span>
<span class="w">    </span><span class="p">(</span><span class="nf">loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="p">(</span><span class="nb">1-</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="nv">layers</span><span class="p">))</span><span class="w"> </span><span class="nv">downto</span><span class="w"> </span><span class="mi">0</span>
<span class="w">          </span><span class="nv">for</span><span class="w"> </span><span class="nv">layer</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nf">aref</span><span class="w"> </span><span class="nv">layers</span><span class="w"> </span><span class="nv">i</span><span class="p">)</span>
<span class="w">          </span><span class="nv">for</span><span class="w"> </span><span class="nv">back-err</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nf">feedbackward</span><span class="w"> </span><span class="nv">layer</span><span class="w"> </span><span class="nv">err</span><span class="p">)</span>
<span class="w">            </span><span class="nv">then</span><span class="w"> </span><span class="p">(</span><span class="nf">feedbackward</span><span class="w"> </span><span class="nv">layer</span><span class="w"> </span><span class="nv">back-err</span><span class="p">)</span>
<span class="w">          </span><span class="nv">finally</span><span class="w"> </span><span class="p">(</span><span class="nf">return</span><span class="w"> </span><span class="nv">back-err</span><span class="p">))))</span>
</pre></div>
  </li>
</ul>
<p>于是井字棋的 AI 如下:</p>
<p>首先构造一个网络:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">make-tictactoe-mlp</span><span class="w"> </span><span class="p">()</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nf">input-layer</span><span class="w">  </span><span class="p">(</span><span class="nf">make-instance</span><span class="w"> </span><span class="ss">&#39;layer</span><span class="w"> </span><span class="nv">:inputs</span><span class="w">   </span><span class="mi">10</span>
<span class="w">                                            </span><span class="nv">:outputs</span><span class="w">  </span><span class="mi">64</span>
<span class="w">                                            </span><span class="nv">:active</span><span class="w">   </span><span class="o">#</span><span class="ss">&#39;relu</span>
<span class="w">                                            </span><span class="nv">:d-active</span><span class="w"> </span><span class="o">#</span><span class="ss">&#39;d-relu</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="nf">hidden-layer</span><span class="w"> </span><span class="p">(</span><span class="nf">make-instance</span><span class="w"> </span><span class="ss">&#39;layer</span><span class="w"> </span><span class="nv">:inputs</span><span class="w">   </span><span class="mi">64</span>
<span class="w">                                            </span><span class="nv">:outputs</span><span class="w">  </span><span class="mi">64</span>
<span class="w">                                            </span><span class="nv">:active</span><span class="w">   </span><span class="o">#</span><span class="ss">&#39;relu</span>
<span class="w">                                            </span><span class="nv">:d-active</span><span class="w"> </span><span class="o">#</span><span class="ss">&#39;d-relu</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="nf">output-layer</span><span class="w"> </span><span class="p">(</span><span class="nf">make-instance</span><span class="w"> </span><span class="ss">&#39;layer</span><span class="w"> </span><span class="nv">:inputs</span><span class="w">   </span><span class="mi">64</span>
<span class="w">                                            </span><span class="nv">:outputs</span><span class="w">  </span><span class="mi">9</span>
<span class="w">                                            </span><span class="nv">:active</span><span class="w">   </span><span class="o">#</span><span class="ss">&#39;sigmoid</span>
<span class="w">                                            </span><span class="nv">:d-active</span><span class="w"> </span><span class="o">#</span><span class="ss">&#39;d-sigmoid</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="nf">net</span><span class="w">          </span><span class="p">(</span><span class="nf">make-instance</span><span class="w"> </span><span class="ss">&#39;network</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="nf">setf</span><span class="w"> </span><span class="p">(</span><span class="nf">layers</span><span class="w"> </span><span class="nv">net</span><span class="p">)</span>
<span class="w">          </span><span class="p">(</span><span class="nb">make-array</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="nv">:initial-contents</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="nv">input-layer</span>
<span class="w">                                                </span><span class="nv">hidden-layer</span>
<span class="w">                                                </span><span class="nv">output-layer</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="nf">setf</span><span class="w"> </span><span class="p">(</span><span class="nf">learning-rate</span><span class="w"> </span><span class="nv">net</span><span class="p">)</span><span class="w"> </span><span class="mf">0.01</span><span class="p">)</span><span class="w">      </span><span class="c1">; 学习率高一点...</span>
<span class="w">    </span><span class="nv">net</span><span class="p">))</span>
</pre></div>
<p>应该有更好的构造方法, 这里应该可以自己做一套 DSL 的, 不过略去,
  因为我有点不太想写这个了&#8230;</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defclass</span><span class="w"> </span><span class="nv">mlp-mixin</span><span class="w"> </span><span class="p">(</span><span class="nf">ai-player-mixin</span><span class="w"> </span><span class="nv">history-mixin</span><span class="p">)</span>
<span class="w">  </span><span class="p">((</span><span class="nf">model</span><span class="w"> </span><span class="nv">:initform</span><span class="w"> </span><span class="p">(</span><span class="nf">make-tictactoe-mlp</span><span class="p">)</span><span class="w"> </span><span class="nv">:reader</span><span class="w"> </span><span class="nv">model</span><span class="p">)))</span>

<span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">%mlp-input</span><span class="w"> </span><span class="p">(</span><span class="nf">chessboard</span><span class="p">)</span>
<span class="w">  </span><span class="s">&quot;将 `chessboard&#39; 变换为标准的 MLP 模型的输入&quot;</span>
<span class="w">  </span><span class="p">(</span><span class="nf">flet</span><span class="w"> </span><span class="p">((</span><span class="nf">val</span><span class="w"> </span><span class="p">(</span><span class="nf">g</span><span class="p">)</span>
<span class="w">           </span><span class="p">(</span><span class="k">case</span><span class="w"> </span><span class="nv">g</span>
<span class="w">             </span><span class="p">(</span><span class="nf">:red</span><span class="w">   </span><span class="mi">1</span><span class="p">)</span>
<span class="w">             </span><span class="p">(</span><span class="nf">:empty</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">             </span><span class="p">(</span><span class="nf">:blue</span><span class="w"> </span><span class="mi">-1</span><span class="p">))))</span>
<span class="w">    </span><span class="p">(</span><span class="nb">make-array</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="nv">:initial-contents</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="mi">1d0</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="ss">&#39;list</span><span class="w"> </span><span class="o">#</span><span class="ss">&#39;val</span><span class="w"> </span><span class="nv">chessboard</span><span class="p">)))))</span>

<span class="p">(</span><span class="nf">defmethod</span><span class="w"> </span><span class="nv">ai-choose-drop</span><span class="w"> </span><span class="p">((</span><span class="nf">game</span><span class="w"> </span><span class="nv">mlp-mixin</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="nf">with-slots</span><span class="w"> </span><span class="p">(</span><span class="nf">model</span><span class="w"> </span><span class="nv">chessboard</span><span class="w"> </span><span class="nv">history</span><span class="p">)</span><span class="w"> </span><span class="nv">game</span>
<span class="w">    </span><span class="p">(</span><span class="k">let*</span><span class="w"> </span><span class="p">((</span><span class="nf">output</span><span class="w">     </span><span class="p">(</span><span class="nf">feedforward</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="p">(</span><span class="nf">%mlp-input</span><span class="w"> </span><span class="nv">chessboard</span><span class="p">)))</span>
<span class="w">           </span><span class="p">(</span><span class="nf">p-patterns</span><span class="w"> </span><span class="p">(</span><span class="nb">reduce</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nf">p-patterns</span><span class="w"> </span><span class="nv">i</span><span class="p">)</span>
<span class="w">                                 </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nb">&gt;</span><span class="w"> </span><span class="p">(</span><span class="nf">aref</span><span class="w"> </span><span class="nv">output</span><span class="w"> </span><span class="nv">i</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">p-patterns</span><span class="p">))</span>
<span class="w">                                        </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="nf">aref</span><span class="w"> </span><span class="nv">output</span><span class="w"> </span><span class="nv">i</span><span class="p">)</span><span class="w"> </span><span class="nv">i</span><span class="p">))</span>
<span class="w">                                       </span><span class="p">((</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nf">aref</span><span class="w"> </span><span class="nv">output</span><span class="w"> </span><span class="nv">i</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">p-patterns</span><span class="p">))</span>
<span class="w">                                        </span><span class="p">(</span><span class="nf">push</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="nv">p-patterns</span><span class="p">)))</span>
<span class="w">                                       </span><span class="p">(</span><span class="nf">t</span><span class="w"> </span><span class="nv">p-patterns</span><span class="p">)))</span>
<span class="w">                               </span><span class="p">(</span><span class="nf">%empty-grids</span><span class="w"> </span><span class="nv">chessboard</span><span class="p">)</span>
<span class="w">                               </span><span class="nv">:initial-value</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="mi">-1</span><span class="w"> </span><span class="mi">0</span><span class="p">))))</span>
<span class="w">      </span><span class="p">(</span><span class="nf">nth</span><span class="w"> </span><span class="p">(</span><span class="nb">random</span><span class="w"> </span><span class="p">(</span><span class="nb">length</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="nv">p-patterns</span><span class="p">)))</span><span class="w"> </span><span class="p">(</span><span class="nb">cdr</span><span class="w"> </span><span class="nv">p-patterns</span><span class="p">)))))</span>

<span class="p">(</span><span class="nf">defclass</span><span class="w"> </span><span class="nv">tictactoe-mlp</span><span class="w"> </span><span class="p">(</span><span class="nf">tictactoe-webview</span><span class="w"> </span><span class="nv">mlp-mixin</span><span class="p">)</span><span class="w"> </span><span class="p">())</span>

<span class="c1">;; 从历史记录中学习胜者落子</span>
<span class="p">(</span><span class="nf">defmethod</span><span class="w"> </span><span class="nv">learn-from-history</span><span class="w"> </span><span class="p">((</span><span class="nf">game</span><span class="w"> </span><span class="nv">mlp-mixin</span><span class="p">)</span><span class="w"> </span><span class="nv">learn-player</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">with-slots</span><span class="w"> </span><span class="p">(</span><span class="nf">model</span><span class="w"> </span><span class="nv">chessboard</span><span class="w"> </span><span class="nv">history</span><span class="p">)</span><span class="w"> </span><span class="nv">game</span>
<span class="w">    </span><span class="p">(</span><span class="nf">flet</span><span class="w"> </span><span class="p">((</span><span class="nf">get-output</span><span class="w"> </span><span class="p">()</span>
<span class="w">             </span><span class="p">(</span><span class="nb">make-array</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="nv">:initial-contents</span>
<span class="w">                         </span><span class="p">(</span><span class="nf">ryo:collect-i*</span><span class="w"> </span><span class="p">((</span><span class="nf">i</span><span class="w"> </span><span class="mi">9</span><span class="p">))</span>
<span class="w">                           </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nf">eq</span><span class="w"> </span><span class="p">(</span><span class="nb">car</span><span class="w"> </span><span class="nv">history</span><span class="p">)</span><span class="w"> </span><span class="nv">i</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="p">)))))</span>
<span class="w">      </span><span class="p">(</span><span class="k">when</span><span class="w"> </span><span class="p">(</span><span class="nf">eq</span><span class="w"> </span><span class="p">(</span><span class="nf">player</span><span class="w"> </span><span class="nv">game</span><span class="p">)</span><span class="w"> </span><span class="nv">learn-player</span><span class="p">)</span><span class="w"> </span><span class="c1">; 当前玩家为需要学习的玩家</span>
<span class="w">        </span><span class="p">(</span><span class="nf">%train</span><span class="w"> </span><span class="nv">model</span><span class="w"> </span><span class="p">(</span><span class="nf">%mlp-input</span><span class="w"> </span><span class="nv">chessboard</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">get-output</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="k">when</span><span class="w"> </span><span class="p">(</span><span class="nf">undo</span><span class="w"> </span><span class="nv">game</span><span class="p">)</span><span class="w">                 </span><span class="c1">; 如果还有可学习的历史</span>
<span class="w">        </span><span class="p">(</span><span class="nf">learn-from-history</span><span class="w"> </span><span class="nv">game</span><span class="w"> </span><span class="nv">learn-player</span><span class="p">)))))</span>

<span class="p">(</span><span class="nf">defmethod</span><span class="w"> </span><span class="nv">clear-board</span><span class="w"> </span><span class="nv">:before</span><span class="w"> </span><span class="p">((</span><span class="nf">game</span><span class="w"> </span><span class="nv">mlp-mixin</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="nf">with-slots</span><span class="w"> </span><span class="p">(</span><span class="nf">status</span><span class="w"> </span><span class="nv">ai-player</span><span class="p">)</span><span class="w"> </span><span class="nv">game</span>
<span class="w">    </span><span class="p">(</span><span class="k">case</span><span class="w"> </span><span class="nv">status</span>
<span class="w">      </span><span class="p">(</span><span class="nf">:red-win</span><span class="w">  </span><span class="p">(</span><span class="nf">learn-from-history</span><span class="w"> </span><span class="nv">game</span><span class="w"> </span><span class="nv">:red</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="nf">:blue-win</span><span class="w"> </span><span class="p">(</span><span class="nf">learn-from-history</span><span class="w"> </span><span class="nv">game</span><span class="w"> </span><span class="nv">:blue</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="nf">:full</span><span class="w">     </span><span class="p">(</span><span class="nf">learn-from-history</span><span class="w"> </span><span class="nv">game</span><span class="w"> </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nf">eq</span><span class="w"> </span><span class="nv">ai-player</span><span class="w"> </span><span class="nv">:red</span><span class="p">)</span>
<span class="w">                                              </span><span class="nv">:blue</span><span class="w"> </span><span class="nv">:red</span><span class="p">))))))</span>
</pre></div>
<p>还行, 玩了几把发现误差掉不下去, 不是很清楚哪里出了问题.
  先就这样先吧&#8230; 有点厌烦这个过程了. 接下去会找一些比较严谨的模型,
  并且重新写这些比较底层的代码的.</p>
<h4>Common Lisp Modules</h4>这里是我之前阅读 The Substrates of Intelligence, a Neural Network Primer |
  Common Lisp Modules: Artificial Intelligence in the Era of Neural Network
  and Chaos Theory 第二章做的笔记 (但是没读完):
<details><summary>折叠</summary>
<p><b>About</b></p>
<p>导出了之后感觉前一个标题好像有点太长了&#8230; 但是就这样吧,
  毕竟最近的轻小说的标题也挺长的.</p>
<p>尽管貌似都会有一种说法, 认为 LISP 系的都是那种符号计算的专家系统,
  都是那种: &#8220;开除几个专家, 性能就可以提升几倍的&#8221; 东西. 但是其实不是哦,
  虽然我也挺好奇这玩意到底实现的是怎么样的神经网络.</p>
<p>(虽然我觉得这不太可能真的和现在的神经网络能够相提并论,
  但是至少可以先看看, 作为一个历史读物估计也不错.)</p>
<p>(注: 在我读了部分的代码之后, 给我的感觉就是挺失望的,
  里面覆盖的内容可能比较丰富, 但是现在看来也有点少,
  并且总觉得里面的一些代码并不是很通用,
  想要写一些能够具有迁移能力的代码的话, 还是有点困难的.
  所以假如你是想要去了解如何写机器学习用的代码的话,
  可以跳过这篇文章去看其他更加靠谱的文章. 这篇文章的作用更多是没用的历史介绍,
  以及一个简单的实现. )</p>
<p><b>Background</b></p>
<p>这里有一些比较有意思的话, 为了防止我理解错了, 这里用原文截取一下:</p>
<blockquote>
  <p>Neural networks are systems of very simple processing elements
    that are massively interconnected. <b>Long term memory</b> or information
    content in neural networks is typically stored in the state of
    the interconnections, not the processing elements themselves.</p>
</blockquote>
<p>这里的 &#8220;Long term memory&#8221; (长期记忆) 和 RNN 中的
  <a href="https://en.wikipedia.org/wiki/Long_short-term_memory">LSTM (Long Short-Term Memory)</a>, 应该是 <b>不一样</b> 的&#8230;
  啊, 十分抱歉. 看了定义之后才发现了不一样的问题了.</p>
<p>这里还有一个来自过去对未来的想象, 也是非常的有意思:</p>
<blockquote>
  <p>Neural systems exploit the inherent parallelism in many pattern-maching
    and recognition tasks. In the future they will be used to augment
    conventional computers, greatly speeding up pattern matching and
    cognitive tasks.</p>
</blockquote>
<p>确实, 对于模式匹配 (pattern matching) 的问题上来说, 神经网络 (不过感觉此神经网络,
  和现在说的应该不太一样&#8230; ) 确实比规则匹配上来说会方便很多.</p>
<p>在认知 (cognitive) 上的话, 我对这个不了解, 毕竟在实验物理里面, 对数据的模式匹配,
  估计会比较有用.</p>
<p>这里有一个比较有意思的地方:</p>
<blockquote>
  <p>Neural systems are very fault tolerant; they can be partially destroyed
    and still function with some degradation of performance. This fault
    tolerence will someday make it possible to construct neural computers
    with millions of neurons with tens of millions of interconnections
    using three-dimensional integrated circuits.</p>
</blockquote>
<p>看到这里大概就能够发现原文说的 Nerual system 是什么了:
  感觉有一种 <a href="https://en.wikipedia.org/wiki/HAL_9000">HAL</a> 的感觉, 可以一块块拔掉核心板的感觉 (bushi).</p>
<p>不过这里应该是指旧的 <a href="https://en.wikipedia.org/wiki/Connection_Machine">Connection Machine</a>.</p>
<p>这里有一个比较有意思的介绍: <a href="https://www.youtube.com/watch?v=BVtHh9JoS3s">Connection Machine CM-1(1986) &amp; CM-2 (1987) (Youtube)</a>.
  给我的感觉大概就是 Connection Machine 有点像是现代的超算 + GPU + FPGA,
  大概就是一个有超级多核 (每个核还可以去模拟非常多小核) 的计算机,
  然后核与核之间的结果是可以被重新编程来处理的. 这里用现代的眼光来看,
  这样的设计确实有很多的不足 (或者说, 也不是不能用别的方式来实现,
  比如 CPU + GPU 相当于让 GPU 做了每个核的计算, CPU 在做搬运的工作?):</p>
<blockquote>
  <p>Connecting a separate communication wire between each pair of processors
    was impractical since a million processors would require $10^{12]$ wires.</p>
  <p>from <a href="https://longnow.org/essays/richard-feynman-connection-machine/">Richard Feynman and The Connection Machine</a></p>
</blockquote>
<p>从上面的参考资料里面可以看到一个非常恐怖的人力活,
  哪怕是后来用 router (我猜应该是一个类似于网络通信一样的东西) 来减少连线数量,
  仍然还是需要非常多的接线操作等等. 大概里面的瓶颈可能是核与核之间大数据量的传输,
  不过感觉之后可以用 MPI 来试试看.</p>
<p>大概这就是为什么一开始, 或者到了现在人们回过头去看这个的操作会觉得以前的
  Connection Machine 这么不好的原因吧.</p>
<details><summary>一些抱不平</summary>
<p>在教材里面的 Connection Machine 可没有那么好看&#8230; 大概就是一张黑白照片,
  然后一个研究人员 (大佬) 坐在一堆密密麻麻的线缆面前在接线. 啊,
  虽然也很酷就是了, 但是如果大家看过 Connection Machine 的照骗的话:</p>
<p><img src="/_img/lisp/cl-module/CM-1_r_700w.gif" alt="/_img/lisp/cl-module/CM-1_r_700w.gif" /></p>
<p>(图片来源: <a href="https://www.mission-base.com/tamiko/cm/index.html">The Connection Machines CM-1 and CM-2 | Tamiko Thiel</a>)</p>
<p>是不是有一种 <a href="https://evangelion.fandom.com/wiki/Magi">Magi</a> 的感觉&#8230; 真帅啊.</p>
<p>虽然在 Connection Machine 上编程应该是一个非常痛苦的事情.</p>
<blockquote>
  <p>Very well written thesis. The machine, however, was extraordinarily
    difficult to program, resulting in Thinking Machine's quick death
    once they actually tried to compete commercially with Convex and Cray.</p>
  <p>from <a href="https://news.ycombinator.com/item?id=12281908">Hacker News</a></p>
</blockquote>
</details>
<p>但是我觉得这里的概念应当被借鉴和学习, (虽然前沿的计算我并不清楚用的是啥方法,
  但是对于里面提到的这个 Cellular Automa 和物理之间的联系我还是比较好奇的).</p>
<p>嗯, 有时间有点想要翻译一下这篇文章.</p>
<blockquote>
  <p>Neural networks can be best used as components of large systems to
    handle pattern matching tasks. It is important to avoid the use of
    neural network technology in cases like algorythmic processing where
    conventional software solutions are easier to implement and offer
    better performance.</p>
</blockquote>
<p>所以我觉得 Stephen Wolfram 的这种想法更应该被参考:
  <a href="https://writings.stephenwolfram.com/2023/01/wolframalpha-as-the-way-to-bring-computational-knowledge-superpowers-to-chatgpt/">Wolfram|Alpha as the Way to Bring Computational Knowledge Superpowers to ChatGPT</a>.</p>
<p>虽然我不懂人工智能, 也不懂啥世界模型, 但是我认为,
  现在期望 LLM 能够产生所谓的世界模型, 感觉可能有点难?
  不过按照 AI 那么卷的现状, 估计也快了吧. 在神经网络上引入专家系统,
  或者说在专家系统上加入神经网络作为外壳交互, 不知道会不会加速这个
  &#8220;世界模型&#8221; 的得到, 假设专家系统就是一个小世界模型的话 (显然不是),
  能否就这样通过自举来实现模型的生长呢? 嘛, 至少我觉得难说,
  毕竟现在还了解专家系统的大佬应该不多了, LLM 这种应该是更可行的道路.</p>
<p><b>Model for Supervised Learning</b></p>
<p>啊, 这部分我觉得学过/旁听过模式识别的应该或多或少都认识一些?
  总之就是非常的眼熟.</p>
<details><summary>package definition and others</summary>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defpackage</span><span class="w"> </span><span class="kd">#:cl-module/neural</span>
<span class="w">  </span><span class="p">(</span><span class="nf">:use</span><span class="w"> </span><span class="nv">:cl</span><span class="w"> </span><span class="nv">:gurafu</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">:nicknames</span><span class="w"> </span><span class="nv">:neural</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">:import-from</span>
<span class="w">   </span><span class="nv">:magicl</span>
<span class="w">   </span><span class="nv">:from-list</span><span class="w"> </span><span class="nv">:from-array</span><span class="w"> </span><span class="nv">:reshape</span>
<span class="w">   </span><span class="nv">:map!</span><span class="w"> </span><span class="nv">:norm</span><span class="w"> </span><span class="nv">:rand</span><span class="w"> </span><span class="nv">:zeros</span>
<span class="w">   </span><span class="nv">:@</span><span class="w"> </span><span class="nv">:dot</span>
<span class="w">   </span><span class="nv">:</span><span class="o">.</span><span class="nb">*</span><span class="w"> </span><span class="nv">:</span><span class="o">.</span><span class="nb">+</span><span class="w"> </span><span class="nv">:</span><span class="o">.</span><span class="nb">-</span><span class="w"> </span><span class="nv">:</span><span class="o">.</span><span class="nb">/</span><span class="w"> </span><span class="nv">:</span><span class="o">.</span><span class="nv">^</span><span class="p">))</span>

<span class="p">(</span><span class="nf">in-package</span><span class="w"> </span><span class="nv">:cl-module/neural</span><span class="p">)</span>
</pre></div>
<p>啊, 本来打算做一个绘图库的, 但是最后实在是太痛苦了, 各种绘图参数什么的,
  实际上还是做了一个绘图库&#8230;</p>
<details><summary>关于绘图库 GURAFU 的一个题外话</summary>
<p>害, 真是不知道该不该佩服我自己的坚持呢&#8230;
  故事的开始是要给 <a href="https://github.com/li-yiyang/cl-corsika">cl-corsika</a> 做一个可视化的程序,
  以及数据分析拟合的东西.</p>
<p>不是说学一个东西, 最简单的方式就是自己上手试试看吗?
  于是我决定从 Common Lisp Modules 这本书里面的 Neural Network 开始,
  然后, 嗯, 嗯&#8230;</p>
<p>我看到了一个 Sigmoid Activation Function 的函数图&#8230;
  然后就想, 啊, 要是我自己可以把这个图画出来的话, 就好了,
  于是我就开始了写 <a href="https://github.com/li-yiyang/gurafu/">GURAFU</a> 这个画图程序&#8230;</p>
<p>于是就拖到了现在&#8230; 啊, 这个函数调用栈的调用和回溯的事件有点长呢&#8230;
  啊, 哈, 哈&#8230;</p>
<p>不过感谢我的友人提供了一个非常好的狡辩借口, 下面允许我进行原文引用:</p>
<blockquote>
  <p>你就说你卡了</p>
  <p>但是你收货了很多</p>
</blockquote>
<p>嗯, 虽然确实收获了很多&#8230; 至少我现在有自信说如果真的要让我从零开始,
  比如说在只有语言的基础上 (或者只有汇编? ), 并且没有 <b>性能考虑</b> 的情况下,
  来实现到目前为止的所有东西&#8230; 应该, 也, 肯定会是个坑爹的不可能的事情&#8230;</p>
<p>我还是太菜了啊&#8230; orz</p>
</details>
<p>虽然我对这个绘图库还算是有点自信&#8230; 但是这个绘图库怎么说都还算是 WIP
  (work in progress&#8230; ), 所以我在写这个的过程中, 也会往 GURAFU
  里面添加需要的函数和功能的&#8230; 所以可能未来你会发现现在这个代码是不能用的,</p>
<p>Good Luck.</p>
<p>不过线性代数部分还是使用了 <a href="https://github.com/quil-lang/magicl">magicl</a>, 但是也不是不能自己写, 虽然感觉可能会很慢,
  比如一个简单的矩阵乘法的例子:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">declaim</span><span class="w"> </span><span class="p">(</span><span class="nf">inline</span><span class="w"> </span><span class="nv">matrix-product</span><span class="p">))</span>
<span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">matrix-product</span><span class="w"> </span><span class="p">(</span><span class="nf">matrix</span><span class="w"> </span><span class="nv">vec</span>
<span class="w">                       </span><span class="nv">&amp;key</span><span class="w"> </span><span class="p">(</span><span class="nf">type</span><span class="w"> </span><span class="ss">&#39;vector</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">product</span><span class="w"> </span><span class="o">#</span><span class="ss">&#39;*</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">sum</span><span class="w"> </span><span class="o">#</span><span class="ss">&#39;+</span><span class="p">))</span>
<span class="w">  </span><span class="s">&quot;Product list `matrix&#39; with list `vec&#39;. &quot;</span>
<span class="w">  </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="nv">type</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="nf">row</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">reduce</span><span class="w"> </span><span class="nv">sum</span><span class="w"> </span><span class="p">(</span><span class="nb">map</span><span class="w"> </span><span class="ss">&#39;list</span><span class="w"> </span><span class="nv">product</span><span class="w"> </span><span class="nv">row</span><span class="w"> </span><span class="nv">vec</span><span class="p">)))</span><span class="w"> </span><span class="nv">matrix</span><span class="p">))</span>
</pre></div>
<details><summary>这里本来应该用一些更加靠谱的矩阵库来做这个事情的&#8230;</summary>
<p>你可以参考:</p>
<ul>
  <li><a href="https://github.com/quil-lang/magicl">magicl</a></li>
  <li><a href="https://github.com/melisgl/mgl-mat">mgl-mat</a></li>
</ul>
<p>但是不知道为什么在我的电脑 (macbook air m1) 上有些问题&#8230;
  虽然可以通过换电脑的方式来解决这个问题, (猜测是缺少对 arm 的支持?
  因为另外一台是 x86), 可以看 <a href="https://github.com/quil-lang/magicl/issues/203">#203 Issue</a>, 目前的解决方法就是使用逃避法&#8230;</p>
<p>不过一个更加让人破防的事情是我在 Github 闲逛的时候,
  看到了一个 <a href="https://github.com/hikettei/cl-waffe2">cl-waffle2</a>, 是一个日本高中生做的 Deeplearning 的库.
  这位大佬还写了一个 <a href="https://github.com/hikettei/cl-metal">cl-metal</a> 的库给苹果的 metal 做绑定&#8230;</p>
<p>真是让人汗流浃背, 果然日本高中生真的像漫画里面一样无所不能啊&#8230;</p>
<p>不过鉴于目前的问题规模还不是很大, 估计可以先用朴素的 list matrix
  来普通的计算:</p>
<ul>
  <li>算一个转动:
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">flet</span><span class="w"> </span><span class="p">((</span><span class="nf">z-rot-mat</span><span class="w"> </span><span class="p">(</span><span class="nf">theta</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nb">cos</span><span class="w"> </span><span class="p">(</span><span class="nb">cos</span><span class="w"> </span><span class="nv">theta</span><span class="p">))</span>
<span class="w">               </span><span class="p">(</span><span class="nb">sin</span><span class="w"> </span><span class="p">(</span><span class="nb">sin</span><span class="w"> </span><span class="nv">theta</span><span class="p">)))</span>
<span class="w">           </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="nb">cos</span><span class="w">     </span><span class="nb">sin</span><span class="p">)</span>
<span class="w">                 </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="nb">sin</span><span class="p">)</span><span class="w"> </span><span class="nb">cos</span><span class="p">))))</span>
<span class="w">       </span><span class="p">(</span><span class="nf">rand-norm</span><span class="w"> </span><span class="p">()</span>
<span class="w">         </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nf">a</span><span class="w"> </span><span class="p">(</span><span class="nb">random</span><span class="w"> </span><span class="mf">1.0</span><span class="p">))</span>
<span class="w">               </span><span class="p">(</span><span class="nf">b</span><span class="w"> </span><span class="p">(</span><span class="nb">random</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)))</span>
<span class="w">           </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">sqrt</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="mi">-2</span><span class="w"> </span><span class="p">(</span><span class="nb">log</span><span class="w"> </span><span class="nv">a</span><span class="p">)))</span><span class="w"> </span><span class="p">(</span><span class="nb">cos</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="nv">pi</span><span class="w"> </span><span class="nv">b</span><span class="p">)))</span>
<span class="w">                 </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="nb">sqrt</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="mi">-2</span><span class="w"> </span><span class="p">(</span><span class="nb">log</span><span class="w"> </span><span class="nv">a</span><span class="p">)))</span><span class="w"> </span><span class="p">(</span><span class="nb">sin</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="nv">pi</span><span class="w"> </span><span class="nv">b</span><span class="p">)))))))</span>
<span class="w">  </span><span class="p">(</span><span class="nf">with-present-to-file</span>
<span class="w">      </span><span class="p">(</span><span class="nf">plot</span><span class="w"> </span><span class="nv">plot</span><span class="w"> </span><span class="nv">:margin</span><span class="w"> </span><span class="mi">20</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nf">out-path</span><span class="w"> </span><span class="nv">:width</span><span class="w"> </span><span class="mi">400</span><span class="w"> </span><span class="nv">:height</span><span class="w"> </span><span class="mi">400</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nf">points</span><span class="w"> </span><span class="p">(</span><span class="nf">loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="nb">count</span><span class="w"> </span><span class="nv">below</span><span class="w"> </span><span class="mi">100</span>
<span class="w">                        </span><span class="nv">for</span><span class="w"> </span><span class="p">(</span><span class="nf">x</span><span class="w"> </span><span class="nv">y</span><span class="p">)</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nf">rand-norm</span><span class="p">)</span><span class="w">                        </span>
<span class="w">                        </span><span class="nv">collect</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="mf">3.0</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)))))</span>
<span class="w">      </span><span class="p">(</span><span class="nf">add-plot-data</span><span class="w"> </span><span class="nv">plot</span>
<span class="w">          </span><span class="p">(</span><span class="nf">scatter-pane</span><span class="w"> </span><span class="nv">origin-cluster</span><span class="w"> </span><span class="nv">:color</span><span class="w"> </span><span class="nv">+鹅黄+</span>
<span class="w">                                       </span><span class="nv">:point-style</span><span class="w"> </span><span class="nv">:circle</span>
<span class="w">                                       </span><span class="nv">:point-size</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span>
<span class="w">        </span><span class="nv">points</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nf">add-plot-data</span><span class="w"> </span><span class="nv">plot</span>
<span class="w">          </span><span class="p">(</span><span class="nf">scatter-pane</span><span class="w"> </span><span class="nv">rotated-60d</span><span class="w"> </span><span class="nv">:color</span><span class="w"> </span><span class="nv">+大红+</span>
<span class="w">                                    </span><span class="nv">:point-style</span><span class="w"> </span><span class="nv">:cross</span>
<span class="w">                                    </span><span class="nv">:point-size</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="nf">loop</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">mat</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nf">z-rot-mat</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="nv">pi</span><span class="w"> </span><span class="mi">3</span><span class="p">))</span>
<span class="w">              </span><span class="nv">for</span><span class="w"> </span><span class="nv">point</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">points</span>
<span class="w">              </span><span class="nv">collect</span><span class="w"> </span><span class="p">(</span><span class="nf">matrix-product</span><span class="w"> </span><span class="nv">mat</span><span class="w"> </span><span class="nv">point</span><span class="w"> </span><span class="nv">:type</span><span class="w"> </span><span class="ss">&#39;list</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nf">add-plot-data</span><span class="w"> </span><span class="nv">plot</span>
<span class="w">          </span><span class="p">(</span><span class="nf">scatter-pane</span><span class="w"> </span><span class="nv">rotated-180d</span><span class="w"> </span><span class="nv">:color</span><span class="w"> </span><span class="nv">+茶褐+</span>
<span class="w">                                     </span><span class="nv">:point-style</span><span class="w"> </span><span class="nv">:square</span>
<span class="w">                                     </span><span class="nv">:point-size</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="nf">loop</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">mat</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nf">z-rot-mat</span><span class="w"> </span><span class="nv">pi</span><span class="p">)</span>
<span class="w">              </span><span class="nv">for</span><span class="w"> </span><span class="nv">point</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">points</span>
<span class="w">              </span><span class="nv">collect</span><span class="w"> </span><span class="p">(</span><span class="nf">matrix-product</span><span class="w"> </span><span class="nv">mat</span><span class="w"> </span><span class="nv">point</span><span class="w"> </span><span class="nv">:type</span><span class="w"> </span><span class="ss">&#39;list</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nf">add-plot-data</span><span class="w"> </span><span class="nv">plot</span>
<span class="w">          </span><span class="p">(</span><span class="nf">scatter-pane</span><span class="w"> </span><span class="nv">origin</span><span class="w"> </span><span class="nv">:color</span><span class="w"> </span><span class="nv">+black+</span>
<span class="w">                               </span><span class="nv">:point-style</span><span class="w"> </span><span class="nv">:+</span>
<span class="w">                               </span><span class="nv">:point-size</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span>
<span class="w">        </span><span class="o">&#39;</span><span class="p">((</span><span class="mf">0.0</span><span class="w"> </span><span class="mf">0.0</span><span class="p">))))))</span>
<span class="nv">out-path</span>
</pre></div>
    <p><img src="/_img/lisp/cl-module/rotate-matrix.png" alt="/_img/lisp/cl-module/rotate-matrix.png" /></p>
  </li>
</ul>
<p>感觉差不多得了&#8230; 之后有时间再思考自己做一个&#8230; 毕竟线代已经寄了.</p>
</details>
</details>
<p><b>Dictionary</b></p>
<p><img src="/_img/lisp/cl-module/neuron-terms.jpg" alt="/_img/lisp/cl-module/neuron-terms.jpg" /></p>
<ul>
  <li><b>neuron</b>: a simple processor which sums the output from one or more
    other neurons, applies some form of transfer function to this sum,
    and outputs this transformed sum to the inputs of other neurons.
    <p>\[\mathrm{SumProducts}_{\mathrm{output}} = &sum;_{\mathrm{input} = 0}^{\mathrm{sizeInput}} \mathrm{Input}_{\mathrm{input}} &times; \mathrm{Weight}_{\mathrm{input}, \mathrm{output}}\]</p>
    <p>貌似是全链接网络的样子&#8230; 虽然这样听起来有点落后于时代了的感觉&#8230;
      但是还是从简单的来开始吧.</p>
  </li>
  <li><b>activation energy</b>: the output of a neuron
    <p>\[\mathrm{Output}_{\mathrm{output}} = \mathrm{Sigmoid}(\mathrm{SumProducts}_{\mathrm{output}})\]</p>
  <details><summary>sigmoid 函数</summary>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">sigmoid</span><span class="w"> </span><span class="p">(</span><span class="nf">x</span><span class="p">)</span>
<span class="w">  </span><span class="s">&quot;The S-shaped curve function, or the logistic function. &quot;</span>
<span class="w">  </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="p">(</span><span class="nb">exp</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="nv">x</span><span class="p">)))))</span>

<span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">d-sigmoid</span><span class="w"> </span><span class="p">(</span><span class="nf">x</span><span class="p">)</span>
<span class="w">  </span><span class="s">&quot;The derivative of sigmoid function. &quot;</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nf">sigmoid</span><span class="w"> </span><span class="p">(</span><span class="nf">sigmoid</span><span class="w"> </span><span class="nv">x</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="nv">sigmoid</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="nv">sigmoid</span><span class="p">))))</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">with-present-to-file</span>
<span class="w">    </span><span class="p">(</span><span class="nf">plot</span><span class="w"> </span><span class="nv">plot</span><span class="w"> </span><span class="nv">:margin</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nf">out-path</span><span class="w">  </span><span class="nv">:width</span><span class="w"> </span><span class="mi">400</span><span class="w"> </span><span class="nv">:height</span><span class="w"> </span><span class="mi">400</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">add-plot-data</span><span class="w"> </span><span class="nv">plot</span>
<span class="w">      </span><span class="p">(</span><span class="nf">line-plot-pane</span><span class="w"> </span><span class="nv">sigmoid</span><span class="w"> </span><span class="nv">:color</span><span class="w"> </span><span class="nv">+莲红+</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nf">loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="mf">-5.0</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="mf">5.0</span><span class="w"> </span><span class="nv">by</span><span class="w"> </span><span class="mf">0.1</span>
<span class="w">          </span><span class="nv">collect</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="p">(</span><span class="nf">sigmoid</span><span class="w"> </span><span class="nv">x</span><span class="p">)))))</span>
<span class="nv">out-path</span>
</pre></div>
    <p><img src="/_img/lisp/cl-module/sigmoid.png" alt="/_img/lisp/cl-module/sigmoid.png" /></p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">with-present-to-file</span>
<span class="w">    </span><span class="p">(</span><span class="nf">plot</span><span class="w"> </span><span class="nv">plot</span><span class="w"> </span><span class="nv">:margin</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="nv">:y-max</span><span class="w"> </span><span class="mf">0.3</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nf">out-path</span><span class="w">  </span><span class="nv">:width</span><span class="w"> </span><span class="mi">400</span><span class="w"> </span><span class="nv">:height</span><span class="w"> </span><span class="mi">400</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">add-plot-data</span><span class="w"> </span><span class="nv">plot</span>
<span class="w">      </span><span class="p">(</span><span class="nf">line-plot-pane</span><span class="w"> </span><span class="nv">sigmoid</span><span class="w"> </span><span class="nv">:color</span><span class="w"> </span><span class="nv">+月白+</span><span class="w"> </span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nf">loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="mf">-5.0</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="mf">5.0</span><span class="w"> </span><span class="nv">by</span><span class="w"> </span><span class="mf">0.1</span>
<span class="w">          </span><span class="nv">collect</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="p">(</span><span class="nf">d-sigmoid</span><span class="w"> </span><span class="nv">x</span><span class="p">)))))</span>
<span class="nv">out-path</span>
</pre></div>
    <p><img src="/_img/lisp/cl-module/d-sigmoid.png" alt="/_img/lisp/cl-module/d-sigmoid.png" /></p>
  </details>
  </li>
  <li><b>connection weight</b>, <b>weights</b>, <b>connections</b>: numeric quantity which
    determines how much of a neuron's output value reaches the input
    to the next neuron to which it is connected.
    <p>a connection weight is is defined by a source neuron, a target
      neuron, and a numeric weighting factor.</p>
  </li>
  <li><b>layer</b> of neuron, <b>slabs</b>: a set of logically grouped neurons</li>
  <li><b>hidden layer</b>: having no direct connections to neural network
    input or output signals</li>
</ul>
<p><b>Simple Delta Rule Neural Network Simulator</b></p>
<p>这是一个只有输入和输出的模型, 没有隐藏层. (2-Layer, No hidden layer)</p>
<details><summary> 一些接口 </summary>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defgeneric</span><span class="w"> </span><span class="nv">network-size</span><span class="w"> </span><span class="p">(</span><span class="nf">network</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">:documentation</span>
<span class="w">   </span><span class="s">&quot;Return a list represent the `network&#39; size.</span>

<span class="s">The returned list like below:</span>
<span class="s">  (input-size ... hidden-layer-size ... output-size)</span>
<span class="s">&quot;</span><span class="p">))</span>

<span class="p">(</span><span class="nf">defgeneric</span><span class="w"> </span><span class="nv">output</span><span class="w"> </span><span class="p">(</span><span class="nf">network</span><span class="w"> </span><span class="nv">input</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">:documentation</span>
<span class="w">   </span><span class="s">&quot;Return the output of `input&#39; for `network&#39;. &quot;</span><span class="p">))</span>

<span class="p">(</span><span class="nf">defgeneric</span><span class="w"> </span><span class="nv">train-on</span><span class="w"> </span><span class="p">(</span><span class="nf">network</span><span class="w"> </span><span class="nv">input</span><span class="w"> </span><span class="nv">target</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">:documentation</span>
<span class="w">   </span><span class="s">&quot;Train on specific `input&#39; and `target&#39; for `network&#39;. &quot;</span><span class="p">))</span>
</pre></div>
</details>
<ul>
  <li>首先是数据的表示 (注: 原文这里用的是 <code>list</code> 做数据结构,
    并且是对应数组为数据格式, 这里把原本的 <code>list</code> 改成了更加直观的 oop,
    不过还是会尽量保留原文的代码的逻辑, 虽然还是会加入我自己的随机魔改的代码. )
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defparameter</span><span class="w"> </span><span class="nv">*default-learning-rate*</span><span class="w"> </span><span class="mf">0.6</span>
<span class="w">  </span><span class="s">&quot;The default learning rate. &quot;</span><span class="p">)</span>

<span class="p">(</span><span class="nf">defparameter</span><span class="w"> </span><span class="nv">*default-intern-type*</span><span class="w"> </span><span class="ss">&#39;single-float</span>
<span class="w">  </span><span class="s">&quot;The default interner type used for network. &quot;</span><span class="p">)</span>

<span class="p">(</span><span class="nf">defclass</span><span class="w"> </span><span class="nv">layer</span><span class="w"> </span><span class="p">()</span>
<span class="w">  </span><span class="p">((</span><span class="nf">inputs</span><span class="w">  </span><span class="nv">:initarg</span><span class="w"> </span><span class="nv">:inputs</span><span class="p">)</span>
<span class="w">   </span><span class="p">(</span><span class="nf">outputs</span><span class="w"> </span><span class="nv">:initarg</span><span class="w"> </span><span class="nv">:outputs</span><span class="p">)</span>
<span class="w">   </span><span class="p">(</span><span class="nf">weights</span><span class="w"> </span><span class="nv">:accessor</span><span class="w"> </span><span class="nv">weights</span><span class="p">)</span>
<span class="w">   </span><span class="p">(</span><span class="nf">active-function</span><span class="w">   </span><span class="nv">:initform</span><span class="w"> </span><span class="o">#</span><span class="ss">&#39;sigmoid</span>
<span class="w">                      </span><span class="nv">:initarg</span><span class="w"> </span><span class="nv">:active-function</span><span class="p">)</span>
<span class="w">   </span><span class="p">(</span><span class="nf">d-active-function</span><span class="w"> </span><span class="nv">:initform</span><span class="w"> </span><span class="o">#</span><span class="ss">&#39;d-sigmoid</span>
<span class="w">                      </span><span class="nv">:initarg</span><span class="w"> </span><span class="nv">:d-active-function</span><span class="p">)</span>
<span class="w">   </span><span class="p">(</span><span class="nf">learning-rate</span><span class="w">     </span><span class="nv">:initform</span><span class="w"> </span><span class="nv">*default-learning-rate*</span>
<span class="w">                      </span><span class="nv">:initarg</span><span class="w"> </span><span class="nv">:learning-rate</span><span class="p">)</span>
<span class="w">   </span><span class="p">(</span><span class="nf">intern-type</span><span class="w">       </span><span class="nv">:initform</span><span class="w"> </span><span class="nv">*default-intern-type*</span>
<span class="w">                      </span><span class="nv">:initarg</span><span class="w"> </span><span class="nv">:intern-type</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="nf">:documentation</span>
<span class="w">   </span><span class="s">&quot;The class representing a network layer.&quot;</span><span class="p">))</span>

<span class="p">(</span><span class="nf">defmethod</span><span class="w"> </span><span class="nv">initialize-instance</span><span class="w"> </span><span class="nv">:after</span><span class="w"> </span><span class="p">((</span><span class="nf">layer</span><span class="w"> </span><span class="nv">layer</span><span class="p">)</span><span class="w"> </span><span class="nv">&amp;key</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">with-slots</span><span class="w"> </span><span class="p">(</span><span class="nf">inputs</span><span class="w"> </span><span class="nv">outputs</span><span class="w"> </span><span class="nv">weights</span><span class="w"> </span><span class="nv">intern-type</span><span class="p">)</span><span class="w"> </span><span class="nv">layer</span>
<span class="w">    </span><span class="c1">;; init weights with random noises</span>
<span class="w">    </span><span class="p">(</span><span class="nf">setf</span><span class="w"> </span><span class="nv">weights</span><span class="w"> </span><span class="p">(</span><span class="nf">rand</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="nv">outputs</span><span class="w"> </span><span class="nv">inputs</span><span class="p">)</span><span class="w"> </span><span class="nv">:type</span><span class="w"> </span><span class="nv">intern-type</span><span class="p">))))</span>

<span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">make-layer</span><span class="w"> </span><span class="p">(</span><span class="nf">input</span><span class="w"> </span><span class="nv">output</span>
<span class="w">                   </span><span class="nv">&amp;key</span><span class="w"> </span><span class="p">(</span><span class="nf">learning-rate</span><span class="w"> </span><span class="mf">0.6</span><span class="p">)</span>
<span class="w">                     </span><span class="p">(</span><span class="nf">intern-type</span><span class="w"> </span><span class="ss">&#39;single-float</span><span class="p">))</span>
<span class="w">  </span><span class="s">&quot;Make a layer with `input&#39; inputs and `output&#39; outputs. &quot;</span>
<span class="w">  </span><span class="p">(</span><span class="nf">make-instance</span><span class="w"> </span><span class="ss">&#39;layer</span><span class="w"> </span><span class="nv">:inputs</span><span class="w"> </span><span class="nv">input</span><span class="w"> </span><span class="nv">:outputs</span><span class="w"> </span><span class="nv">output</span>
<span class="w">                        </span><span class="nv">:learning-rate</span><span class="w"> </span><span class="nv">learning-rate</span>
<span class="w">                        </span><span class="nv">:intern-type</span><span class="w">   </span><span class="nv">intern-type</span><span class="p">))</span>
</pre></div>
  </li>
  <li>将输入带入模型, 计算输出
    <p>\[\mathrm{SumProducts}_{\mathrm{outputs}}
      = &sum;_{\mathrm{inputs} = 0}^{\mathrm{sizeInput}} \mathrm{Input}_{\mathrm{inputs}} *
      \mathrm{Weight}_{\mathrm{inputs}, \mathrm{outputs}}\]</p>
    <p>可以发现基本上为一个矩阵乘法:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defmethod</span><span class="w"> </span><span class="nv">sum-products</span><span class="w"> </span><span class="p">((</span><span class="nf">layer</span><span class="w"> </span><span class="nv">layer</span><span class="p">)</span><span class="w"> </span><span class="nv">input</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">@</span><span class="w"> </span><span class="p">(</span><span class="nf">slot-value</span><span class="w"> </span><span class="nv">layer</span><span class="w"> </span><span class="ss">&#39;weights</span><span class="p">)</span><span class="w"> </span><span class="nv">input</span><span class="p">))</span>
</pre></div>
    <p>为了方便, 这里把 <code>input</code> 直接作为一个 <code>(list INPUTS)</code> 形状的矩阵 (一维向量).</p>
    <p>对于最终的输出:</p>
    <p>\[\mathrm{Output}_{\mathrm{outputs}} = \mathrm{Sigmoid}(\mathrm{SumProducts}_{\mathrm{outputs}})\]</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defmethod</span><span class="w"> </span><span class="nv">output</span><span class="w"> </span><span class="p">((</span><span class="nf">layer</span><span class="w"> </span><span class="nv">layer</span><span class="p">)</span><span class="w"> </span><span class="nv">input</span><span class="p">)</span><span class="w">  </span>
<span class="w">  </span><span class="p">(</span><span class="nb">map!</span><span class="w"> </span><span class="o">#</span><span class="ss">&#39;sigmoid</span><span class="w"> </span><span class="p">(</span><span class="nf">sum-products</span><span class="w"> </span><span class="nv">layer</span><span class="w"> </span><span class="nv">input</span><span class="p">)))</span>
</pre></div>
  </li>
  <li>训练
    <p>对于输出的 <code>output</code>, 其和 <code>target</code> 所对应的值所差的 <code>error</code>:</p>
    <p>\[\mathrm{Error}_{\mathrm{outputs}} =
      (\mathrm{Target}_{\mathrm{outputs}} - \mathrm{Output}_{\mathrm{outputs}}) *
      \mathrm{Sigmoid}^P(\mathrm{SumProducts}_{\mathrm{outputs}})\]</p>
    <p>(大概如上的感觉.)</p>
    <p>从误差中可以学得的:</p>
    <p>\[\mathrm{DeltaWeight}_{\mathrm{inputs}, \mathrm{outputs}} =
      \mathrm{LearningRate} * \mathrm{Error}_{\mathrm{outputs}} * \mathrm{Output}_{\mathrm{outputs}}\]</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defmethod</span><span class="w"> </span><span class="nv">train-on</span><span class="w"> </span><span class="p">((</span><span class="nf">layer</span><span class="w"> </span><span class="nv">layer</span><span class="p">)</span><span class="w"> </span><span class="nv">input</span><span class="w"> </span><span class="nv">target</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">with-slots</span><span class="w"> </span><span class="p">(</span><span class="nf">inputs</span><span class="w"> </span><span class="nv">outputs</span><span class="w"> </span><span class="nv">intern-type</span>
<span class="w">               </span><span class="nv">active-function</span><span class="w"> </span><span class="nv">weights</span><span class="w"> </span><span class="nv">learning-rate</span><span class="p">)</span>
<span class="w">      </span><span class="nv">layer</span>
<span class="w">    </span><span class="p">(</span><span class="k">let*</span><span class="w"> </span><span class="p">((</span><span class="nf">magicl::*default-tensor-type*</span><span class="w"> </span><span class="nv">intern-type</span><span class="p">)</span>
<span class="w">           </span><span class="p">(</span><span class="nf">noised</span><span class="w"> </span><span class="p">(</span><span class="o">.</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nf">rand</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="nv">inputs</span><span class="p">))</span><span class="w"> </span><span class="nv">input</span><span class="p">))</span>
<span class="w">           </span><span class="p">(</span><span class="nf">output</span><span class="w"> </span><span class="p">(</span><span class="nf">output</span><span class="w"> </span><span class="nv">layer</span><span class="w"> </span><span class="nv">noised</span><span class="p">))</span><span class="w">           </span>
<span class="w">           </span><span class="p">(</span><span class="nf">errors</span><span class="w"> </span><span class="p">(</span><span class="o">.</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="o">.</span><span class="nb">-</span><span class="w"> </span><span class="nv">target</span><span class="w"> </span><span class="nv">output</span><span class="p">)</span>
<span class="w">                       </span><span class="p">(</span><span class="nb">map!</span><span class="w"> </span><span class="nv">active-function</span><span class="w"> </span><span class="p">(</span><span class="k">@</span><span class="w"> </span><span class="nv">weights</span><span class="w"> </span><span class="nv">input</span><span class="p">))))</span>
<span class="w">           </span><span class="p">(</span><span class="nf">delta-weights</span><span class="w"> </span><span class="p">(</span><span class="o">.</span><span class="nb">*</span><span class="w"> </span><span class="nv">learning-rate</span>
<span class="w">                              </span><span class="p">(</span><span class="k">@</span><span class="w"> </span><span class="p">(</span><span class="nf">reshape</span><span class="w"> </span><span class="nv">errors</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="nv">outputs</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<span class="w">                                 </span><span class="p">(</span><span class="nf">reshape</span><span class="w"> </span><span class="nv">noised</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nv">inputs</span><span class="p">))))))</span><span class="w">      </span>
<span class="w">      </span><span class="p">(</span><span class="nb">values</span><span class="w"> </span><span class="p">(</span><span class="nf">norm</span><span class="w"> </span><span class="nv">errors</span><span class="p">)</span><span class="w"> </span><span class="nv">delta-weights</span><span class="p">))))</span>

<span class="p">(</span><span class="nf">defmethod</span><span class="w"> </span><span class="nv">train</span><span class="w"> </span><span class="p">((</span><span class="nf">layer</span><span class="w"> </span><span class="nv">layer</span><span class="p">)</span><span class="w"> </span><span class="nv">training-data</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; return a value for the average error signal at each output neuron</span>
<span class="w">  </span><span class="p">(</span><span class="nf">with-slots</span><span class="w"> </span><span class="p">(</span><span class="nf">inputs</span><span class="w"> </span><span class="nv">outputs</span><span class="w"> </span><span class="nv">weights</span>
<span class="w">               </span><span class="nv">intern-type</span><span class="p">)</span>
<span class="w">      </span><span class="nv">layer</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nf">magicl::*default-tensor-type*</span><span class="w"> </span><span class="nv">intern-type</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="nf">loop</span><span class="w"> </span><span class="nv">with</span><span class="w"> </span><span class="nv">rms-error</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">            </span><span class="nv">with</span><span class="w"> </span><span class="nv">delta-weights</span><span class="w"> </span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="nf">zeros</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="nv">outputs</span><span class="w"> </span><span class="nv">inputs</span><span class="p">))</span>
<span class="w">            </span><span class="nv">for</span><span class="w"> </span><span class="p">(</span><span class="nf">input</span><span class="w"> </span><span class="nv">target</span><span class="p">)</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">training-data</span>
<span class="w">            </span><span class="k">do</span><span class="w"> </span><span class="p">(</span><span class="nf">multiple-value-bind</span><span class="w"> </span><span class="p">(</span><span class="nf">err</span><span class="w"> </span><span class="nv">delta-w</span><span class="p">)</span>
<span class="w">                   </span><span class="p">(</span><span class="nf">train-on</span><span class="w"> </span><span class="nv">layer</span><span class="w"> </span><span class="nv">input</span><span class="w"> </span><span class="nv">target</span><span class="p">)</span>
<span class="w">                 </span><span class="p">(</span><span class="nf">incf</span><span class="w"> </span><span class="nv">rms-error</span><span class="w"> </span><span class="nv">err</span><span class="p">)</span>
<span class="w">                 </span><span class="p">(</span><span class="nf">setf</span><span class="w"> </span><span class="nv">delta-weights</span><span class="w"> </span><span class="p">(</span><span class="o">.</span><span class="nb">+</span><span class="w"> </span><span class="nv">delta-weights</span><span class="w"> </span><span class="nv">delta-w</span><span class="p">)))</span>
<span class="w">            </span><span class="nv">finally</span><span class="w"> </span><span class="p">(</span><span class="nf">progn</span>
<span class="w">                      </span><span class="p">(</span><span class="nf">setf</span><span class="w"> </span><span class="nv">weights</span><span class="w"> </span><span class="p">(</span><span class="o">.</span><span class="nb">+</span><span class="w"> </span><span class="nv">weights</span><span class="w"> </span><span class="nv">delta-weights</span><span class="p">))</span>
<span class="w">                      </span><span class="p">(</span><span class="nf">return</span><span class="w"> </span><span class="p">(</span><span class="nb">values</span><span class="w"> </span><span class="nv">rms-error</span><span class="w"> </span><span class="nv">delta-weights</span><span class="p">)))))))</span>
</pre></div>
  </li>
</ul>
<p>呃, 感觉不就是线性拟合么&#8230; 并且代码还不是很直观&#8230;
  对最终结果的可靠性表示怀疑&#8230;</p>
<p>但是单从误差上来看, 确实发生了误差的减少&#8230;</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="k">let*</span><span class="w"> </span><span class="p">((</span><span class="nf">layer</span><span class="w"> </span><span class="p">(</span><span class="nf">make-layer</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span>
<span class="w">       </span><span class="p">(</span><span class="nf">data</span><span class="w"> </span><span class="p">(</span><span class="nf">loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="p">(</span><span class="nf">in</span><span class="w"> </span><span class="nv">tar</span><span class="p">)</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(((</span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<span class="w">                                     </span><span class="p">((</span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="p">)))</span>
<span class="w">                   </span><span class="nv">collect</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="p">(</span><span class="nf">from-list</span><span class="w"> </span><span class="nv">in</span><span class="w">  </span><span class="o">&#39;</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="nv">:type</span><span class="w"> </span><span class="ss">&#39;single-float</span><span class="p">)</span>
<span class="w">                                 </span><span class="p">(</span><span class="nf">from-list</span><span class="w"> </span><span class="nv">tar</span><span class="w"> </span><span class="o">&#39;</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="nv">:type</span><span class="w"> </span><span class="ss">&#39;single-float</span><span class="p">))))</span>
<span class="w">       </span><span class="p">(</span><span class="nf">rms</span><span class="w"> </span><span class="p">(</span><span class="nf">loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="nv">below</span><span class="w"> </span><span class="mi">100</span>
<span class="w">                  </span><span class="nv">collect</span><span class="w"> </span><span class="p">(</span><span class="nb">list</span><span class="w"> </span><span class="nv">i</span><span class="w"> </span><span class="p">(</span><span class="nf">train</span><span class="w"> </span><span class="nv">layer</span><span class="w"> </span><span class="nv">data</span><span class="p">)))))</span>
<span class="w">  </span><span class="p">(</span><span class="nf">with-present-to-file</span>
<span class="w">      </span><span class="p">(</span><span class="nf">plot</span><span class="w"> </span><span class="nv">plot</span><span class="w"> </span><span class="nv">:margin</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="nv">:y-max</span><span class="w"> </span><span class="mf">0.4</span><span class="w"> </span><span class="nv">:y-min</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="nv">:x-min</span><span class="w"> </span><span class="mi">0</span>
<span class="w">                 </span><span class="nv">:x-label</span><span class="w"> </span><span class="s">&quot;iter&quot;</span><span class="w"> </span><span class="nv">:y-label</span><span class="w"> </span><span class="s">&quot;RMS Error&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nf">out-path</span><span class="w"> </span><span class="nv">:width</span><span class="w"> </span><span class="mi">600</span><span class="w"> </span><span class="nv">:height</span><span class="w"> </span><span class="mi">400</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nf">add-plot-data</span><span class="w"> </span><span class="nv">plot</span>
<span class="w">        </span><span class="p">(</span><span class="nf">line-plot-pane</span><span class="w"> </span><span class="nv">rms-error</span><span class="w"> </span><span class="nv">:color</span><span class="w"> </span><span class="nv">+大红官绿+</span><span class="p">)</span>
<span class="w">      </span><span class="nv">rms</span><span class="p">)))</span>
<span class="nv">out-path</span>
</pre></div>
<p><img src="/_img/lisp/cl-module/1-layer-delta-demo-rms.png" alt="/_img/lisp/cl-module/1-layer-delta-demo-rms.png" /></p>
<p><b>A Complete Delta Rule Neural Network Simulator</b></p>
<p>只有单层的网络可以说根本没有什么用啊&#8230; kora&#8230;</p>
<p>这里会借用书中的接口定义来经行设置:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defclass</span><span class="w"> </span><span class="nv">network</span><span class="w"> </span><span class="p">()</span>
<span class="w">  </span><span class="p">((</span><span class="nf">inner-layers</span><span class="w"> </span><span class="nv">:initform</span><span class="w"> </span><span class="p">())</span><span class="w">   </span>
<span class="w">   </span><span class="p">(</span><span class="nf">layer-sizes</span><span class="w">  </span><span class="nv">:initform</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="nv">:initargs</span><span class="w"> </span><span class="nv">:layer-sizes</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="nf">:documentation</span>
<span class="w">   </span><span class="s">&quot;The network is a collection of layers, connected in sequence. &quot;</span><span class="p">))</span>

<span class="p">(</span><span class="nf">defmethod</span><span class="w"> </span><span class="nv">initialize-instance</span><span class="w"> </span><span class="nv">:after</span>
<span class="w">    </span><span class="p">((</span><span class="nf">network</span><span class="w"> </span><span class="nv">network</span><span class="p">)</span><span class="w"> </span><span class="nv">&amp;key</span><span class="w"> </span><span class="nv">layer-sizes</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">setf</span><span class="w"> </span><span class="p">(</span><span class="nf">slot-value</span><span class="w"> </span><span class="nv">network</span><span class="w"> </span><span class="ss">&#39;inner-layers</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="nf">loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="p">(</span><span class="nf">in</span><span class="w"> </span><span class="nv">out</span><span class="p">)</span><span class="w"> </span><span class="nv">on</span><span class="w"> </span><span class="nv">layer-sizes</span><span class="w"> </span><span class="nv">by</span><span class="w"> </span><span class="o">#</span><span class="ss">&#39;cddr</span>
<span class="w">              </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">out</span><span class="p">)</span>
<span class="w">              </span><span class="nv">collect</span><span class="w"> </span><span class="p">(</span><span class="nf">make-layer</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">out</span><span class="p">))))</span>

<span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">make-network</span><span class="w"> </span><span class="p">(</span><span class="nf">top-slab</span><span class="w"> </span><span class="nv">second-slab</span><span class="w"> </span><span class="nv">&amp;optional</span><span class="w"> </span><span class="nv">more-layers</span><span class="p">)</span>
<span class="w">  </span><span class="s">&quot;Make a network with each slab size, at least two slab size should be given.&quot;</span>
<span class="w">  </span><span class="p">(</span><span class="nf">make-instance</span><span class="w"> </span><span class="ss">&#39;network</span>
<span class="w">                 </span><span class="nv">:layer-sizes</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="nv">top-slab</span><span class="w"> </span><span class="p">(</span><span class="nb">cons</span><span class="w"> </span><span class="nv">second-slab</span><span class="w"> </span><span class="nv">more-layers</span><span class="p">))))</span>
</pre></div>
<ul>
  <li>训练
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defmethod</span><span class="w"> </span><span class="nv">train</span><span class="w"> </span><span class="p">((</span><span class="nf">network</span><span class="w"> </span><span class="nv">network</span><span class="p">)</span><span class="w"> </span><span class="nv">training-data</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nf">with-slots</span><span class="w"> </span><span class="p">(</span><span class="nf">inner-layers</span><span class="p">)</span><span class="w"> </span><span class="nv">network</span>
<span class="w">    </span><span class="p">(</span><span class="nf">loop</span>
<span class="w">      </span><span class="nv">for</span><span class="w"> </span><span class="p">(</span><span class="nf">input</span><span class="w"> </span><span class="nv">target</span><span class="p">)</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">training-data</span>
<span class="w">      </span><span class="p">)))</span>
</pre></div>
  </li>
</ul>
<p>(嗯, 貌似当时看到这里就期中考了&#8230; 结果被一对快慢刀给干到了现在&#8230;
  不过现在回过头来看这个, 感觉有点怪, 一般神经网络不应该是 \(\boldsymbol{A} \boldsymbol{x} + \boldsymbol{b} = \boldsymbol{y}\)
  这样的形式么? 这里的偏置项 \(\boldsymbol{b}\) 好像完全没有啊&#8230; 真是奇怪.
  不过也有可能是对输入项进行强制括项, 将其变成原本输入的 \(n + 1\) 维,
  最后一维放一个常数来作为偏置. )</p>
<p><b>后记</b></p>
<p>Lisp 的语法被 diss, 被抛弃不是没有理由的, 在没有编辑器的辅助,
  没有好的缩进习惯的情况下, 从纸面上去阅读 Lisp 代码简直就是折磨&#8230;
  早期是这样的没错, 毕竟没有 Github, <del>商业上主要是被大公司 Symbolics 之类的垄断</del>,</p>
<p>(注: 垄断的说法不合理, 实际上是 LMI, Symbolics, MIT AI Lab 三个为主要,
  但是里面不仅有版权纠纷, 还有利益冲突, 只能说是各种因素导致的失败,
  还是非常可惜的. 可以参考一个还算客观的回顾? <a href="https://danluu.com/symbolics-lisp-machines/">History of Symbolics lisp machines</a>)</p>
<p>学术上主要是大学的一些论文.</p>
<p>(注: 其实 Lisp 应该算是作为原型设计来说非常方便的,
  但是现在原型设计应该还是通过调库来实现会更加方便,
  像以前的那种一个实验室维护一套代码的情况应该非常少见了.
  尽管现在随着 quicklisp 这样的分发工具的普及, 调库对于 Lisp 来说绝对不是难事,
  更何况 Lisp 有 CFFI, 可以非常轻松地去调用 C 的库来解决自己的问题. )</p>
<p>不过感觉现在的传播条件和编辑条件上来了, 对于 Lisp 应该会更加容易使用来说才是.</p>
<p>并且感觉这本书里面的代码真的不能说是 &#8220;易于阅读&#8221; 的&#8230;
  感觉完全就是在用命令式的 C 来写 Lisp, 根本没有用宏, 也没有函数包装.</p>
<p>不过里面的代码里面有一个让我觉得可以学习的点就是里面用变量进行设参.
  之前写代码都是用 <code>&amp;optional</code> 和 <code>&amp;key</code> 进行传参, 结果就是把函数参数变得超长,
  这样就很难受.</p>
<p>如下的例子:</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nf">defvar</span><span class="w"> </span><span class="nv">*closure-variable*</span><span class="p">)</span>

<span class="p">(</span><span class="nf">defun</span><span class="w"> </span><span class="nv">this-is-a-function</span><span class="w"> </span><span class="p">()</span>
<span class="w">  </span><span class="p">(</span><span class="nf">do-some-thing-with</span><span class="w"> </span><span class="nv">*closure-variable*</span><span class="p">))</span>

<span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nf">*closure-variable*</span><span class="w"> </span><span class="nv">updated-local-closure-value</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="nf">this-is-a-function</span><span class="p">))</span>
</pre></div>
<p>这样就可以在函数调用链里面一直把参数传下去用, 非常方便呢.</p>
<p>不过接下去有点想先去读读看 <a href="https://letoverlambda.com">Let Over Lambda</a> 而不是继续看这本书了,
  因为感觉自己现在写 LISP 缺少一些花活和技术,
  或者说缺少对大型项目和底层的抽象能力.</p>
</details>

  </div><a class="u-url" href="/lisp/tic-tac-toe-ai/" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">My Blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">My Blog</li><li><a class="u-email" href="mailto:thebigbigwordl@qq.com">thebigbigwordl@qq.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/li-yiyang"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">li-yiyang</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>某不知名的很硬的双非学校的物理系学生的无聊博客</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
